<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApoioBPO - Sistema de Apoio BPO</title>
    <link rel="icon" type="image/png" href="./images/icone_meta.png" onerror="this.style.display='none'">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Adicionada a biblioteca de gráficos Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Carregando os arquivos de dados externos -->
    <script src="data/pareceres.js" defer></script>
    <script src="data/regras.js" defer></script>
    <script src="data/checklists.js" defer></script>


    <style type="text/tailwindcss">
        :root {
            --color-bg: #e0e5ec;
            --color-text: #5a6474;
            --color-shadow-1: #ffffff;
            --color-shadow-2: #a3b1c6;
            --color-accent: #0ea5e9;
            --color-subtle: #9ca3af;
            --scrollbar-thumb: #a3b1c6;
            --scrollbar-thumb-hover: #5a6474;
        }

        html.dark {
            --color-bg: #1f2937;
            --color-text: #d1d9e6;
            --color-shadow-1: #374151;
            --color-shadow-2: #111827;
            --color-accent: #38bdf8;
            --color-subtle: #6b7280;
            --scrollbar-thumb: #5a6474;
            --scrollbar-thumb-hover: #9ca3af;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.35s cubic-bezier(0.4, 0, 0.2, 1), color 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
        }

        .neumorphic-outset { box-shadow: 6px 6px 12px var(--color-shadow-2), -6px -6px 12px var(--color-shadow-1); }
        .neumorphic-inset { box-shadow: inset 6px 6px 12px var(--color-shadow-2), inset -6px -6px 12px var(--color-shadow-1); }
        .neumorphic-outset-sm { box-shadow: 3px 3px 6px var(--color-shadow-2), -3px -3px 6px var(--color-shadow-1); }
        
        .text-accent { color: var(--color-accent); }
        .text-subtle { color: var(--color-subtle); }

        ::placeholder { color: #9ca3af; }
        .dark ::placeholder { color: #6b7280; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px;}
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 20px; border: 2px solid var(--color-bg); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: var(--scrollbar-thumb-hover); }

        
        .toggle-container {
            position: relative;
            width: 3.5rem;
            height: 1.75rem;
        }
        .toggle-label {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 9999px;
            box-shadow: inset 2px 2px 5px var(--color-shadow-2), inset -2px -2px 5px var(--color-shadow-1);
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .toggle-checkbox {
            appearance: none;
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            background-color: var(--color-bg);
            box-shadow: 2px 2px 4px var(--color-shadow-2), -2px -2px 4px var(--color-shadow-1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .toggle-checkbox:checked {
            transform: translateX(1.75rem);
            background-color: var(--color-accent);
        }


        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        @keyframes fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .animate-fade-out { animation: fade-out 0.3s ease-in forwards; }
        
        input, select { background-color: transparent !important; color: var(--color-text); }
        select option { background: var(--color-bg); color: var(--color-text); }

        #dock-slider { transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); position: absolute; left: 0; margin-left: 0 !important; margin-right: 0 !important; }

        .custom-checkbox { width: 22px; height: 22px; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: all 0.2s ease-in-out; cursor: pointer; }
        .custom-checkbox .check-icon { opacity: 0; transform: scale(0.5); transition: all 0.2s ease-in-out; color: var(--color-accent); }
        .checklist-item-checkbox:checked + .custom-checkbox { box-shadow: inset 3px 3px 6px var(--color-shadow-2), inset -3px -3px 6px var(--color-shadow-1); }
        .checklist-item-checkbox:checked + .custom-checkbox .check-icon { opacity: 1; transform: scale(1); }
        .checklist-list-item:has(.checklist-item-checkbox:checked) { background-color: rgba(0,0,0,0.02); }
        html.dark .checklist-list-item:has(.checklist-item-checkbox:checked) { background-color: rgba(255,255,255,0.02); }
        
        .pagination-dot { width: 10px; height: 10px; border-radius: 50%; transition: all 0.3s ease; background-color: var(--color-text); opacity: 0.3; }
        .pagination-dot.active { opacity: 1; transform: scale(1.2); background-color: var(--color-accent); }
        
        @keyframes image-fade-in { from { opacity: 0.4; } to { opacity: 1; } }
        .image-viewer-content-wrapper { animation: image-fade-in 0.5s ease-in-out; }
        
        #terms-modal.hidden, #info-modal.hidden, #image-viewer-modal.hidden { display: none; }
        #main-content.blurred { filter: blur(5px) saturate(0.9); transform: scale(0.98); pointer-events: none; user-select: none; transition: all 0.3s ease-out; }
        
        #accept-terms-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
        #timer-toggle:checked + .toggle-label {
            background-color: rgba(56, 189, 248, 0.1);
            box-shadow:
                0 0 5px var(--color-accent),
                0 0 10px var(--color-accent),
                0 0 20px var(--color-accent),
                inset 2px 2px 5px var(--color-shadow-2),
                inset -2px -2px 5px var(--color-shadow-1);
        }
        
        #image-viewer-content {
            transition: transform 0.2s ease-out;
            cursor: grab;
        }
        #image-viewer-content.dragging {
            cursor: grabbing;
        }
        
        .history-filter-btn.active {
             box-shadow: inset 3px 3px 6px var(--color-shadow-2), inset -3px -3px 6px var(--color-shadow-1);
             color: var(--color-accent);
        }
        
        .star-btn .star-icon { transition: all 0.2s ease-in-out; }
        .star-btn.active .star-icon {
            fill: #facc15;
            color: #facc15;
        }
        
        /* Estilo para o input de data para mostrar o ícone do calendário */
        input[type="date"]::-webkit-calendar-picker-indicator {
            cursor: pointer;
            filter: var(--color-text) invert(0.5) brightness(1.2);
        }
        html.dark input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* EFEITO DE LUZ AO COPIAR - SUAVIZADO */
        @keyframes green-light-glow {
            0% {
                box-shadow: 3px 3px 6px var(--color-shadow-2), -3px -3px 6px var(--color-shadow-1);
            }
            40% {
                box-shadow: 3px 3px 6px var(--color-shadow-2), -3px -3px 6px var(--color-shadow-1),
                            /* Brilho interno (menor e mais suave) */
                            0 0 7px 1px rgba(16, 185, 129, 0.85), 
                            /* Brilho externo (menor e mais suave) */
                            0 0 22px 8px rgba(16, 185, 129, 0.5);
            }
            100% {
                box-shadow: 3px 3px 6px var(--color-shadow-2), -3px -3px 6px var(--color-shadow-1);
            }
        }

        .copy-success-glow {
            /* Animação mais lenta */
            animation: green-light-glow 1.5s ease-out;
        }

    </style>
</head>

<body>
    <!-- MODAL DE TERMOS DE USO -->
<div id="terms-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div class="absolute inset-0 bg-[var(--color-bg)] opacity-90"></div>
    <div class="relative w-full max-w-2xl p-6 sm:p-8 rounded-2xl neumorphic-outset animate-fade-in">
        <h2 class="text-2xl font-bold mb-2 text-accent">Termos e Condições de Uso — ApoioBPO</h2>
        <p class="text-xs text-subtle mb-4">Versão 1.6.0 — Agosto de 2025</p>

        <div class="max-h-[60vh] overflow-y-auto custom-scrollbar pr-4 text-sm space-y-4">
            <p>Bem-vindo ao ApoioBPO. Antes de utilizar o sistema, leia atentamente estes termos. Ao clicar em “Aceitar e Continuar”, você declara estar de acordo com as condições estabelecidas.</p>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">1. Propriedade Intelectual</h3>
                <p class="text-subtle">Este sistema foi desenvolvido por <strong>Wellington Juan Dutra Oliveira</strong>, com colaboração de:</p>
                <ul class="list-disc list-inside pl-4 text-subtle">
                    <li>Gabriel Artur Lopes Feltes</li>
                    <li>Mauricio Gabriel Freiberger Konig</li>
                    <li>Erika Mendonça Figueira</li>
                    <li>Bruno Corrêa Alves</li>
                </ul>
                <p class="text-subtle mt-2">Todos os direitos sobre o sistema, incluindo código-fonte, design, funcionalidades e lógica, são reservados ao autor.</p>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">2. Finalidade de Uso</h3>
                <p class="text-subtle">O ApoioBPO destina-se exclusivamente ao uso interno e profissional da equipe da Meta Serviços em Informática S.A., no âmbito dos serviços de BPO prestados ao Banco Cooperativo Sicoob S.A.</p>
                <p class="text-subtle mt-2">Principais funcionalidades:</p>
                <ul class="list-disc list-inside pl-4 text-subtle">
                    <li>Cálculo de renda para pessoas físicas (PF) e jurídicas (PJ);</li>
                    <li>Análise de atividades agropecuárias;</li>
                    <li>Verificação automatizada de CNPJ;</li>
                    <li>Checklist documental;</li>
                    <li>Registro e contagem de atividades por hora;</li>
                    <li>Consulta de pareceres técnicos e regras de operação.</li>
                </ul>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">3. Restrições de Uso</h3>
                <p class="text-subtle">É estritamente proibido:</p>
                <ul class="list-disc list-inside pl-4 text-subtle">
                    <li>Utilizar o sistema fora do ambiente corporativo e horário comercial;</li>
                    <li>Compartilhar acesso com pessoas não autorizadas;</li>
                    <li>Copiar, modificar, distribuir, vender ou sublicenciar o sistema sem autorização expressa;</li>
                    <li>Realizar engenharia reversa, descompilar ou tentar acessar o código-fonte;</li>
                    <li>Utilizar documentos, regras ou pareceres sem permissão formal;</li>
                    <li>Armazenar ou transmitir dados do sistema fora da rede corporativa sem autorização prévia.</li>
                </ul>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">4. Confidencialidade</h3>
                <p class="text-subtle">Todas as informações acessadas, processadas ou armazenadas são confidenciais, incluindo dados de clientes, cálculos, regras de negócio e pareceres técnicos. O usuário compromete-se a manter sigilo absoluto, mesmo após o desligamento da empresa, e a não divulgar ou armazenar externamente qualquer informação sem autorização.</p>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">5. Responsabilidade Limitada</h3>
                <p class="text-subtle">O sistema é fornecido “como está” e pode apresentar limitações técnicas decorrentes de atualizações, integrações externas ou uso indevido. Os desenvolvedores se responsabilizam apenas pelo funcionamento correto das funcionalidades especificadas.</p>
                <p class="text-subtle mt-2">Decisões operacionais, financeiras ou jurídicas baseadas no sistema devem ser validadas pelo usuário. Falhas devem ser comunicadas imediatamente pelos canais oficiais.</p>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">6. Suporte e Comunicação de Incidentes</h3>
                <p class="text-subtle">Dúvidas, falhas ou incidentes devem ser reportados imediatamente pelo canal oficial da Meta Serviços em Informática S.A. (Microsoft Teams, e-mail corporativo ou ferramenta designada). O não reporte pode limitar a responsabilidade dos autores.</p>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">7. Vigência e Atualizações</h3>
                <p class="text-subtle">Estes termos entram em vigor na data da versão indicada e podem ser atualizados a qualquer momento por motivos técnicos, legais ou operacionais. O usuário deve manter-se informado sobre a versão vigente.</p>
            </div>
        </div>

        <div class="mt-6 space-y-4">
            <label for="terms-checkbox" class="flex items-center justify-center gap-2 text-sm cursor-pointer">
                <input type="checkbox" id="terms-checkbox" class="h-4 w-4 rounded border-gray-300 text-accent focus:ring-accent">
                <span>Declaro que li, compreendi e aceito todos os termos e condições de uso descritos acima</span>
            </label>
            <button id="accept-terms-btn" class="w-full px-8 py-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 text-accent" disabled>
                Aceitar e Continuar
            </button>
        </div>
    </div>
</div>


    <div id="main-content" class="min-h-screen w-full flex flex-col items-center p-4 sm:p-8 transition-all duration-300">

        <main class="w-full max-w-5xl mx-auto flex flex-col gap-4 mb-24">
            <header class="flex justify-between items-center w-full px-2 flex-shrink-0">
                <h1 id="module-title" class="text-2xl font-bold transition-all duration-300"></h1>
                <div class="flex items-center gap-2">
                    <button id="info-button" class="p-3 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">
                        <i data-lucide="info" class="w-5 h-5"></i>
                    </button>
                    <button id="theme-toggle" class="p-3 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">
                        <i data-lucide="sun" id="sun-icon" class="w-5 h-5"></i>
                        <i data-lucide="moon" id="moon-icon" class="hidden w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <div id="module-container" class="w-full p-6 md:p-8 rounded-2xl neumorphic-outset min-h-[60vh]">
                <div id="faturamento-module" class="module-content hidden">
                    <div class="flex mb-6 border-b border-slate-300 dark:border-slate-600 flex-shrink-0 overflow-x-auto">
                        <button class="faturamento-tab-button py-2 px-4 font-semibold whitespace-nowrap" data-tab="calculo-simples">Cálculo do Simples</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="rel-faturamento">Rel. Faturamento</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="semoventes">Semoventes</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="nfs">NF's</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="porcentagem">Porcentagem</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="fcpr">FCPR</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="calc-datas">Cal. Datas</button>
                    </div>
                    <div>
                        <div id="calculo-simples-tab" class="faturamento-tab-content">
                            <form id="faturamento-form" class="space-y-6">
                                <!-- 1º MÉTODO DE CÁLCULO -->
                                <div class="p-4 rounded-2xl neumorphic-outset space-y-4">
                                    <h3 class="text-lg font-bold text-center text-accent">1º MÉTODO DE CÁLCULO (SOMENTE RBT12)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                                        <div class="space-y-4">
                                            <div class="flex flex-col gap-2">
                                                <label for="rbt12_metodo1" class="text-sm font-medium">Receita Bruta Acumulada (RBT12)</label>
                                                <input type="text" inputmode="decimal" id="rbt12_metodo1" placeholder="R$ 0,00" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="meses_metodo1" class="text-sm font-medium">Quantidade de Meses RBT12</label>
                                                <input type="number" id="meses_metodo1" placeholder="12" value="12" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium">Renda 1º Cálculo</label>
                                            <div class="p-3 rounded-xl neumorphic-inset h-28 flex items-center justify-center">
                                                <p id="resultado1" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        
                                <!-- 2º MÉTODO DE CÁLCULO -->
                                <div class="p-4 rounded-2xl neumorphic-outset space-y-4">
                                    <h3 class="text-lg font-bold text-center text-accent">2º MÉTODO DE CÁLCULO (> 12 MESES)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                                        <div class="space-y-4">
                                            <div class="flex flex-col gap-2">
                                                <label for="rpa_metodo2" class="text-sm font-medium">Receita Bruta do PA (RPA)</label>
                                                <input type="text" inputmode="decimal" id="rpa_metodo2" placeholder="R$ 0,00" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="rbt12_metodo2" class="text-sm font-medium">Receita Bruta Acumulada (RBT12)</label>
                                                <input type="text" inputmode="decimal" id="rbt12_metodo2" placeholder="R$ 0,00" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="mes_anterior_metodo2" class="text-sm font-medium">Valor a ser Reduzido (Mês Anterior)</label>
                                                <input type="text" inputmode="decimal" id="mes_anterior_metodo2" placeholder="R$ 0,00" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium">Renda 2º Cálculo</label>
                                            <div class="p-3 rounded-xl neumorphic-inset h-28 flex items-center justify-center">
                                                <p id="resultado2" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        
                                <!-- 3º MÉTODO DE CÁLCULO -->
                                <div class="p-4 rounded-2xl neumorphic-outset space-y-4">
                                    <h3 class="text-lg font-bold text-center text-accent">3º MÉTODO DE CÁLCULO (&lt; 12 MESES)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                                        <div class="space-y-4">
                                            <div class="flex flex-col gap-2">
                                                <label for="rpa_metodo3" class="text-sm font-medium">Receita Bruta do PA (RPA)</label>
                                                <input type="text" inputmode="decimal" id="rpa_metodo3" placeholder="R$ 0,00" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="rbt12_metodo3" class="text-sm font-medium">Receita Bruta Acumulada (RBT12)</label>
                                                <input type="text" inputmode="decimal" id="rbt12_metodo3" placeholder="R$ 0,00" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="num_meses_metodo3" class="text-sm font-medium">Quantidade de Meses (RBT12 + RPA)</label>
                                                <input type="number" id="num_meses_metodo3" placeholder="Ex: 1" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium">Renda 3º Cálculo</label>
                                            <div class="p-3 rounded-xl neumorphic-inset h-28 flex items-center justify-center">
                                                <p id="resultado3" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        
                                <div class="flex gap-4 mt-4">
                                    <button id="calcular-faturamento" type="button" class="flex-1 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="calculator" class="w-5 h-5"></i> Calcular Todos
                                    </button>
                                    <button id="limpar-faturamento" type="button" class="flex-1 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar Tudo
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div id="rel-faturamento-tab" class="faturamento-tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                    <div class="flex flex-col gap-2">
                                        <h3 class="text-lg font-semibold mb-2">Valores Mensais</h3>
                                        <div id="rel-faturamento-inputs" class="space-y-2">
                                            </div>
                                    </div>
                                    <div class="flex flex-col gap-4">
                                        <div class="flex flex-col gap-2">
                                            <label for="rel-faturamento-divisor" class="text-sm font-medium">Dividir Total por (Nº de Meses)</label>
                                            <input type="number" id="rel-faturamento-divisor" placeholder="Padrão: 12" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium">Soma Total dos Valores</label>
                                            <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                                <p id="rel-faturamento-renda-12-meses" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium">Renda Mensal Resultante</label>
                                            <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                                <p id="rel-faturamento-renda-mensal" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                            </div>
                                        </div>
                                        <button id="rel-faturamento-limpar" type="button" class="mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                            <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                        </button>
                                    </div>
                            </div>
                        </div>
                        <div id="semoventes-tab" class="faturamento-tab-content hidden">
                            <div class="flex flex-col gap-8">
                                <!-- Calculadora de Rebanho -->
                                 <!-- Calculadora IRPF -->
                                <div>
                                    <div class="max-w-md mx-auto space-y-4">
                                        <h3 class="text-xl font-semibold text-center">Cálculo IRPF (Receita Bruta)</h3>

                                        <!-- Campos em Grid 2x2 -->
                                        <div class="grid grid-cols-2 gap-4">
                                        <!-- Campo 1 -->
                                        <div class="flex flex-col gap-2">
                                            <label for="irpf-receita-bruta" class="text-sm font-medium">Receita Bruta - Brasil</label>
                                            <input type="text" inputmode="decimal" id="irpf-receita-bruta" placeholder="R$ 0,00"
                                                class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                        </div>

                                        <!-- Campo 2 -->
                                        <div class="flex flex-col gap-2">
                                            <label for="irpf-vendas" class="text-sm font-medium">Vendas (Quantidade)</label>
                                            <input type="number" id="irpf-vendas" placeholder="0"
                                                class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                        </div>

                                        <!-- Campo 3 -->
                                        <div class="flex flex-col gap-2">
                                            <label for="irpf-estoque-final" class="text-sm font-medium">Estoque Final (Quantidade)</label>
                                            <input type="number" id="irpf-estoque-final" placeholder="0"
                                                class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                        </div>

                                        <!-- Campo 4: Resultado (com label acima) -->
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium">Valor Apurado (Estoque Final)</label>
                                            <div class="w-full p-3 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="irpf-resultado-valor" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                            </div>
                                        </div>
                                        </div>

                                        <!-- Botão de limpar -->
                                        <button id="irpf-limpar" type="button"
                                                class="w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar Cálculo IRPF
                                        </button>
                                    </div>
                                </div>

                                <!-- Separador -->
                                <hr class="border-slate-300 dark:border-slate-600 my-4">

                                <div>
                                    <h3 class="text-xl font-semibold mb-6 text-center">Cálculo de Rebanho (Valor Unitário)</h3>
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                        <div class="lg:col-span-2">
                                            <div class="overflow-x-auto">
                                                <table class="w-full text-sm">
                                                    <thead class="border-b-2 border-slate-300 dark:border-slate-600">
                                                        <tr>
                                                            <th class="p-2 text-left">Descrição</th>
                                                            <th class="p-2 text-left">Quantidade</th>
                                                            <th class="p-2 text-left">Valor Unitário</th>
                                                            <th class="p-2 text-left">Total</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="semoventes-tbody">
                                                        <!-- Linhas geradas por JS -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-4">
                                            <h3 class="text-lg font-semibold">Resultados do Rebanho</h3>
                                            <div class="flex flex-col gap-2">
                                                <label class="text-sm font-medium">Quantidade Total</label>
                                                <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                                    <p id="semoventes-qtd-total" class="text-2xl font-bold text-accent">0</p>
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label class="text-sm font-medium">Renda Anual</label>
                                                <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                                    <p id="semoventes-renda-anual" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                                </div>
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label class="text-sm font-medium">Renda Mensal</label>
                                                <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                                    <p id="semoventes-renda-mensal" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                                </div>
                                            </div>
                                            <button id="semoventes-limpar" type="button" class="mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                                <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                            </button>
                                        </div>
                                    </div>
                                </div>
                        
                                <!-- Separador -->
                                <hr class="border-slate-300 dark:border-slate-600 my-4">
                    
                            </div>
                        </div>
                        <div id="nfs-tab" class="faturamento-tab-content hidden">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2">
                                    <h3 class="text-lg font-semibold mb-4">Notas Fiscais</h3>
                                    <div id="nfs-grid" class="grid grid-flow-col grid-rows-10 gap-x-8 gap-y-2 overflow-x-auto custom-scrollbar pb-2">
                                        <!-- Inputs gerados por JS -->
                                    </div>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <h3 class="text-lg font-semibold">Cálculo</h3>
                                    <div class="flex flex-col gap-2">
                                        <label for="nfs-propriedade" class="text-sm font-medium">Propriedade (%)</label>
                                        <input type="text" inputmode="decimal" id="nfs-propriedade" value="100" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Anual</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="nfs-renda-anual" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Mensal</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="nfs-renda-mensal" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <button id="nfs-limpar" type="button" class="mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                         <div id="porcentagem-tab" class="faturamento-tab-content hidden">
                            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                                <!-- Calculators container -->
                                <div class="lg:col-span-3">
                                    <!-- Calculator 1: Quotas -->
                                    <div id="calculadora-quotas-container" class="porcentagem-calc-container">
                                        <div class="space-y-6">
                                            <h3 class="text-xl font-bold text-center text-accent">Calculadora de Quotas</h3>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                                <div class="space-y-4 p-4 rounded-2xl neumorphic-inset">
                                                    <h4 class="text-lg font-semibold text-center">Calcular % por Valor</h4>
                                                    <div class="flex flex-col gap-2">
                                                        <label for="quotas-valor-total-empresa-1" class="text-sm font-medium">Valor total das quotas da empresa</label>
                                                        <input type="text" inputmode="decimal" id="quotas-valor-total-empresa-1" placeholder="R$ 0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                                    </div>
                                                    <div class="flex flex-col gap-2">
                                                        <label for="quotas-valor-associado-1" class="text-sm font-medium">Valor monetário das quotas do associado</label>
                                                        <input type="text" inputmode="decimal" id="quotas-valor-associado-1" placeholder="R$ 0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                                    </div>
                                                    <div class="flex flex-col gap-2 mt-2">
                                                        <label class="text-sm font-medium">% Percentual Propriedade do Associado</label>
                                                        <div class="p-3 rounded-2xl neumorphic-inset min-h-[44px] flex items-center">
                                                            <p id="quotas-percentual-resultado" class="font-bold text-accent">0.00%</p>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="space-y-4 p-4 rounded-2xl neumorphic-inset">
                                                    <h4 class="text-lg font-semibold text-center">Calcular Valor por %</h4>
                                                    <div class="flex flex-col gap-2">
                                                        <label for="quotas-valor-total-empresa-2" class="text-sm font-medium">Valor total das quotas da empresa</label>
                                                        <input type="text" inputmode="decimal" id="quotas-valor-total-empresa-2" placeholder="R$ 0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                                    </div>
                                                    <div class="flex flex-col gap-2">
                                                        <label for="quotas-percentual-associado-2" class="text-sm font-medium">% Percentual Propriedade do Associado</label>
                                                        <input type="text" inputmode="decimal" id="quotas-percentual-associado-2" placeholder="0,00%" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                                    </div>
                                                    <div class="flex flex-col gap-2 mt-2">
                                                        <label class="text-sm font-medium">Valor monetário das quotas do associado</label>
                                                        <div class="p-3 rounded-2xl neumorphic-inset min-h-[44px] flex items-center">
                                                            <p id="quotas-valor-resultado" class="font-bold text-accent">R$ 0,00</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Calculator 2: Produtor -->
                                    <div id="calculadora-produtor-container" class="porcentagem-calc-container hidden">
                                        <div class="space-y-6">
                                            <h3 class="text-xl font-bold text-center text-accent">Calculadora de Produtor</h3>
                                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                <!-- Inputs -->
                                                <div class="space-y-4 p-4 rounded-2xl neumorphic-inset">
                                                    <div class="flex flex-col gap-2">
                                                        <label for="produtor-renda-agro" class="text-sm font-medium">Renda Agro</label>
                                                        <input type="text" inputmode="decimal" id="produtor-renda-agro" placeholder="R$ 0,00" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                                    </div>
                                                    <div class="flex flex-col gap-2">
                                                        <label for="produtor-renda-nao-agro" class="text-sm font-medium">Renda Não Agro</label>
                                                        <input type="text" inputmode="decimal" id="produtor-renda-nao-agro" placeholder="R$ 0,00" class="w-full p-3 rounded-xl neumorphic-inset focus:outline-none text-sm h-14">
                                                    </div>
                                                    <div class="flex items-center gap-3 pt-2">
                                                        <input type="checkbox" id="produtor-possui-caf" class="h-5 w-5 rounded border-gray-300 text-accent focus:ring-accent cursor-pointer">
                                                        <label for="produtor-possui-caf" class="text-sm font-medium cursor-pointer select-none">Possui CAF?</label>
                                                    </div>
                                                </div>
                                                <!-- Results -->
                                                <div class="space-y-4">
                                                    <div class="p-3 rounded-xl neumorphic-inset h-full flex flex-col justify-around">
                                                        <div>
                                                            <label class="text-sm font-medium">Renda Total</label>
                                                            <p id="produtor-renda-total" class="text-xl font-bold text-accent">R$ 0,00</p>
                                                        </div>
                                                        <hr class="border-slate-300 dark:border-slate-600 my-2">
                                                        <div>
                                                            <label class="text-sm font-medium">Porcentagens (Agro / Não Agro)</label>
                                                            <p id="produtor-porcentagens" class="text-xl font-bold text-accent">0,00% / 0,00%</p>
                                                        </div>
                                                         <hr class="border-slate-300 dark:border-slate-600 my-2">
                                                        <div>
                                                            <label class="text-sm font-medium">Classificação do Produtor</label>
                                                            <p id="produtor-classificacao" class="text-xl font-bold text-accent">-</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- Alerta CAF -->
                                            <div id="produtor-alerta-caf" class="hidden mt-4 p-3 rounded-xl neumorphic-inset text-sm font-semibold text-yellow-600 dark:text-yellow-400 text-center"></div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Navigation buttons -->
                                <div class="flex flex-col gap-4 pt-16">
                                    <button class="porcentagem-calc-button p-4 rounded-2xl font-semibold neumorphic-inset transition-all duration-200 active:scale-95" data-target="calculadora-quotas-container">
                                        Quotas
                                    </button>
                                    <button class="porcentagem-calc-button p-4 rounded-2xl font-semibold neumorphic-outset-sm transition-all duration-200 active:scale-95" data-target="calculadora-produtor-container">
                                        Produtor
                                    </button>
                                    <button id="porcentagem-limpar-btn" type="button" class="p-4 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2 mt-4">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                         <div id="fcpr-tab" class="faturamento-tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div class="flex flex-col gap-2">
                                    <h3 class="text-lg font-semibold mb-2">Renda Agrícola & Agropecuária</h3>
                                    <div id="fcpr-inputs" class="space-y-2">
                                        <!-- Inputs serão gerados pelo JS -->
                                    </div>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <h3 class="text-lg font-semibold">Percentual Propriedade / Período</h3>
                                    <div class="flex flex-col gap-2">
                                        <label for="fcpr-percentual" class="text-sm font-medium">Percentual (%)</label>
                                        <input type="text" inputmode="decimal" id="fcpr-percentual" value="100" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label for="fcpr-meses" class="text-sm font-medium">Meses</label>
                                        <input type="number" id="fcpr-meses" value="12" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Anual</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="fcpr-renda-anual" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Mensal</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="fcpr-renda-mensal" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <button id="fcpr-limpar" type="button" class="mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                           </div>
                        </div>
                        <div id="calc-datas-tab" class="faturamento-tab-content hidden">
                            <h3 class="text-2xl font-bold mb-6">Calculadora de Datas</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 items-end">
                                <div class="flex flex-col gap-2">
                                    <label for="data-inicio" class="text-sm font-medium">Data de Início</label>
                                    <input type="date" id="data-inicio" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label for="data-fim" class="text-sm font-medium">Data Final</label>
                                    <input type="date" id="data-fim" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                <button id="calcular-datas" type="button" class="p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                    <i data-lucide="calendar-clock" class="w-5 h-5"></i> Calcular
                                </button>
                                <button id="limpar-datas" type="button" class="p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                </button>
                            </div>
                            <div id="resultado-datas" class="mt-6 p-6 rounded-2xl neumorphic-inset min-h-[100px] text-center flex items-center justify-center hidden animate-fade-in">
                                <!-- O resultado será exibido aqui -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="renda-pf-module" class="module-content hidden">
                    <div class="flex mb-6 border-b border-slate-300 dark:border-slate-600 flex-shrink-0">
                        <button class="renda-pf-tab-button py-2 px-4 font-semibold" data-tab="calculadora">Calculadora</button>
                        <button class="renda-pf-tab-button py-2 px-4 font-semibold text-subtle" data-tab="media">Média de Holerites</button>
                        <button class="renda-pf-tab-button py-2 px-4 font-semibold text-subtle" data-tab="soma">Soma de Valores</button>
                    </div>
                    <div>
                        <div id="calculadora-tab" class="renda-pf-tab-content">
                           <h3 class="text-2xl font-bold mb-6 text-center">Calculadora Renda PF</h3>
                            <div class="max-w-sm mx-auto p-4 rounded-2xl neumorphic-outset">
                                <!-- Display -->
                                <div class="p-4 rounded-2xl neumorphic-inset text-right mb-4">
                                    <div id="renda-pf-history" class="text-sm text-subtle h-6 truncate"></div>
                                    <input type="text" id="renda-pf-display" readonly class="w-full bg-transparent focus:outline-none text-4xl font-bold text-accent" value="0">
                                </div>
                                <!-- Buttons -->
                                <div class="grid grid-cols-4 gap-3">
                                    <button data-action="clear" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 text-accent">AC</button>
                                    <button data-action="special" data-value="*12" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">x12</button>
                                    <button data-action="special" data-value="/12" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">/12</button>
                                    <button data-operator="/" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 text-accent">÷</button>
                        
                                    <button data-number="7" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">7</button>
                                    <button data-number="8" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">8</button>
                                    <button data-number="9" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">9</button>
                                    <button data-operator="*" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 text-accent">×</button>
                                    
                                    <button data-number="4" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">4</button>
                                    <button data-number="5" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">5</button>
                                    <button data-number="6" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">6</button>
                                    <button data-operator="-" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 text-accent">−</button>
                        
                                    <button data-number="1" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">1</button>
                                    <button data-number="2" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">2</button>
                                    <button data-number="3" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">3</button>
                                    <button data-operator="+" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 text-accent">+</button>
                        
                                    <button data-number="0" class="calculator-btn col-span-2 p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">0</button>
                                    <button data-number="." class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">.</button>
                                    <button data-action="equals" class="calculator-btn p-4 rounded-2xl neumorphic-outset-sm font-semibold text-xl transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 text-accent">=</button>
                                </div>
                            </div>
                        </div>
                        <div id="media-tab" class="renda-pf-tab-content hidden">
                            <h3 class="text-2xl font-bold mb-6">Média de Holerites</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="flex flex-col gap-4">
                                    <h4 class="text-sm text-subtle uppercase tracking-wide">Valores</h4>
                                    <input type="text" inputmode="decimal" placeholder="Valor 1" class="media-holerite-input w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    <input type="text" inputmode="decimal" placeholder="Valor 2" class="media-holerite-input w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    <input type="text" inputmode="decimal" placeholder="Valor 3" class="media-holerite-input w-full bg-transparent p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                </div>
                                <div class="flex flex-col gap-4">
                                    <h4 class="text-sm text-subtle uppercase tracking-wide">Resultado</h4>
                                    <div class="p-4 rounded-2xl neumorphic-inset">
                                        <p class="text-sm font-medium">Média dos Valores</p>
                                        <p id="media_resultado" class="text-2xl font-bold text-accent mt-1">R$ 0,00</p>
                                    </div>
                                    <button id="limpar_media" type="button" class="mt-2 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">Limpar</button>
                                </div>
                            </div>
                        </div>
                        <div id="soma-tab" class="renda-pf-tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="flex flex-col gap-2">
                                    <h4 class="text-sm text-subtle uppercase tracking-wide mb-2">Valores a Somar</h4>
                                    <div id="soma-inputs-container" class="flex flex-col gap-2">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <h4 class="text-sm text-subtle uppercase tracking-wide mb-2">Valores a Subtrair</h4>
                                    <div id="sub-inputs-container" class="flex flex-col gap-2">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    </div>
                                </div>
                                <div class="md:col-span-2 flex flex-col md:flex-row gap-4 mt-4">
                                     <div class="flex-1 p-4 rounded-2xl neumorphic-inset">
                                         <p class="text-sm font-medium">Soma Total</p>
                                         <p id="soma_total_resultado" class="text-2xl font-bold text-accent mt-1">R$ 0,00</p>
                                     </div>
                                     <div class="flex-1 p-4 rounded-2xl neumorphic-inset">
                                         <p class="text-sm font-medium">Divisão por 12</p>
                                         <p id="soma_div12_resultado" class="text-2xl font-bold text-accent mt-1">R$ 0,00</p>
                                     </div>
                                </div>
                                <div class="md:col-span-2 mt-4">
                                    <button id="limpar_soma" type="button" class="w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="regras-module" class="module-content hidden">
                    <h2 class="text-2xl font-bold mb-6">Regras do Imposto de Renda</h2>
                    <div class="overflow-auto custom-scrollbar">
                        <table class="w-full text-left text-sm">
                            <thead class="border-b-2 border-slate-300 dark:border-slate-600 sticky top-0 bg-[var(--color-bg)]">
                                <tr>
                                    <th class="p-2">Item</th>
                                    <th class="p-2">Referência</th>
                                    <th class="p-2">Tipo de Renda Aceito</th>
                                </tr>
                            </thead>
                            <tbody id="regras-irpf-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="cnpj-module" class="module-content hidden">
                    <h3 class="text-2xl font-bold mb-6">Consultar CNPJ</h3>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="cnpj-input" placeholder="00.000.000/0000-00" class="flex-grow p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                        <button id="consultar-cnpj" class="p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                            <i data-lucide="search" class="w-5 h-5"></i> Consultar
                        </button>
                        <button id="limpar-cnpj" class="p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                            <i data-lucide="x" class="w-5 h-5"></i> Limpar
                        </button>
                    </div>
                    <div id="cnpj-results-container" class="mt-6">
                        </div>
                </div>

                <div id="parecer-module" class="module-content hidden flex flex-col">
                    <div class="flex flex-col sm:flex-row items-center mb-6 gap-4 flex-shrink-0">
                        <div class="relative flex-grow w-full">
                            <input type="text" id="searchInput" placeholder="Pesquisar pareceres por tipo ou descrição..." class="w-full p-3 pr-12 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                            <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-subtle"></i>
                        </div>
                        <div class="w-full sm:w-auto">
                            <select id="parecer-category-filter" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                </select>
                        </div>
                    </div>
                    <div id="pareceresContainer" class="space-y-4 overflow-auto custom-scrollbar flex-grow">
                        </div>
                </div>
                
                <!-- INÍCIO DO MÓDULO CONTADOR ATUALIZADO -->
                <div id="contador-module" class="module-content hidden h-full flex flex-col gap-4">
                    <!-- Abas do Módulo Contador -->
                    <div class="flex mb-4 border-b border-slate-300 dark:border-slate-600 flex-shrink-0">
                        <button class="contador-tab-button py-2 px-4 font-semibold" data-tab="contador-main">Contador</button>
                        <button class="contador-tab-button py-2 px-4 font-semibold text-subtle" data-tab="contador-history">Histórico</button>
                    </div>

                    <!-- Conteúdo da Aba Principal do Contador -->
                    <div id="contador-main-tab" class="contador-tab-content flex flex-col gap-8 h-full">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div id="counters-grid" class="grid grid-cols-1 sm:grid-cols-2 grid-rows-2 gap-4 min-h-[320px]">
                               <!-- Contadores são inseridos aqui via JS -->
                            </div>
                            <div class="flex flex-col gap-4 p-4 md:p-6 rounded-2xl neumorphic-inset h-full justify-center">
                                 <h3 class="text-sm text-subtle uppercase tracking-wide">Configurações</h3>
                                 <div class="flex items-center justify-between">
                                     <label for="timer-toggle" class="font-medium text-sm">Modo Timer (Valor em minutos)</label>
                                     <div class="toggle-container">
                                         <input type="checkbox" name="toggle" id="timer-toggle" class="toggle-checkbox"/>
                                         <label for="timer-toggle" class="toggle-label"></label>
                                     </div>
                                 </div>
                                 <div class="flex flex-col gap-2">
                                     <label for="increment-by-input" class="text-sm font-medium">Incrementar por</label>
                                     <input type="number" id="increment-by-input" value="1" class="w-full bg-transparent p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                 </div>
                                 <div class="flex flex-col gap-2">
                                     <label for="counter-start-input" class="text-sm font-medium">Valor Inicial</label>
                                     <input type="number" id="counter-start-input" value="0" class="w-full bg-transparent p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                 </div>
                                  <div class="grid grid-cols-2 gap-4 mt-2">
                                     <button id="add-counter-btn" class="w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase text-xs transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                         <i data-lucide="plus-circle" class="w-4 h-4"></i> Adicionar
                                     </button>
                                      <button id="finalizar-dia-btn" class="w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase text-xs transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                         <i data-lucide="check-circle" class="w-4 h-4"></i> Finalizar Dia
                                     </button>
                                  </div>
                                  <button id="contador-reset" class="col-span-2 w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase text-xs transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2 text-red-500">
                                     <i data-lucide="trash-2" class="w-4 h-4"></i> Resetar Tudo
                                 </button>
                            </div>
                        </div>
                        <!-- Seção Inferior: Gráfico de Atividade por Hora -->
                        <div class="p-4 rounded-2xl neumorphic-inset flex-1 flex flex-col min-h-[200px]">
                            <h3 class="text-sm text-subtle uppercase tracking-wide mb-4 flex-shrink-0">Atividade por Hora (Hoje)</h3>
                            <div class="relative flex-grow">
                                <canvas id="counter-chart"></canvas>
                            </div>
                        </div>
                         <div id="finalizar-dia-feedback" class="text-center p-4 rounded-2xl neumorphic-inset text-green-500 font-semibold hidden animate-fade-in"></div>
                    </div>

                    <!-- Conteúdo da Aba de Histórico -->
                    <div id="contador-history-tab" class="contador-tab-content hidden h-full">
                        <div class="flex flex-col h-full gap-4">
                            <div class="flex items-center justify-center gap-2 flex-wrap">
                                <button class="history-filter-btn p-2 px-4 rounded-xl neumorphic-outset-sm text-sm font-semibold" data-period="week">Última Semana</button>
                                <button class="history-filter-btn p-2 px-4 rounded-xl neumorphic-outset-sm text-sm font-semibold" data-period="month">Últimos 12 Meses</button>
                                <button class="history-filter-btn p-2 px-4 rounded-xl neumorphic-outset-sm text-sm font-semibold" data-period="year">Últimos 10 Anos</button>
                            </div>
                            <div class="p-4 rounded-2xl neumorphic-inset flex-1 flex flex-col min-h-[300px]">
                                <h3 id="history-chart-title" class="text-sm text-subtle uppercase tracking-wide mb-4 flex-shrink-0 text-center"></h3>
                                <div class="relative flex-grow">
                                    <canvas id="history-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- FIM DO MÓDULO CONTADOR ATUALIZADO -->

                <div id="checklist-module" class="module-content hidden flex flex-col gap-4 h-full">
                    </div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 p-4 w-full flex justify-center">
            <div id="dock-container" class="relative flex items-center justify-start rounded-full neumorphic-outset overflow-x-auto max-w-full py-1">
                <div id="dock-slider" class="absolute top-0 bottom-0 rounded-full neumorphic-inset"></div>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="faturamento-module" data-title="Cálculo Renda PJ">Renda PJ</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="renda-pf-module" data-title="Cálculo Renda PF">Renda PF</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="cnpj-module" data-title="Consulta CNPJ">Consulta CNPJ</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="contador-module" data-title="Contador">Contador</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="regras-module" data-title="Regras IRPF">Regras</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="parecer-module" data-title="Pareceres">Pareceres</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="checklist-module" data-title="Checklist">Checklist</button>
            </div>
        </nav>
    </div>

    <!-- MODAL DE VISUALIZAÇÃO DE IMAGEM -->
    <div id="image-viewer-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden bg-black/80 backdrop-blur-sm overflow-hidden">
        <button id="image-viewer-close" class="absolute top-4 right-4 text-white p-2 rounded-full transition-colors z-20 hover:bg-white/20">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 flex items-center gap-2">
            <button id="zoom-out-btn" class="text-white p-2 rounded-full transition-colors hover:bg-white/20">
                <i data-lucide="zoom-out" class="w-6 h-6"></i>
            </button>
            <button id="zoom-in-btn" class="text-white p-2 rounded-full transition-colors hover:bg-white/20">
                <i data-lucide="zoom-in" class="w-6 h-6"></i>
            </button>
        </div>
        <div id="image-viewer-wrapper" class="relative w-full h-full flex items-center justify-center image-viewer-content-wrapper">
            <img id="image-viewer-content" src="" alt="Imagem Ampliada" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
        </div>
    </div>

    <!-- MODAL DE INFORMAÇÕES (CRÉDITOS) -->
    <div id="info-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-[var(--color-bg)] opacity-80"></div>
        <div class="modal-content relative w-full max-w-lg p-6 rounded-2xl neumorphic-outset animate-fade-in">
            <button class="modal-close-btn absolute top-4 right-4 p-2 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/10 dark:hover:bg-white/10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-accent">Créditos e Uso</h2>
            <div class="text-sm space-y-3">
                <p><strong>Desenvolvido por:</strong> Wellington Juan Dutra Oliveira</p>
                <p><strong>Com colaboração de:</strong></p>
                <ul class="list-disc list-inside pl-4 text-subtle">
                    <li>Gabriel Artur Lopes Feltes (Coordenador de BPO)</li>
                    <li>Mauricio Gabriel Freiberger Konig (Líder de BPO)</li>
                    <li>Erika Mendonça Figueira (Assistente de BPO)</li>
                    <li>Bruno Corrêa Alves (Assistente de BPO)</li>
                </ul>
                <p><strong>Lembrete de Uso:</strong></p>
                <p class="text-subtle">Esta ferramenta é de uso exclusivo para colaboradores da Meta Serviços em Informática S.A. a serviço do Sicoob. É proibida a cópia, distribuição ou uso fora do âmbito profissional designado.</p>
                <p class="text-xs text-center text-subtle pt-4 mt-4 border-t border-[var(--color-shadow-2)]">© 2025 Wellington Juan Dutra Oliveira e colaboradores. Todos os direitos reservados.</p>
            </div>
        </div>
    </div>

    <template id="counter-template">
        <div class="counter-card p-3 rounded-2xl neumorphic-inset flex flex-col items-center justify-center gap-2 relative h-full">
            <button class="star-btn absolute top-2 left-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                <i data-lucide="star" class="star-icon w-4 h-4"></i>
            </button>
            <button class="remove-counter-btn absolute top-2 right-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
            <h4 class="counter-title font-semibold text-center w-full px-8 truncate" contenteditable="true">Contador</h4>
            <span class="counter-display font-bold text-6xl text-accent cursor-pointer" contenteditable="false">0</span>
            <div class="flex items-center gap-3">
                <button class="counter-minus w-16 h-16 rounded-2xl neumorphic-outset-sm text-4xl font-bold active:scale-95 transition-transform flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/5">-</button>
                <button class="counter-plus w-16 h-16 rounded-2xl neumorphic-outset-sm text-4xl font-bold active:scale-95 transition-transform flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/5">+</button>
                
                <button class="timer-play-pause w-16 h-16  rounded-2xl neumorphic-outset-sm text-4xl font-bold active:scale-95 transition-transform flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/5 hidden"><i data-lucide="play" class="w-6 h-6"></i></button>
                <button class="timer-reset w-16 h-16  rounded-2xl neumorphic-outset-sm text-4xl font-bold active:scale-95 transition-transform flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/5 hidden"><i data-lucide="rotate-cw" class="w-6 h-6"></i></button>
            </div>
        </div>
    </template>

    <script>
        // --- FUNÇÕES GLOBAIS ---
        function copyParecer(text, buttonElement) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);

            if (buttonElement) {
                // Garante que a animação possa ser reativada a cada clique
                buttonElement.classList.remove('copy-success-glow');
                // Força o navegador a "repintar", reiniciando a animação
                void buttonElement.offsetWidth;
                buttonElement.classList.add('copy-success-glow');

                const icon = buttonElement.querySelector('i');
                const originalIcon = icon.dataset.lucide;
                icon.dataset.lucide = 'check';
                if (typeof lucide !== 'undefined') lucide.createIcons();

                // Limpa o ícone após o mesmo tempo da nova animação (1.5s)
                setTimeout(() => {
                    icon.dataset.lucide = originalIcon;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 1500);
                
                // Remove a classe da animação ao final para deixar o botão limpo
                buttonElement.addEventListener('animationend', () => {
                    buttonElement.classList.remove('copy-success-glow');
                }, { once: true });
            }
        }

        window.onload = () => {
            // --- SELEÇÃO DOS ELEMENTOS DO DOM ---
            const themeToggleButton = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const dockContainer = document.getElementById('dock-container');
            const dockSlider = document.getElementById('dock-slider');
            const dockButtons = document.querySelectorAll('.dock-button');
            const moduleTitle = document.getElementById('module-title');
            const modules = document.querySelectorAll('.module-content');
            const infoButton = document.getElementById('info-button');
            const infoModal = document.getElementById('info-modal');
            const modalOverlay = infoModal.querySelector('.modal-overlay');
            const modalCloseBtn = infoModal.querySelector('.modal-close-btn');
            const mainContent = document.getElementById('main-content');

            // --- Elementos do Modal de Termos ---
            const termsModal = document.getElementById('terms-modal');
            const acceptTermsBtn = document.getElementById('accept-terms-btn');
            const termsCheckbox = document.getElementById('terms-checkbox');
            
            // --- Elementos do Modal de Visualização de Imagem ---
            const imageViewerModal = document.getElementById('image-viewer-modal');
            const imageViewerClose = document.getElementById('image-viewer-close');
            const imageViewerContent = document.getElementById('image-viewer-content');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');

            // --- Variável de estado para o Checklist ---
            let checklistState = {};


            // --- FUNÇÕES AUXILIARES ---
            function formatCurrency(value) {
                if (isNaN(value) || !isFinite(value)) {
                    return "R$ 0,00";
                }
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function parseLocalFloat(value) {
                return parseFloat(String(value).replace(/\./g, '').replace(',', '.')) || 0;
            }

            // Função para remover acentos de uma string
            function removeAccents(str) {
                if (typeof str !== 'string') return '';
                // Normaliza a string para decompor os caracteres acentuados e remove os diacríticos
                return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            }

            function safeCreateIcons() {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }
            
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                return new Date(dateString).toLocaleDateString('pt-BR', { timeZone: 'UTC' });
            }

            // --- LÓGICA DO MODO CLARO/ESCURO ---
            themeToggleButton.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                updateThemeIcons();
                // Atualiza os gráficos se eles estiverem visíveis
                if (currentModuleId === 'contador-module') {
                    if(counterChart) updateCounterChart();
                    if(historyChart) {
                        const activeFilter = document.querySelector('.history-filter-btn.active');
                        if (activeFilter) {
                            renderHistoryChart(activeFilter.dataset.period);
                        }
                    }
                }
            });
            
            function updateThemeIcons() {
                safeCreateIcons();
                const isDarkMode = document.documentElement.classList.contains('dark');
                sunIcon.classList.toggle('hidden', isDarkMode);
                moonIcon.classList.toggle('hidden', !isDarkMode);
            }

            // --- LÓGICA DO MODAL DE INFORMAÇÕES (CRÉDITOS) ---
            infoButton.addEventListener('click', () => {
                infoModal.classList.remove('hidden');
                mainContent.classList.add('blurred');
                safeCreateIcons();
            });

            function closeModal() {
                infoModal.classList.add('hidden');
                mainContent.classList.remove('blurred');
            }

            modalOverlay.addEventListener('click', closeModal);
            modalCloseBtn.addEventListener('click', closeModal);
            
            // --- LÓGICA DO MODAL DE VISUALIZAÇÃO DE IMAGEM COM ZOOM ---
            let zoomLevel = 1;
            let isDragging = false;
            let startX, startY, translateX = 0, translateY = 0;

            function applyTransform() {
                imageViewerContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
            }

            function openImageViewer(src) {
                if (!imageViewerModal || !mainContent || !imageViewerContent) return;
                imageViewerContent.src = src;
                imageViewerModal.classList.remove('hidden');
                mainContent.classList.add('blurred');
                safeCreateIcons();
            }

            function closeImageViewer() {
                if (!imageViewerModal || !mainContent) return;
                imageViewerModal.classList.add('hidden');
                mainContent.classList.remove('blurred');
                imageViewerContent.src = ''; // Limpa o src para evitar flash da imagem antiga
                // Reset zoom and pan on close
                zoomLevel = 1;
                translateX = 0;
                translateY = 0;
                applyTransform();
            }

            zoomInBtn.addEventListener('click', () => {
                zoomLevel = Math.min(zoomLevel + 0.2, 5); // Max zoom 5x
                applyTransform();
            });

            zoomOutBtn.addEventListener('click', () => {
                zoomLevel = Math.max(zoomLevel - 0.2, 0.5); // Min zoom 0.5x
                if (zoomLevel <= 1) { // Reset pan when zooming out to fit
                    translateX = 0;
                    translateY = 0;
                }
                applyTransform();
            });

            imageViewerContent.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomInBtn.click();
                } else {
                    zoomOutBtn.click();
                }
            });

            imageViewerContent.addEventListener('mousedown', (e) => {
                if (zoomLevel > 1) {
                    e.preventDefault();
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    imageViewerContent.classList.add('dragging');
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    translateX = e.clientX - startX;
                    translateY = e.clientY - translateY;
                    applyTransform();
                }
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
                imageViewerContent.classList.remove('dragging');
            });


            imageViewerClose.addEventListener('click', closeImageViewer);
            imageViewerModal.addEventListener('click', (e) => {
                if (e.target === imageViewerModal) { // Fecha apenas se clicar no fundo
                    closeImageViewer();
                }
            });


            // --- LÓGICA DA NAVEGAÇÃO E MÓDULOS ---
            let currentModuleId = null;

            function updateSlider(button) {
                if (!button) return;
                const containerRect = dockContainer.getBoundingClientRect();
                const buttonRect = button.getBoundingClientRect();
                dockSlider.style.width = `${buttonRect.width}px`;
                dockSlider.style.left = `${buttonRect.left - containerRect.left}px`;
                dockButtons.forEach(btn => btn.classList.remove('text-accent', 'font-semibold'));
                button.classList.add('text-accent', 'font-semibold');
            }

            dockButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const targetModuleId = button.dataset.target;
                    if (targetModuleId === currentModuleId) return;
                    currentModuleId = targetModuleId;
                    
                    const targetTitle = button.dataset.title;
                    updateSlider(button);
                    moduleTitle.textContent = targetTitle;
                    
                    modules.forEach(module => module.classList.add('hidden'));
                    const activeModule = document.getElementById(targetModuleId);
                    if (activeModule) {
                       activeModule.classList.remove('hidden');
                       if (targetModuleId === 'regras-module') renderRegrasTable();
                       if (targetModuleId === 'parecer-module') {
                            populateParecerFilter();
                            filterPareceres();
                       }
                       if (targetModuleId === 'contador-module') {
                           loadCountersState();
                           setTimeout(() => {
                               updateCounterChart();
                               const defaultFilter = document.querySelector('.history-filter-btn[data-period="week"]');
                               if(defaultFilter) defaultFilter.click();
                           }, 50);
                       }
                       if (targetModuleId === 'checklist-module') {
                           renderChecklist();
                       }
                    }
                });
            });
            
            // --- LÓGICA DO MÓDULO DE FATURAMENTO (ABAS E CÁLCULOS) ---
            const faturamentoTabButtons = document.querySelectorAll('.faturamento-tab-button');
            const faturamentoTabContents = document.querySelectorAll('.faturamento-tab-content');
            
            faturamentoTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = `${button.dataset.tab}-tab`;
                    faturamentoTabButtons.forEach(btn => btn.classList.add('text-subtle'));
                    button.classList.remove('text-subtle');
                    faturamentoTabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== targetTabId);
                    });
                    safeCreateIcons();
                });
            });

            // Aba 1: Calculo do Simples (Reestruturado)
            const faturamentoForm = document.getElementById('faturamento-form');
            const calcularFaturamentoBtn = document.getElementById('calcular-faturamento');
            const limparFaturamentoBtn = document.getElementById('limpar-faturamento');

            function calcularTodosMetodos() {
                // Método 1
                const rbt12_m1 = parseLocalFloat(document.getElementById('rbt12_metodo1').value);
                const meses_m1 = parseInt(document.getElementById('meses_metodo1').value) || 12;
                document.getElementById('resultado1').textContent = formatCurrency(meses_m1 > 0 ? rbt12_m1 / meses_m1 : 0);

                // Método 2
                const rpa_m2 = parseLocalFloat(document.getElementById('rpa_metodo2').value);
                const rbt12_m2 = parseLocalFloat(document.getElementById('rbt12_metodo2').value);
                const mesAnterior_m2 = parseLocalFloat(document.getElementById('mes_anterior_metodo2').value);
                document.getElementById('resultado2').textContent = formatCurrency(((rbt12_m2 + rpa_m2) - mesAnterior_m2) / 12);

                // Método 3
                const rpa_m3 = parseLocalFloat(document.getElementById('rpa_metodo3').value);
                const rbt12_m3 = parseLocalFloat(document.getElementById('rbt12_metodo3').value);
                const numMeses_m3 = parseInt(document.getElementById('num_meses_metodo3').value) || 0;
                document.getElementById('resultado3').textContent = formatCurrency(numMeses_m3 > 0 ? (rpa_m3 + rbt12_m3) / numMeses_m3 : 0);
            }

            calcularFaturamentoBtn.addEventListener('click', calcularTodosMetodos);

            limparFaturamentoBtn.addEventListener('click', () => {
                faturamentoForm.reset();
                document.getElementById('meses_metodo1').value = '12';
                document.getElementById('resultado1').textContent = formatCurrency(0);
                document.getElementById('resultado2').textContent = formatCurrency(0);
                document.getElementById('resultado3').textContent = formatCurrency(0);
            });


            // Aba 2: Rel. Faturamento
            const relFaturamentoInputsContainer = document.getElementById('rel-faturamento-inputs');
            for (let i = 1; i <= 12; i++) {
                relFaturamentoInputsContainer.innerHTML += `
                    <div class="flex items-center gap-2">
                        <label for="rel-mes-${i}" class="w-20 text-sm font-medium">Mês ${i}</label>
                        <input type="text" inputmode="decimal" id="rel-mes-${i}" placeholder="R$ 0,00" class="rel-faturamento-input w-full p-2 rounded-xl neumorphic-inset focus:outline-none text-sm">
                    </div>
                `;
            }
            const relFaturamentoInputs = document.querySelectorAll('.rel-faturamento-input');
            const relFaturamentoDivisorInput = document.getElementById('rel-faturamento-divisor');

            const calcularRelFaturamento = () => {
                let total = 0;
                relFaturamentoInputs.forEach(input => {
                    total += parseLocalFloat(input.value);
                });

                const divisor = parseInt(relFaturamentoDivisorInput.value) || 12;

                document.getElementById('rel-faturamento-renda-12-meses').textContent = formatCurrency(total);
                document.getElementById('rel-faturamento-renda-mensal').textContent = formatCurrency(divisor > 0 ? total / divisor : 0);
            };

            relFaturamentoInputs.forEach(input => input.addEventListener('input', calcularRelFaturamento));
            if (relFaturamentoDivisorInput) {
                relFaturamentoDivisorInput.addEventListener('input', calcularRelFaturamento);
            }

            document.getElementById('rel-faturamento-limpar').addEventListener('click', () => {
                relFaturamentoInputs.forEach(input => input.value = '');
                if (relFaturamentoDivisorInput) {
                    relFaturamentoDivisorInput.value = '';
                }
                calcularRelFaturamento();
            });

            // Aba 3: Semoventes (Atualizado com a nova calculadora)
            const semoventesTbody = document.getElementById('semoventes-tbody');
            const semoventesData = [
                'Matrizes (+ 36 meses)', 'Touros', 'Bois (+ 36 meses)', 'Novilhas (25 a 36 meses)',
                'Novilhos (25 a 36 meses)', 'Novilhas (13 a 24 meses)', 'Novilhos (13 a 24 meses)',
                'Bezerras/terneiras até 12 meses', 'Bezerros/terneiros até 12 meses'
            ];
            semoventesTbody.innerHTML = ''; // Limpa o conteúdo antigo
            semoventesData.forEach((desc, index) => {
                semoventesTbody.innerHTML += `
                    <tr class="border-b border-slate-300 dark:border-slate-700">
                        <td class="p-2">${desc}</td>
                        <td class="p-2"><input type="number" id="semovente-qtd-${index}" class="semovente-input w-20 p-2 rounded-xl neumorphic-inset focus:outline-none text-sm" placeholder="0"></td>
                        <td class="p-2"><input type="text" inputmode="decimal" id="semovente-valor-${index}" class="semovente-input w-32 p-2 rounded-xl neumorphic-inset focus:outline-none text-sm" placeholder="R$ 0,00"></td>
                        <td class="p-2 font-semibold" id="semovente-total-${index}">R$ 0,00</td>
                    </tr>
                `;
            });
            const semoventeInputs = document.querySelectorAll('.semovente-input');
            const calcularSemoventes = () => {
                let grandTotalAnual = 0;
                let grandTotalQtd = 0;
                semoventesData.forEach((_, index) => {
                    const qtd = parseInt(document.getElementById(`semovente-qtd-${index}`).value) || 0;
                    const valor = parseLocalFloat(document.getElementById(`semovente-valor-${index}`).value);
                    const total = qtd * valor;
                    document.getElementById(`semovente-total-${index}`).textContent = formatCurrency(total);
                    grandTotalAnual += total;
                    grandTotalQtd += qtd;
                });
                document.getElementById('semoventes-qtd-total').textContent = grandTotalQtd;
                document.getElementById('semoventes-renda-anual').textContent = formatCurrency(grandTotalAnual);
                document.getElementById('semoventes-renda-mensal').textContent = formatCurrency(grandTotalAnual / 12);
            };
            semoventeInputs.forEach(input => input.addEventListener('input', calcularSemoventes));
            document.getElementById('semoventes-limpar').addEventListener('click', () => {
                semoventeInputs.forEach(input => input.value = '');
                calcularSemoventes();
            });

            // Lógica para a nova calculadora IRPF na sua própria aba
            const irpfReceitaBrutaInput = document.getElementById('irpf-receita-bruta');
            const irpfVendasInput = document.getElementById('irpf-vendas');
            const irpfEstoqueFinalInput = document.getElementById('irpf-estoque-final');
            const irpfResultadoValor = document.getElementById('irpf-resultado-valor');
            const irpfLimparBtn = document.getElementById('irpf-limpar');

            const calcularIrpfSemoventes = () => {
                const receitaBruta = parseLocalFloat(irpfReceitaBrutaInput.value);
                const vendas = parseInt(irpfVendasInput.value) || 0;
                const estoqueFinal = parseInt(irpfEstoqueFinalInput.value) || 0;

                let resultado = 0;
                if (vendas > 0) {
                    resultado = (receitaBruta / vendas) * estoqueFinal;
                }
                
                irpfResultadoValor.textContent = formatCurrency(resultado);
            };

            [irpfReceitaBrutaInput, irpfVendasInput, irpfEstoqueFinalInput].forEach(input => {
                input.addEventListener('input', calcularIrpfSemoventes);
            });

            irpfLimparBtn.addEventListener('click', () => {
                irpfReceitaBrutaInput.value = '';
                irpfVendasInput.value = '';
                irpfEstoqueFinalInput.value = '';
                calcularIrpfSemoventes();
            });


            // Aba 4: NF's
            const nfsGrid = document.getElementById('nfs-grid');
            nfsGrid.innerHTML = ''; // Limpa para evitar duplicatas
            for (let i = 1; i <= 50; i++) {
                nfsGrid.innerHTML += `
                    <div class="flex items-center gap-2">
                        <label for="nf-${i}" class="text-sm font-medium w-12"> ${i}</label>
                        <input type="text" inputmode="decimal" id="nf-${i}" class="nf-input w-full p-2 rounded-xl neumorphic-inset focus:outline-none text-sm" placeholder="0,00">
                    </div>
                `;
            }
            const nfInputs = document.querySelectorAll('.nf-input');
            const nfsPropriedadeInput = document.getElementById('nfs-propriedade');
            const calcularNFs = () => {
                let total = 0;
                nfInputs.forEach(input => {
                    total += parseLocalFloat(input.value);
                });
                const propriedade = parseLocalFloat(nfsPropriedadeInput.value) / 100;
                const rendaAnual = total * (propriedade > 0 ? propriedade : 1);
                document.getElementById('nfs-renda-anual').textContent = formatCurrency(rendaAnual);
                document.getElementById('nfs-renda-mensal').textContent = formatCurrency(rendaAnual / 12);
            };
            nfInputs.forEach(input => input.addEventListener('input', calcularNFs));
            nfsPropriedadeInput.addEventListener('input', calcularNFs);
            document.getElementById('nfs-limpar').addEventListener('click', () => {
                nfInputs.forEach(input => input.value = '');
                nfsPropriedadeInput.value = '100';
                calcularNFs();
            });

            // Aba 5: Porcentagem (Antiga Quotas) - Lógica da Calculadora de Quotas
            const quotasCalcInputs = document.querySelectorAll('#calculadora-quotas-container input');
            const calcularQuotas = () => {
                // Bloco 1: Calcular %
                const valorTotal1 = parseLocalFloat(document.getElementById('quotas-valor-total-empresa-1').value);
                const valorAssociado1 = parseLocalFloat(document.getElementById('quotas-valor-associado-1').value);
                let percentual = 0;
                if (valorTotal1 > 0) {
                    percentual = (valorAssociado1 / valorTotal1) * 100;
                }
                document.getElementById('quotas-percentual-resultado').textContent = percentual.toFixed(2).replace('.', ',') + '%';

                // Bloco 2: Calcular Valor
                const valorTotal2 = parseLocalFloat(document.getElementById('quotas-valor-total-empresa-2').value);
                const percentualAssociado2 = parseLocalFloat(document.getElementById('quotas-percentual-associado-2').value);
                const valorMonetario = valorTotal2 * (percentualAssociado2 / 100);
                document.getElementById('quotas-valor-resultado').textContent = formatCurrency(valorMonetario);
            };
            quotasCalcInputs.forEach(input => input.addEventListener('input', calcularQuotas));
            
            // --- LÓGICA DA ABA PORCENTAGEM (NOVA) ---
            const porcentagemTab = document.getElementById('porcentagem-tab');
            if (porcentagemTab) {
                const calcButtons = porcentagemTab.querySelectorAll('.porcentagem-calc-button');
                const calcContainers = porcentagemTab.querySelectorAll('.porcentagem-calc-container');
                const limparBtn = document.getElementById('porcentagem-limpar-btn');

                calcButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetId = button.dataset.target;

                        calcContainers.forEach(container => container.classList.add('hidden'));
                        const targetContainer = document.getElementById(targetId);
                        if (targetContainer) targetContainer.classList.remove('hidden');

                        calcButtons.forEach(btn => {
                            btn.classList.remove('neumorphic-inset');
                            btn.classList.add('neumorphic-outset-sm');
                        });
                        button.classList.add('neumorphic-inset');
                        button.classList.remove('neumorphic-outset-sm');
                    });
                });

                if(limparBtn) {
                    limparBtn.addEventListener('click', () => {
                        const activeCalc = document.querySelector('.porcentagem-calc-container:not(.hidden)');
                        if (!activeCalc) return;

                        if(activeCalc.id === 'calculadora-quotas-container') {
                            document.getElementById('quotas-valor-total-empresa-1').value = '';
                            document.getElementById('quotas-valor-associado-1').value = '';
                            document.getElementById('quotas-valor-total-empresa-2').value = '';
                            document.getElementById('quotas-percentual-associado-2').value = '';
                            calcularQuotas();
                        } else if (activeCalc.id === 'calculadora-produtor-container') {
                            document.getElementById('produtor-renda-agro').value = '';
                            document.getElementById('produtor-renda-nao-agro').value = '';
                            document.getElementById('produtor-possui-caf').checked = false;
                            calcularProdutor();
                        }
                    });
                }
            }

            // --- LÓGICA DA CALCULADORA DE PRODUTOR (ATUALIZADA) ---
            const produtorRendaAgroInput = document.getElementById('produtor-renda-agro');
            const produtorRendaNaoAgroInput = document.getElementById('produtor-renda-nao-agro');
            const produtorCafCheckbox = document.getElementById('produtor-possui-caf');
            const produtorAlertaCaf = document.getElementById('produtor-alerta-caf');
            
            const calcularProdutor = () => {
                if (!produtorRendaAgroInput) return;

                const rendaAgro = parseLocalFloat(produtorRendaAgroInput.value);
                const rendaNaoAgro = parseLocalFloat(produtorRendaNaoAgroInput.value);
                const possuiCaf = produtorCafCheckbox.checked;
                
                const total = rendaAgro + rendaNaoAgro;
                const percAgro = total > 0 ? (rendaAgro / total) * 100 : 0;
                const percNaoAgro = total > 0 ? (rendaNaoAgro / total) * 100 : 0;

                let classificacao = '-';
                let mostrarAlerta = false;

                if (total > 0) {
                    if (percNaoAgro > 20) {
                        classificacao = 'Grande Produtor';
                    } else { // percAgro is >= 80%
                        if (rendaAgro <= 500000 || possuiCaf) {
                            classificacao = 'Pequeno Produtor';
                            if (rendaAgro <= 500000 && !possuiCaf) {
                                mostrarAlerta = true;
                            }
                        } else if (rendaAgro <= 3500000) {
                            classificacao = 'Médio Produtor';
                        } else {
                            classificacao = 'Grande Produtor';
                        }
                    }
                }

                document.getElementById('produtor-renda-total').textContent = formatCurrency(total);
                document.getElementById('produtor-porcentagens').textContent = `${percAgro.toFixed(2).replace('.', ',')}% / ${percNaoAgro.toFixed(2).replace('.', ',')}%`;
                document.getElementById('produtor-classificacao').textContent = classificacao;

                if(mostrarAlerta) {
                    produtorAlertaCaf.textContent = 'Atenção: Anexar CAF, pois o produtor é de pequeno porte.';
                    produtorAlertaCaf.classList.remove('hidden');
                } else {
                    produtorAlertaCaf.classList.add('hidden');
                }
            };

            if (produtorRendaAgroInput && produtorRendaNaoAgroInput && produtorCafCheckbox) {
                [produtorRendaAgroInput, produtorRendaNaoAgroInput, produtorCafCheckbox].forEach(el => {
                    el.addEventListener('input', calcularProdutor);
                });
            }

            // Aba 6: FCPR
            const fcprInputsContainer = document.getElementById('fcpr-inputs');
            fcprInputsContainer.innerHTML = ''; // Limpa para evitar duplicatas
            for (let i = 1; i <= 10; i++) {
                fcprInputsContainer.innerHTML += `
                    <div class="flex items-center gap-2">
                        <label for="fcpr-renda-${i}" class="w-24 text-sm font-medium">Renda ${i}</label>
                        <input type="text" inputmode="decimal" id="fcpr-renda-${i}" placeholder="R$ 0,00" class="fcpr-input w-full p-2 rounded-xl neumorphic-inset focus:outline-none text-sm">
                    </div>
                `;
            }
            const fcprInputs = document.querySelectorAll('.fcpr-input');
            const fcprPercentualInput = document.getElementById('fcpr-percentual');
            const fcprMesesInput = document.getElementById('fcpr-meses');
            const calcularFCPR = () => {
                let totalRendas = 0;
                fcprInputs.forEach(input => {
                    totalRendas += parseLocalFloat(input.value);
                });
                const percentual = parseLocalFloat(fcprPercentualInput.value) / 100;
                const meses = parseInt(fcprMesesInput.value) || 12;
                const rendaAnual = totalRendas * (percentual > 0 ? percentual : 1);
                document.getElementById('fcpr-renda-anual').textContent = formatCurrency(rendaAnual);
                document.getElementById('fcpr-renda-mensal').textContent = formatCurrency(meses > 0 ? rendaAnual / meses : 0);
            };
            fcprInputs.forEach(input => input.addEventListener('input', calcularFCPR));
            fcprPercentualInput.addEventListener('input', calcularFCPR);
            fcprMesesInput.addEventListener('input', calcularFCPR);
            document.getElementById('fcpr-limpar').addEventListener('click', () => {
                fcprInputs.forEach(input => input.value = '');
                fcprPercentualInput.value = '100';
                fcprMesesInput.value = '12';
                calcularFCPR();
            });

            // Aba 7: Calculadora de Datas
            const calcularDatasBtn = document.getElementById('calcular-datas');
            const limparDatasBtn = document.getElementById('limpar-datas');
            const dataInicioInput = document.getElementById('data-inicio');
            const dataFimInput = document.getElementById('data-fim');
            const resultadoDatasDiv = document.getElementById('resultado-datas');

            calcularDatasBtn.addEventListener('click', () => {
                const dataInicio = dataInicioInput.value;
                const dataFim = dataFimInput.value;

                if (!dataInicio || !dataFim) {
                    resultadoDatasDiv.innerHTML = `<p class="text-red-500 font-semibold">Por favor, selecione as duas datas.</p>`;
                    resultadoDatasDiv.classList.remove('hidden');
                    return;
                }

                // Adiciona 'T00:00:00' para tratar as datas como local e evitar problemas de fuso horário
                const start = new Date(dataInicio + 'T00:00:00');
                const end = new Date(dataFim + 'T00:00:00');

                if (start > end) {
                    resultadoDatasDiv.innerHTML = `<p class="text-red-500 font-semibold">A data de início não pode ser posterior à data final.</p>`;
                    resultadoDatasDiv.classList.remove('hidden');
                    return;
                }

                let anos = end.getFullYear() - start.getFullYear();
                let meses = end.getMonth() - start.getMonth();
                let dias = end.getDate() - start.getDate();

                if (dias < 0) {
                    meses--;
                    // Pega o último dia do mês anterior à data final para corrigir os dias
                    const ultimoDiaMesAnterior = new Date(end.getFullYear(), end.getMonth(), 0).getDate();
                    dias += ultimoDiaMesAnterior;
                }

                if (meses < 0) {
                    anos--;
                    meses += 12;
                }
                
                // O cálculo de dias corridos precisa incluir o dia inicial
                const diffTime = Math.abs(end - start);
                const totalDias = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;

                let resultadoTexto = [];
                if (anos > 0) resultadoTexto.push(`${anos} ano${anos > 1 ? 's' : ''}`);
                if (meses > 0) resultadoTexto.push(`${meses} ${meses > 1 ? 'meses' : 'mês'}`);
                if (dias > 0 || (anos === 0 && meses === 0)) resultadoTexto.push(`${dias} dia${dias > 1 ? 's' : ''}`);
                
                // Caso as datas sejam as mesmas, o resultado é 1 dia
                if (start.getTime() === end.getTime()) {
                    resultadoTexto = ["1 dia"];
                }


                resultadoDatasDiv.innerHTML = `
                    <div class="text-center">
                        <p class="text-sm text-subtle uppercase tracking-wide">Período Detalhado</p>
                        <p class="text-2xl font-bold text-accent mt-1">${resultadoTexto.join(', ')}</p>
                        <p class="text-sm text-subtle mt-2">(Total de ${totalDias} dias corridos)</p>
                    </div>
                `;
                resultadoDatasDiv.classList.remove('hidden');
            });
            
            limparDatasBtn.addEventListener('click', () => {
                dataInicioInput.value = '';
                dataFimInput.value = '';
                resultadoDatasDiv.classList.add('hidden');
                resultadoDatasDiv.innerHTML = '';
            });


            // --- LÓGICA DO MÓDULO RENDA PF (ABAS E CÁLCULOS) ---
            const rendaPfTabButtons = document.querySelectorAll('.renda-pf-tab-button');
            const rendaPfTabContents = document.querySelectorAll('.renda-pf-tab-content');
            rendaPfTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = `${button.dataset.tab}-tab`;
                    rendaPfTabButtons.forEach(btn => btn.classList.add('text-subtle'));
                    button.classList.remove('text-subtle');
                    rendaPfTabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== targetTabId);
                    });
                });
            });

            // Aba 1: Calculadora Renda PF (Completa)
            const rendaPfDisplayElement = document.getElementById('renda-pf-display');
            const rendaPfHistoryElement = document.getElementById('renda-pf-history');
            const calculatorButtonsContainer = document.querySelector('#calculadora-tab');

            class Calculator {
                constructor(displayElement, historyElement) {
                    this.displayElement = displayElement;
                    this.historyElement = historyElement;
                    this.clear();
                }

                clear() {
                    this.currentOperand = '0';
                    this.previousOperand = '';
                    this.operation = undefined;
                    this.historyElement.innerText = '';
                    this.updateDisplay();
                }
                
                delete() {
                    this.currentOperand = String(this.currentOperand).slice(0, -1);
                    if (this.currentOperand === '') {
                        this.currentOperand = '0';
                    }
                }

                appendNumber(number) {
                    if (this.historyElement.innerText.includes('=')) {
                        this.clear();
                    }
                    if (number === '.' && this.currentOperand.includes('.')) return;
                    if (this.currentOperand.length > 15) return;
                    
                    if (this.currentOperand === '0' && number !== '.') {
                        this.currentOperand = number;
                    } else {
                        this.currentOperand = this.currentOperand.toString() + number.toString();
                    }
                }

                chooseOperation(operation) {
                    if (this.currentOperand === '' && this.previousOperand === '') return;
                    if (this.currentOperand === '' && this.previousOperand !== '') {
                        this.operation = operation;
                        this.updateDisplay();
                        return;
                    }
                    if (this.previousOperand !== '') {
                        this.compute();
                    }
                    this.operation = operation;
                    this.previousOperand = this.currentOperand;
                    this.currentOperand = '';
                }

                compute() {
                    let computation;
                    const prev = parseFloat(this.previousOperand);
                    const current = parseFloat(this.currentOperand);
                    if (isNaN(prev) || isNaN(current)) return;
                    
                    const historyText = `${this.formatDisplay(this.previousOperand)} ${this.operation.replace('*','×').replace('/','÷')} ${this.formatDisplay(this.currentOperand)} =`;

                    switch (this.operation) {
                        case '+': computation = prev + current; break;
                        case '-': computation = prev - current; break;
                        case '*': computation = prev * current; break;
                        case '/': computation = prev / current; break;
                        default: return;
                    }
                    this.currentOperand = computation.toString();
                    this.operation = undefined;
                    this.previousOperand = '';
                    this.historyElement.innerText = historyText;
                }
                
                handleSpecial(op) {
                    if (this.currentOperand === '') return;
                    const current = parseFloat(this.currentOperand);
                    if (isNaN(current)) return;
                    let computation;
                    let historyText;
                    if (op === '*12') {
                        computation = current * 12;
                        historyText = `${this.formatDisplay(this.currentOperand)} × 12 =`;
                    } else if (op === '/12') {
                        computation = current / 12;
                        historyText = `${this.formatDisplay(this.currentOperand)} ÷ 12 =`;
                    } else {
                        return;
                    }
                    this.currentOperand = computation.toString();
                    this.operation = undefined;
                    this.previousOperand = '';
                    this.historyElement.innerText = historyText;
                    this.updateDisplay();
                }

                formatDisplay(numberStr) {
                    if (numberStr === '' || numberStr === null || numberStr === undefined) return '';
                    const stringNumber = numberStr.toString();
                    const [integerPart, decimalPart] = stringNumber.split('.');
                    
                    let integerDisplay;
                    if (integerPart === '' || isNaN(parseFloat(integerPart))) {
                       integerDisplay = '0';
                    } else {
                       integerDisplay = parseFloat(integerPart).toLocaleString('pt-BR');
                    }
                    
                    if (decimalPart != null) {
                        return `${integerDisplay},${decimalPart}`;
                    } else {
                        if (stringNumber.endsWith('.')) {
                            return `${integerDisplay},`;
                        }
                        return integerDisplay;
                    }
                }

                updateDisplay() {
                    this.displayElement.value = this.formatDisplay(this.currentOperand);
                    if (this.operation != null) {
                        this.historyElement.innerText = `${this.formatDisplay(this.previousOperand)} ${this.operation.replace('*','×').replace('/','÷')}`;
                    }
                }
            }

            const calculator = new Calculator(rendaPfDisplayElement, rendaPfHistoryElement);

            calculatorButtonsContainer.addEventListener('click', (e) => {
                const button = e.target.closest('.calculator-btn');
                if (!button) return;

                if (button.dataset.number !== undefined) {
                    calculator.appendNumber(button.dataset.number);
                    calculator.updateDisplay();
                }
                if (button.dataset.operator !== undefined) {
                    calculator.chooseOperation(button.dataset.operator);
                    calculator.updateDisplay();
                }
                if (button.dataset.action === 'equals') {
                    calculator.compute();
                    calculator.updateDisplay();
                }
                if (button.dataset.action === 'clear') {
                    calculator.clear();
                }
                if (button.dataset.action === 'special') {
                    calculator.handleSpecial(button.dataset.value);
                }
            });
            
            document.addEventListener('keydown', (e) => {
                if (currentModuleId !== 'renda-pf-module' || document.querySelector('#calculadora-tab').classList.contains('hidden')) {
                    return;
                }

                const key = e.key;
                
                if (key >= '0' && key <= '9') {
                    e.preventDefault();
                    calculator.appendNumber(key);
                    calculator.updateDisplay();
                } else if (key === ',' || key === '.') {
                    e.preventDefault();
                    calculator.appendNumber('.');
                    calculator.updateDisplay();
                } else if (key === '+' || key === '-' || key === '*' || key === '/') {
                    e.preventDefault();
                    calculator.chooseOperation(key);
                    calculator.updateDisplay();
                } else if (key === 'Enter' || key === '=') {
                    e.preventDefault();
                    calculator.compute();
                    calculator.updateDisplay();
                } else if (key === 'Backspace') {
                    e.preventDefault();
                    calculator.delete();
                    calculator.updateDisplay();
                } else if (key === 'Escape' || key === 'Delete') {
                    e.preventDefault();
                    calculator.clear();
                }
            });

            document.addEventListener('paste', (e) => {
                if (currentModuleId !== 'renda-pf-module' || document.querySelector('#calculadora-tab').classList.contains('hidden')) {
                    return;
                }
                
                e.preventDefault();
                const pasteData = (e.clipboardData || window.clipboardData).getData('text');
                
                let sanitizedData = pasteData.replace(/[^0-9,.]/g, '');
                const lastComma = sanitizedData.lastIndexOf(',');
                const lastDot = sanitizedData.lastIndexOf('.');

                if (lastComma > lastDot) {
                    // Formato brasileiro: 1.234,56 -> 1234.56
                    sanitizedData = sanitizedData.replace(/\./g, '').replace(',', '.');
                } else if (lastDot > lastComma) {
                    // Formato americano: 1,234.56 -> 1234.56
                    sanitizedData = sanitizedData.replace(/,/g, '');
                }
                
                if (!isNaN(parseFloat(sanitizedData)) && isFinite(sanitizedData)) {
                    if (calculator.historyElement.innerText.includes('=')) {
                        calculator.clear();
                    }
                    calculator.currentOperand = sanitizedData;
                    calculator.updateDisplay();
                }
            });


            // Aba 2: Média Holerites
            const mediaInputs = document.querySelectorAll('.media-holerite-input');
            const limparMediaBtn = document.getElementById('limpar_media');
            function calcularMedia() {
                let total = 0;
                let count = 0;
                mediaInputs.forEach(inp => {
                    const val = parseLocalFloat(inp.value);
                    if (!isNaN(val) && val > 0) {
                        total += val;
                        count++;
                    }
                });
                const media = count > 0 ? total / count : 0;
                document.getElementById('media_resultado').textContent = formatCurrency(media);
            }
            mediaInputs.forEach(input => input.addEventListener('input', calcularMedia));
            limparMediaBtn.addEventListener('click', () => {
                mediaInputs.forEach(input => input.value = '');
                calcularMedia();
            });

            // Aba 3: Soma de Valores
            const somaInputs = document.querySelectorAll('.soma-valor-input');
            const subInputs = document.querySelectorAll('.sub-valor-input');
            const limparSomaBtn = document.getElementById('limpar_soma');
            function calcularSomaTotal() {
                let totalSoma = 0;
                somaInputs.forEach(inp => totalSoma += parseLocalFloat(inp.value));
                let totalSub = 0;
                subInputs.forEach(inp => totalSub += parseLocalFloat(inp.value));
                const somaFinal = totalSoma - totalSub;
                document.getElementById('soma_total_resultado').textContent = formatCurrency(somaFinal);
                document.getElementById('soma_div12_resultado').textContent = formatCurrency(somaFinal / 12);
            }
            somaInputs.forEach(input => input.addEventListener('input', calcularSomaTotal));
            subInputs.forEach(input => input.addEventListener('input', calcularSomaTotal));
            limparSomaBtn.addEventListener('click', () => {
                somaInputs.forEach(input => input.value = '');
                subInputs.forEach(input => input.value = '');
                calcularSomaTotal();
            });

            // --- LÓGICA DO MÓDULO DE REGRAS (ABAS E FILTRO) ---
            const regrasTbody = document.getElementById('regras-irpf-tbody');
            
            function renderRegrasTable() {
                if(typeof regrasData === 'undefined' || !regrasTbody) return;
                regrasTbody.innerHTML = '';
                regrasData.forEach(regra => {
                    const row = `
                        <tr class="border-b border-slate-300 dark:border-slate-700">
                            <td class="p-2 font-semibold">${regra.item}</td>
                            <td class="p-2">${regra.ref}</td>
                            <td class="p-2">${regra.type.join(', ')}</td>
                        </tr>
                    `;
                    regrasTbody.innerHTML += row;
                });
            }

            // --- LÓGICA DO MÓDULO DE CONSULTA CNPJ ---
            const cnpjInput = document.getElementById('cnpj-input');
            const consultarCnpjBtn = document.getElementById('consultar-cnpj');
            const limparCnpjBtn = document.getElementById('limpar-cnpj');
            const cnpjResultsContainer = document.getElementById('cnpj-results-container');

            cnpjInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
                e.target.value = value.slice(0, 18);
            });

            consultarCnpjBtn.addEventListener('click', async () => {
                const cnpj = cnpjInput.value.replace(/\D/g, '');
                if (cnpj.length !== 14) {
                    cnpjResultsContainer.innerHTML = `<div class="p-4 rounded-2xl neumorphic-inset text-center text-red-500">Por favor, insira um CNPJ válido com 14 dígitos.</div>`;
                    return;
                }

                consultarCnpjBtn.disabled = true;
                consultarCnpjBtn.innerHTML = `
                    <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Consultando...
                `;

                try {
                    const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                    
                    if (response.status === 404) {
                       throw new Error("CNPJ não encontrado na base de dados.");
                    }
                    if (!response.ok) {
                        throw new Error(`Erro na API: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    displayCnpjResults(data);

                } catch (error) {
                    cnpjResultsContainer.innerHTML = `<div class="p-4 rounded-2xl neumorphic-inset text-center text-red-500"><strong>Falha na consulta:</strong> ${error.message}</div>`;
                } finally {
                    consultarCnpjBtn.disabled = false;
                    consultarCnpjBtn.innerHTML = `
                        <i data-lucide="search" class="w-5 h-5"></i> Consultar
                    `;
                    safeCreateIcons();
                }
            });

            // --- FUNÇÃO ATUALIZADA PARA EXIBIR RESULTADOS DO CNPJ COM HISTÓRICO FIXO ---
            function displayCnpjResults(data) {
                const isSimples = data.opcao_pelo_simples ? 'Sim' : 'Não';
                const isSimei = data.opcao_pelo_mei ? 'Sim' : 'Não';
                const porteEmpresa = data.porte || 'Não informado';
                const dataAbertura = data.data_inicio_atividade;
                const nomeEmpresa = data.razao_social || 'Não informado';

                // --- LÓGICA DO HISTÓRICO SIMPLIFICADO DO SIMPLES NACIONAL ---
                let conteudoHistorico = '';
                let avisoExclusao = '';

                if (data.opcao_pelo_simples !== null && data.data_opcao_pelo_simples) {
                    if (data.opcao_pelo_simples) {
                        conteudoHistorico = `<p class="text-sm">Optante desde: <strong class="text-green-600 dark:text-green-500">${formatDate(data.data_opcao_pelo_simples)}</strong></p>`;
                    } else {
                        if (data.data_exclusao_do_simples) {
                            conteudoHistorico = `<p class="text-sm">Esteve no Simples de <strong class="text-subtle">${formatDate(data.data_opcao_pelo_simples)}</strong> até <strong class="text-red-600 dark:text-red-500">${formatDate(data.data_exclusao_do_simples)}</strong>.</p>`;
                            const anoExclusao = new Date(data.data_exclusao_do_simples).getFullYear();
                            if (anoExclusao === 2024 || anoExclusao === 2025) {
                                avisoExclusao = `
                                    <div class="mt-3 p-3 border-l-4 border-yellow-500 bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-300 rounded-r-lg">
                                        <h4 class="font-bold">Atenção!</h4>
                                        <p class="text-sm">A empresa foi desenquadrada em ${anoExclusao}. A análise de faturamento deve considerar o regime correspondente (Lucro Presumido/Real) a partir desta data.</p>
                                    </div>
                                `;
                            }
                        } else {
                           conteudoHistorico = `<p class="text-sm">A empresa não é optante, mas não há data de exclusão registrada.</p>`;
                        }
                    }
                } else {
                     conteudoHistorico = `<p class="text-sm text-subtle">Não há informações sobre o histórico do Simples Nacional para esta empresa.</p>`;
                }
                
                const historicoSimplesHtml = `
                    <div class="p-4 rounded-2xl neumorphic-inset">
                        <p class="text-sm text-subtle uppercase tracking-wide mb-2">Histórico do Simples Nacional</p>
                        ${conteudoHistorico}
                        ${avisoExclusao}
                    </div>
                `;
                // --- FIM DA LÓGICA DO HISTÓRICO SIMPLIFICADO ---

                let sociosHtml = '<p class="text-subtle">Nenhum sócio encontrado.</p>';
                if (data.qsa && data.qsa.length > 0) {
                    sociosHtml = `<ul class="list-disc list-inside space-y-1">${data.qsa.map(socio => `<li>${socio.nome_socio} <span class="text-subtle">(${socio.qualificacao_socio})</span></li>`).join('')}</ul>`;
                }

                const rawJsonHtml = `
                    <details class="mt-4">
                        <summary class="cursor-pointer font-semibold text-sm text-subtle">Ver resposta JSON completa</summary>
                        <pre class="mt-2 p-4 rounded-2xl neumorphic-inset text-xs overflow-auto custom-scrollbar"><code>${JSON.stringify(data, null, 2)}</code></pre>
                    </details>
                `;

                cnpjResultsContainer.innerHTML = `
                    <div class="space-y-4 animate-fade-in">
                        <div class="p-4 rounded-2xl neumorphic-inset">
                            <p class="text-sm text-subtle uppercase tracking-wide">Razão Social</p>
                            <p class="text-lg font-bold text-accent mt-1">${nomeEmpresa}</p>
                        </div>
                        <div class="p-4 rounded-2xl neumorphic-inset">
                            <p class="text-sm text-subtle uppercase tracking-wide">Nome Fantasia</p>
                            <p class="font-semibold mt-1">${data.nome_fantasia || 'Não informado'}</p>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Data de Abertura</p>
                                <p class="font-semibold mt-1">${formatDate(dataAbertura)}</p>
                            </div>
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Situação Cadastral</p>
                                <p class="font-bold text-lg ${data.descricao_situacao_cadastral === 'ATIVA' ? 'text-green-500' : 'text-red-500'} mt-1">${data.descricao_situacao_cadastral || 'Não informado'}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Porte da Empresa</p>
                                <p class="font-semibold mt-1">${porteEmpresa}</p>
                            </div>
                             <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Capital Social</p>
                                <p class="font-semibold mt-1">${formatCurrency(data.capital_social)}</p>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Optante Simples</p>
                                <p class="text-lg font-bold ${data.opcao_pelo_simples ? 'text-green-500' : 'text-red-500'} mt-1">${isSimples}</p>
                            </div>
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Optante MEI</p>
                                <p class="text-lg font-bold ${data.opcao_pelo_mei ? 'text-green-500' : 'text-red-500'} mt-1">${isSimei}</p>
                            </div>
                        </div>

                        <!-- Bloco do Histórico Simplificado inserido aqui -->
                        ${historicoSimplesHtml}

                        <div class="p-4 rounded-2xl neumorphic-inset">
                            <p class="text-sm text-subtle uppercase tracking-wide">Atividade Principal (CNAE)</p>
                            <p class="font-semibold mt-1">${data.cnae_fiscal_descricao || 'Não informado'}</p>
                        </div>
                         <div class="p-4 rounded-2xl neumorphic-inset">
                            <p class="text-sm text-subtle uppercase tracking-wide">Endereço</p>
                            <p class="font-semibold mt-1">${data.logradouro || ''}, ${data.numero || ''} - ${data.bairro || ''}, ${data.municipio || ''} - ${data.uf || ''}, CEP: ${data.cep || ''}</p>
                        </div>
                        <div class="p-4 rounded-2xl neumorphic-inset">
                            <p class="text-sm text-subtle uppercase tracking-wide mb-2">Quadro de Sócios e Administradores (QSA)</p>
                            <div class="font-semibold">${sociosHtml}</div>
                        </div>
                        ${rawJsonHtml}
                    </div>
                `;
                safeCreateIcons();
            };
            // --- FIM DA FUNÇÃO ATUALIZADA ---

            limparCnpjBtn.addEventListener('click', () => {
                cnpjInput.value = '';
                cnpjResultsContainer.innerHTML = '';
            });

            // --- LÓGICA DO MÓDULO DE PARECERES ---
            const searchInput = document.getElementById('searchInput');
            const parecerCategoryFilter = document.getElementById('parecer-category-filter');
            const pareceresContainer = document.getElementById('pareceresContainer');

            function populateParecerFilter() {
                if(typeof pareceresDataCorrigido === 'undefined' || !parecerCategoryFilter) return;
                parecerCategoryFilter.innerHTML = '<option value="all">Todas as Categorias</option>';
                for (const mainCategory in pareceresDataCorrigido) {
                    parecerCategoryFilter.innerHTML += `<option value="${mainCategory}">${mainCategory}</option>`;
                }
            }

            function renderPareceres(data) {
                pareceresContainer.innerHTML = '';
                let mainContentRendered = false;

                for (const mainCategory in data) {
                    const subCategories = data[mainCategory];
                    let mainCategoryHtml = `<h3 class="text-2xl font-bold mb-4 border-b-2 border-slate-300 dark:border-slate-600 pb-2">${mainCategory}</h3>`;
                    let contentHtml = '<div class="space-y-4">';
                    let hasSubResults = false;

                    function createParecerHTML(key, value, button) {
                        hasSubResults = true;
                        mainContentRendered = true;
                        const fullParecerText = `${key}: ${value}`;
                        return `
                            <div class="p-4 rounded-2xl neumorphic-inset flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div class="flex-1 min-w-0">
                                    <h5 class="font-semibold mb-1">${key}</h5>
                                    <p class="text-sm whitespace-normal break-words text-subtle">${value}</p>
                                </div>
                                <div class="flex-shrink-0 flex items-center self-start sm:self-center">
                                    <button class="p-2 rounded-2xl neumorphic-outset-sm text-sm font-bold transition duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center gap-2"
                                            onclick="copyParecer(decodeURIComponent('${encodeURIComponent(fullParecerText)}'), this)">
                                        <i data-lucide="copy" class="w-4 h-4"></i> Copiar
                                    </button>
                                </div>
                            </div>
                        `;
                    }

                    for (const subCategoryTitle in subCategories) {
                        const items = subCategories[subCategoryTitle];
                        if (typeof items === 'object' && items !== null) {
                            let subCategoryContent = '';
                            for (const key in items) {
                                subCategoryContent += createParecerHTML(key, items[key]);
                            }
                            if(subCategoryContent) {
                                contentHtml += `<h4 class="text-xl font-semibold mb-3 mt-4">${subCategoryTitle}</h4>` + subCategoryContent;
                            }
                        } else {
                            contentHtml += createParecerHTML(subCategoryTitle, items);
                        }
                    }
                    contentHtml += '</div>';
                    if (hasSubResults) {
                        pareceresContainer.innerHTML += mainCategoryHtml + contentHtml;
                    }
                }

                if (!mainContentRendered) {
                    pareceresContainer.innerHTML = `
                        <div class="text-center text-lg py-8 text-subtle">
                            Nenhum parecer encontrado para a sua pesquisa.
                        </div>
                    `;
                }
                 safeCreateIcons();
            }
            
            function filterPareceres() {
                if(typeof pareceresDataCorrigido === 'undefined' || !pareceresContainer) return;
                
                // Termo de busca normalizado (sem acentos e minúsculo)
                const searchTerm = removeAccents(searchInput.value.toLowerCase());
                const selectedCategory = parecerCategoryFilter.value;
                
                const sourceData = selectedCategory === 'all' 
                    ? pareceresDataCorrigido 
                    : { [selectedCategory]: pareceresDataCorrigido[selectedCategory] };

                const filteredData = {};
                for (const mainCategory in sourceData) {
                    const subCategories = sourceData[mainCategory];
                    const filteredSubCategories = {};
                    let hasMatch = false;
                    for (const subCategoryTitle in subCategories) {
                        const items = subCategories[subCategoryTitle];
                        if (typeof items === 'object' && items !== null) {
                            const filteredItems = {};
                            for(const key in items) {
                                // Normaliza os dados antes de comparar
                                const normalizedKey = removeAccents(key.toLowerCase());
                                const normalizedValue = removeAccents(items[key].toLowerCase());
                                if (normalizedKey.includes(searchTerm) || normalizedValue.includes(searchTerm)) {
                                    filteredItems[key] = items[key];
                                    hasMatch = true;
                                }
                            }
                            if(Object.keys(filteredItems).length > 0) {
                                filteredSubCategories[subCategoryTitle] = filteredItems;
                            }
                        } else {
                            // Normaliza os dados antes de comparar
                            const normalizedSubCategoryTitle = removeAccents(subCategoryTitle.toLowerCase());
                            const normalizedItems = removeAccents(items.toLowerCase());
                            if (normalizedSubCategoryTitle.includes(searchTerm) || normalizedItems.includes(searchTerm)) {
                                filteredSubCategories[subCategoryTitle] = items;
                                hasMatch = true;
                            }
                        }
                    }
                    if (hasMatch) {
                        filteredData[mainCategory] = filteredSubCategories;
                    }
                }
                renderPareceres(filteredData);
            }

            searchInput.addEventListener('input', filterPareceres);
            parecerCategoryFilter.addEventListener('change', filterPareceres);

            // --- LÓGICA DO MÓDULO CONTADOR ---
            const countersGrid = document.getElementById('counters-grid');
            const addCounterBtn = document.getElementById('add-counter-btn');
            const counterTemplate = document.getElementById('counter-template');
            const incrementInput = document.getElementById('increment-by-input');
            const startInput = document.getElementById('counter-start-input');
            const timerToggle = document.getElementById('timer-toggle');
            const resetAllBtn = document.getElementById('contador-reset');
            const finalizarDiaBtn = document.getElementById('finalizar-dia-btn');
            const finalizarDiaFeedback = document.getElementById('finalizar-dia-feedback');

            let counters = [];
            let counterChart = null;
            let historyChart = null;
            const DAILY_HISTORY_KEY = 'apoioBpoDailyHistory';
            const INCREMENT_HISTORY_KEY = 'apoioBpoIncrementHistory';
            const COUNTERS_STATE_KEY = 'apoioBpoCountersState_v3'; // Chave atualizada para nova estrutura

            function saveCountersState() {
                const state = counters.map(c => c.getState());
                localStorage.setItem(COUNTERS_STATE_KEY, JSON.stringify(state));
            }

            function loadCountersState() {
                const savedState = JSON.parse(localStorage.getItem(COUNTERS_STATE_KEY) || 'null');
                countersGrid.innerHTML = ''; 
                counters.forEach(c => c.destroy()); // Limpa timers antigos
                counters = [];

                if (savedState && savedState.length > 0) {
                    savedState.forEach(state => {
                        createCounterInstance(state);
                    });
                } else {
                    // Estado inicial com um contador padrão
                    createCounterInstance({
                        id: Date.now(),
                        title: "Contador Principal",
                        isTimer: false,
                        isStarred: true,
                        value: 0
                    });
                }
                updateCountersLayout();
            }

            function updateCountersLayout() {
                const count = counters.length;
                const cards = countersGrid.querySelectorAll('.counter-card');
                cards.forEach(card => {
                    card.classList.remove('sm:col-span-2', 'sm:row-span-2');
                });
                
                if (count === 1) {
                    cards[0].classList.add('sm:col-span-2', 'sm:row-span-2');
                } else if (count === 2) {
                    cards.forEach(card => card.classList.add('sm:row-span-2'));
                } else if (count === 3) {
                    cards[2].classList.add('sm:col-span-2');
                }
            }
            
            function saveActivityToHistory(type, count) {
                let history = JSON.parse(localStorage.getItem(INCREMENT_HISTORY_KEY) || '[]');
                history.push({
                    timestamp: new Date().toISOString(),
                    type: type,
                    count: count
                });
                localStorage.setItem(INCREMENT_HISTORY_KEY, JSON.stringify(history));
            }

            function updateCounterChart() {
                const chartCanvas = document.getElementById('counter-chart');
                if (!chartCanvas) return;
                const ctx = chartCanvas.getContext('2d');

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const activityHistory = JSON.parse(localStorage.getItem(INCREMENT_HISTORY_KEY) || '[]');

                const todaysActivities = activityHistory
                    .map(item => ({ ...item, timestamp: new Date(item.timestamp) }))
                    .filter(item => item.timestamp >= today);

                const fixedLabels = [];
                for (let i = 6; i <= 19; i++) {
                    fixedLabels.push(`${i.toString().padStart(2, '0')}:00`);
                }
                
                let data = Array(fixedLabels.length).fill(0);

                todaysActivities.forEach(activity => {
                    const hour = activity.timestamp.getHours();
                    const index = hour - 6;
                    if (index >= 0 && index < data.length) {
                        if (activity.type === 'add') {
                            data[index] += activity.count;
                        } else if (activity.type === 'subtract') {
                            data[index] -= activity.count;
                        }
                    }
                });

                const isDarkMode = document.documentElement.classList.contains('dark');
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDarkMode ? '#d1d9e6' : '#5a6474';
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim();

                if (counterChart) {
                    counterChart.data.labels = fixedLabels;
                    counterChart.data.datasets[0].data = data;
                    counterChart.options.scales.x.ticks.color = textColor;
                    counterChart.options.scales.y.ticks.color = textColor;
                    counterChart.options.scales.x.grid.color = gridColor;
                    counterChart.options.scales.y.grid.color = gridColor;
                    counterChart.update();
                } else {
                    counterChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: fixedLabels,
                            datasets: [{
                                label: 'Atividades',
                                data: data,
                                backgroundColor: accentColor,
                                borderRadius: 5,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { 
                                        color: textColor, 
                                        stepSize: 1,
                                        callback: v => (Number.isInteger(v) ? v : null)
                                    },
                                    grid: { color: gridColor }
                                },
                                x: {
                                    ticks: { color: textColor },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
            }
            
            // ==========================================================
            // ===== INÍCIO DA SEÇÃO DO TIMER CORRIGIDA =================
            // ==========================================================
            function createCounterInstance(initialState) {
                const counterElement = counterTemplate.content.cloneNode(true).firstElementChild;
                const { id, title, isTimer, isStarred } = initialState;
                counterElement.dataset.id = id;
                
                // Elementos do DOM
                const titleElement = counterElement.querySelector('.counter-title');
                const display = counterElement.querySelector('.counter-display');
                const plusBtn = counterElement.querySelector('.counter-plus');
                const minusBtn = counterElement.querySelector('.counter-minus');
                const removeBtn = counterElement.querySelector('.remove-counter-btn');
                const starBtn = counterElement.querySelector('.star-btn');
                const playPauseBtn = counterElement.querySelector('.timer-play-pause');
                const resetBtn = counterElement.querySelector('.timer-reset');
                const playPauseIcon = playPauseBtn.querySelector('i');

                // Estado da instância
                let instanceState = { ...initialState };
                let intervalId = null;

                const formatTime = (totalSeconds) => {
                    const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
                    const seconds = (totalSeconds % 60).toString().padStart(2, '0');
                    return `${minutes}:${seconds}`;
                };
                
                const updateDisplay = () => {
                    if (instanceState.isTimer) {
                        display.textContent = formatTime(instanceState.value);
                        playPauseIcon.dataset.lucide = instanceState.isRunning ? 'pause' : 'play';
                    } else {
                        display.textContent = instanceState.value;
                    }
                    safeCreateIcons();
                };

                const startTimer = () => {
                    if (intervalId || !instanceState.isTimer) return; 
                    instanceState.isRunning = true;
                    intervalId = setInterval(() => {
                        if (instanceState.value > 0) {
                            instanceState.value--;
                            updateDisplay();
                            saveCountersState();
                        } else {
                            stopTimer();
                        }
                    }, 1000);
                    updateDisplay();
                    saveCountersState();
                };

                const stopTimer = () => {
                    clearInterval(intervalId);
                    intervalId = null;
                    instanceState.isRunning = false;
                    updateDisplay();
                    saveCountersState();
                };

                const toggleTimer = () => {
                    if (instanceState.isRunning) {
                        stopTimer();
                    } else {
                        startTimer();
                    }
                };
                
                const resetTimer = () => {
                    stopTimer();
                    instanceState.value = instanceState.initialValue;
                    updateDisplay();
                    saveCountersState();
                };

                const removeInstance = () => {
                    stopTimer(); 
                    counterElement.classList.add('animate-fade-out');
                    counterElement.addEventListener('animationend', () => {
                        counterElement.remove();
                        counters = counters.filter(c => c.id !== id);
                        updateCountersLayout();
                        saveCountersState();
                    }, { once: true });
                };
                
                // Configuração inicial
                titleElement.textContent = title;
                starBtn.classList.toggle('active', isStarred);

                if (isTimer) {
                    plusBtn.classList.add('hidden');
                    minusBtn.classList.add('hidden');
                    playPauseBtn.classList.remove('hidden');
                    resetBtn.classList.remove('hidden');
                    display.contentEditable = true;

                    playPauseBtn.addEventListener('click', toggleTimer);
                    resetBtn.addEventListener('click', resetTimer);

                    display.addEventListener('blur', () => {
                        const parts = display.textContent.split(':');
                        let newSeconds = 0;
                        if (parts.length === 2) {
                            newSeconds = (parseInt(parts[0], 10) || 0) * 60 + (parseInt(parts[1], 10) || 0);
                        } else if (parts.length === 1) {
                            newSeconds = (parseInt(parts[0], 10) || 0) * 60;
                        }
                        instanceState.value = newSeconds;
                        instanceState.initialValue = newSeconds;
                        stopTimer();
                        updateDisplay();
                        saveCountersState();
                    });

                    if (instanceState.isRunning) {
                       instanceState.isRunning = false; // Prevent auto-start on load
                       startTimer();
                    }

                } else {
                    plusBtn.addEventListener('click', () => {
                        const change = parseInt(incrementInput.value) || 1;
                        instanceState.value += change;
                        updateDisplay();
                        if (instanceState.isStarred) {
                           saveActivityToHistory('add', change);
                           updateCounterChart();
                        }
                        saveCountersState();
                    });
                    
                    minusBtn.addEventListener('click', () => {
                        const change = parseInt(incrementInput.value) || 1;
                        const originalValue = instanceState.value;
                        const newValue = Math.max(0, originalValue - change);
                        const actualChange = originalValue - newValue;
                        instanceState.value = newValue;
                        updateDisplay();
                        if (instanceState.isStarred && actualChange > 0) {
                            saveActivityToHistory('subtract', actualChange);
                            updateCounterChart();
                        }
                        saveCountersState();
                    });
                }
                
                // Eventos comuns
                starBtn.addEventListener('click', () => {
                    instanceState.isStarred = !instanceState.isStarred;
                    starBtn.classList.toggle('active', instanceState.isStarred);
                    saveCountersState();
                });
                titleElement.addEventListener('blur', () => {
                    instanceState.title = titleElement.textContent;
                    saveCountersState();
                });
                removeBtn.addEventListener('click', removeInstance);
                
                const instance = {
                    id,
                    element: counterElement,
                    destroy: stopTimer,
                    getState: () => instanceState,
                };
                
                counters.push(instance);
                countersGrid.appendChild(counterElement);
                updateDisplay();
                counterElement.classList.add('animate-fade-in');
            }
            // ========================================================
            // ===== FIM DA SEÇÃO DO TIMER CORRIGIDA ================
            // ========================================================


            addCounterBtn.addEventListener('click', () => {
                if (counters.length >= 4) return;
                const isTimer = timerToggle.checked;
                const initialValue = parseInt(startInput.value) || 0;

                const newState = {
                    id: Date.now(),
                    title: isTimer ? `Timer ${counters.length + 1}` : `Contador ${counters.length + 1}`,
                    isTimer: isTimer,
                    isStarred: false,
                    isRunning: false,
                };
                
                if (isTimer) {
                    const seconds = initialValue * 60;
                    newState.value = seconds;
                    newState.initialValue = seconds;
                } else {
                    newState.value = initialValue;
                }

                createCounterInstance(newState);
                updateCountersLayout();
                saveCountersState();
            });
            
            finalizarDiaBtn.addEventListener('click', () => {
                const totalDoDia = counters
                    .filter(c => c.getState().isStarred && !c.getState().isTimer)
                    .reduce((sum, counter) => sum + counter.getState().value, 0);

                if (totalDoDia <= 0) {
                    finalizarDiaFeedback.textContent = "Nenhuma contagem (com estrela) para salvar hoje.";
                    finalizarDiaFeedback.classList.remove('hidden', 'text-green-500');
                    finalizarDiaFeedback.classList.add('text-yellow-500');
                    setTimeout(() => finalizarDiaFeedback.classList.add('hidden'), 3000);
                    return;
                }

                const history = JSON.parse(localStorage.getItem(DAILY_HISTORY_KEY) || '[]');
                const today = new Date().toISOString().slice(0, 10);

                const todayEntryIndex = history.findIndex(entry => entry.date === today);

                if (todayEntryIndex > -1) {
                    history[todayEntryIndex].count += totalDoDia;
                } else {
                    history.push({ date: today, count: totalDoDia });
                }

                localStorage.setItem(DAILY_HISTORY_KEY, JSON.stringify(history));
                
                localStorage.removeItem(INCREMENT_HISTORY_KEY);
                updateCounterChart();

                finalizarDiaFeedback.textContent = `Total de ${totalDoDia} salvo no histórico de hoje! Contadores resetados.`;
                finalizarDiaFeedback.classList.remove('hidden', 'text-yellow-500');
                finalizarDiaFeedback.classList.add('text-green-500');
                setTimeout(() => finalizarDiaFeedback.classList.add('hidden'), 4000);

                loadCountersState();
            });

            resetAllBtn.addEventListener('click', () => {
                if (confirm("Você tem certeza que deseja resetar tudo? ISSO APAGARÁ TODOS OS CONTADORES E O HISTÓRICO DE CONTAGEM PERMANENTEMENTE.")) {
                    countersGrid.innerHTML = '';
                    counters.forEach(c => c.destroy());
                    counters = [];
                    
                    localStorage.removeItem(DAILY_HISTORY_KEY);
                    localStorage.removeItem(COUNTERS_STATE_KEY);
                    localStorage.removeItem(INCREMENT_HISTORY_KEY);

                    if (counterChart) {
                        counterChart.destroy();
                        counterChart = null;
                    }
                    if (historyChart) {
                        historyChart.destroy();
                        historyChart = null;
                    }
                    
                    loadCountersState();
                    updateCounterChart();
                }
            });

            // --- LÓGICA DO HISTÓRICO DO CONTADOR ---
            const contadorTabButtons = document.querySelectorAll('.contador-tab-button');
            const contadorTabContents = document.querySelectorAll('.contador-tab-content');
            const historyFilterButtons = document.querySelectorAll('.history-filter-btn');
            const historyChartTitle = document.getElementById('history-chart-title');

            contadorTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = `${button.dataset.tab}-tab`;
                    
                    contadorTabButtons.forEach(btn => btn.classList.add('text-subtle'));
                    button.classList.remove('text-subtle');
                    
                    contadorTabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== targetTabId);
                    });

                    if (targetTabId === 'contador-history-tab') {
                        setTimeout(() => {
                            const activeFilter = document.querySelector('.history-filter-btn.active') || document.querySelector('.history-filter-btn[data-period="week"]');
                            if (activeFilter) {
                               activeFilter.classList.add('active');
                               renderHistoryChart(activeFilter.dataset.period);
                            }
                        }, 0);
                    }
                });
            });

            historyFilterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    historyFilterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderHistoryChart(button.dataset.period);
                });
            });

            function getHistoryChartData(period) {
                const history = JSON.parse(localStorage.getItem(DAILY_HISTORY_KEY) || '[]');
                const now = new Date();
                
                if (period === 'week') {
                    const labels = [];
                    const data = Array(7).fill(0);
                    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                    
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(now.getDate() - i);
                        labels.push(dayNames[d.getDay()]);
                        const dateString = d.toISOString().slice(0, 10);
                        
                        const dayEntry = history.find(entry => entry.date === dateString);
                        if (dayEntry) {
                            data[6 - i] = dayEntry.count;
                        }
                    }
                    return { labels, data, title: 'Contagem Finalizada na Última Semana' };
                }

                if (period === 'month') {
                    const labels = [];
                    const data = Array(12).fill(0);
                    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

                    for (let i = 11; i >= 0; i--) {
                        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        labels.push(`${monthNames[d.getMonth()]}/${d.getFullYear().toString().slice(-2)}`);
                        
                        const monthEntries = history.filter(entry => entry.date.startsWith(`${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`));
                        const monthTotal = monthEntries.reduce((sum, entry) => sum + entry.count, 0);
                        data[11-i] = monthTotal;
                    }
                    return { labels, data, title: 'Contagem Finalizada nos Últimos 12 Meses' };
                }

                if (period === 'year') {
                    const labels = [];
                    const data = Array(10).fill(0);
                    const currentYear = now.getFullYear();

                    for (let i = 9; i >= 0; i--) {
                        const year = currentYear - i;
                        labels.push(year.toString());
                        
                        const yearEntries = history.filter(entry => entry.date.startsWith(year.toString()));
                        const yearTotal = yearEntries.reduce((sum, entry) => sum + entry.count, 0);
                        data[9-i] = yearTotal;
                    }
                    return { labels, data, title: 'Contagem Finalizada nos Últimos 10 Anos' };
                }
                 return { labels: [], data: [], title: '' }; // Fallback
            }

            function renderHistoryChart(period) {
                const chartCanvas = document.getElementById('history-chart');
                if (!chartCanvas) return;
                const ctx = chartCanvas.getContext('2d');
                
                const chartData = getHistoryChartData(period);
                if (!chartData) return;

                const { labels, data, title } = chartData;
                historyChartTitle.textContent = title;

                const isDarkMode = document.documentElement.classList.contains('dark');
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDarkMode ? '#d1d9e6' : '#5a6474';
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim();

                if (historyChart) {
                    historyChart.data.labels = labels;
                    historyChart.data.datasets[0].data = data;
                    historyChart.options.scales.x.ticks.color = textColor;
                    historyChart.options.scales.y.ticks.color = textColor;
                    historyChart.options.scales.x.grid.color = gridColor;
                    historyChart.options.scales.y.grid.color = gridColor;
                    historyChart.update();
                } else {
                    historyChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Adições',
                                data: data,
                                backgroundColor: accentColor,
                                borderRadius: 5,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: textColor, stepSize: 1, callback: v => (Number.isInteger(v) ? v : null) },
                                    grid: { color: gridColor }
                                },
                                x: {
                                    ticks: { color: textColor },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
            }


            // --- LÓGICA DO MÓDULO CHECKLIST ---
            function handleChecklistChange(e) {
                const checkbox = e.target.closest('.checklist-item-checkbox');
                if (checkbox) {
                    const { flow, doc, itemKey } = checkbox.dataset;
                    if (flow && doc && itemKey) {
                        checklistState[flow] = checklistState[flow] || {};
                        checklistState[flow][doc] = checklistState[flow][doc] || {};
                        checklistState[flow][doc][itemKey] = checkbox.checked;
                    }
                }
            }

            function renderChecklist() {
                const container = document.getElementById('checklist-module');
                if (!container || typeof checklistData === 'undefined') return;
                
                container.innerHTML = `
                    <div id="checklist-flows-view"></div>
                    <div id="checklist-documents-view" class="hidden"></div>
                    <div id="checklist-items-view" class="hidden"></div>
                `;
                
                showFlowsView();
                
                container.addEventListener('click', handleChecklistNavigation);
                container.addEventListener('change', handleChecklistChange);
            }

            function handleChecklistNavigation(e) {
                const target = e.target;

                const imageToView = target.closest('#image-viewer-container img');
                if (imageToView) {
                    openImageViewer(imageToView.src);
                    return;
                }

                const flowBtn = target.closest('.checklist-flow-btn');
                if (flowBtn) {
                    showDocumentsView(flowBtn.dataset.flow);
                    return;
                }

                const docBtn = target.closest('.checklist-doc-btn');
                if (docBtn) {
                    showChecklistItemsView(docBtn.dataset.flow, docBtn.dataset.doc);
                    return;
                }

                const backBtn = target.closest('.checklist-back-btn');
                if (backBtn) {
                    const targetView = backBtn.dataset.target;
                    if (targetView === 'flows') {
                        showFlowsView();
                    } else if (targetView === 'documents') {
                        const flowKey = backBtn.dataset.flow;
                        if (flowKey) {
                            showDocumentsView(flowKey);
                        } else {
                            showFlowsView();
                        }
                    }
                    return;
                }

                const finishBtn = target.closest('.checklist-finish-btn');
                if (finishBtn) {
                    const { flow, doc, page } = finishBtn.dataset;
                    const allChecklistItems = Object.entries(checklistData.flows[flow].documents[doc].checklist || {});
                    const devolucoes = [];

                    allChecklistItems.forEach(([itemKey, parecerKey]) => {
                        const isChecked = checklistState[flow]?.[doc]?.[itemKey] || false;
                        if (!isChecked) {
                            const parecerText = findParecerText(parecerKey);
                            const formattedParecer = `${parecerKey}: ${parecerText || 'Parecer não encontrado.'}`;
                            devolucoes.push(formattedParecer);
                        }
                    });

                    let resultHTML = '<div class="flex flex-col h-full">';
                    let parecerTextForCopy = "APROVAR";
                    if (devolucoes.length === 0) {
                        resultHTML += `<div class="flex-grow flex flex-col items-center justify-center text-center gap-4"><i data-lucide="party-popper" class="w-16 h-16 text-green-500"></i><p class="text-2xl text-green-500 font-bold">APROVAR</p></div>`;
                    } else {
                        parecerTextForCopy = devolucoes.join(' ');
                        resultHTML += `<div class="flex-grow"><p class="text-red-500 font-medium">${parecerTextForCopy}</p></div>`;
                    }

                    resultHTML += `
                        <div class="mt-auto pt-6 flex flex-col gap-4">
                             <button class="checklist-copy-result-btn w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2" data-text-to-copy="${encodeURIComponent(parecerTextForCopy)}">
                                <i data-lucide="copy" class="w-5 h-5"></i> Copiar Parecer
                            </button>
                            <button class="checklist-back-to-items w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2 text-accent" data-flow="${flow}" data-doc="${doc}" data-page="${page}">
                                <i data-lucide="arrow-left-circle" class="w-5 h-5"></i> Voltar
                            </button>
                        </div>
                    </div>`;
                    
                    const itemsContainer = document.getElementById('checklist-items-container');
                    if (itemsContainer) itemsContainer.innerHTML = resultHTML;
                    safeCreateIcons();
                    return;
                }

                const copyResultBtn = target.closest('.checklist-copy-result-btn');
                if (copyResultBtn) {
                    const textToCopy = decodeURIComponent(copyResultBtn.dataset.textToCopy);
                    copyParecer(textToCopy, copyResultBtn);
                    return;
                }

                const pageNextBtn = target.closest('.checklist-page-next');
                if (pageNextBtn) {
                    const { flow, doc, page } = pageNextBtn.dataset;
                    renderChecklistPage(flow, doc, parseInt(page) + 1);
                    return;
                }

                const pagePrevBtn = target.closest('.checklist-page-prev');
                if (pagePrevBtn) {
                    const { flow, doc, page } = pagePrevBtn.dataset;
                    renderChecklistPage(flow, doc, parseInt(page) - 1);
                    return;
                }

                const backToItemsBtn = target.closest('.checklist-back-to-items');
                if (backToItemsBtn) {
                    const { flow, doc, page } = backToItemsBtn.dataset;
                    renderChecklistPage(flow, doc, parseInt(page));
                    return;
                }
            }
            
            function showFlowsView() {
                const container = document.getElementById('checklist-module');
                container.querySelector('#checklist-flows-view').classList.remove('hidden');
                container.querySelector('#checklist-documents-view').classList.add('hidden');
                container.querySelector('#checklist-items-view').classList.add('hidden');

                const flowsView = container.querySelector('#checklist-flows-view');
                let html = '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">';
                for (const flowKey in checklistData.flows) {
                    const flow = checklistData.flows[flowKey];
                    html += `
                        <button class="checklist-flow-btn flex flex-col items-center justify-center text-center gap-2 p-3 rounded-2xl neumorphic-outset-sm aspect-square transition-all duration-200 active:scale-95 hover:neumorphic-inset" data-flow="${flowKey}">
                            <span class="text-4xl">${flow.icon}</span>
                            <span class="font-semibold">${flow.name}</span>
                        </button>
                    `;
                }
                html += '</div>';
                flowsView.innerHTML = html;
                safeCreateIcons();
            }

            function showDocumentsView(flowKey) {
                const container = document.getElementById('checklist-module');
                container.querySelector('#checklist-flows-view').classList.add('hidden');
                container.querySelector('#checklist-documents-view').classList.remove('hidden');
                container.querySelector('#checklist-items-view').classList.add('hidden');
                
                const documentsView = container.querySelector('#checklist-documents-view');
                documentsView.className = 'flex flex-col h-full'; 
                
                const flow = checklistData.flows[flowKey];
                
                let headerHtml = `
                    <div class="flex-shrink-0">
                        <div class="flex items-center justify-between gap-4 mb-4">
                            <div class="flex items-center gap-2">
                                <button class="checklist-back-btn p-3 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5" data-target="flows">
                                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                                </button>
                                <h3 class="text-xl font-bold truncate">${flow.name}</h3>
                            </div>
                            <div class="relative flex-grow min-w-0">
                                 <input type="text" id="checklist-doc-search" placeholder="Buscar..." class="w-full p-3 pr-10 rounded-2xl neumorphic-inset focus:outline-none text-sm" data-flow="${flowKey}">
                                 <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-subtle"></i>
                            </div>
                        </div>
                    </div>
                `;

                let contentHtml = '';
                const docKeys = Object.keys(flow.documents);

                if (docKeys.length > 0) {
                    contentHtml = `
                        <div id="checklist-doc-list-container" class="flex-grow overflow-y-auto custom-scrollbar max-h-[50vh] p-3">
                            <!-- A lista de documentos será renderizada aqui -->
                        </div>
                    `;
                } else {
                     contentHtml = `
                        <div class="flex-grow flex flex-col items-center justify-center h-full min-h-[300px] gap-4 text-center p-4 rounded-2xl neumorphic-inset">
                            <i data-lucide="wrench" class="w-12 h-12 text-subtle"></i>
                            <p class="text-lg font-medium text-subtle">Os checklists para ${flow.name} estão sendo construídos.</p>
                        </div>
                    `;
                }

                documentsView.innerHTML = headerHtml + contentHtml;

                if (docKeys.length > 0) {
                    renderDocumentList(flowKey, '');
                }

                const searchInput = document.getElementById('checklist-doc-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        renderDocumentList(flowKey, e.target.value);
                    });
                }

                safeCreateIcons();
            }

            function renderDocumentList(flowKey, searchTerm) {
                const listContainer = document.getElementById('checklist-doc-list-container');
                if (!listContainer) return;

                const flow = checklistData.flows[flowKey];
                const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();

                const filteredDocKeys = Object.keys(flow.documents).filter(docKey => {
                    const doc = flow.documents[docKey];
                    return doc.name.toLowerCase().includes(lowerCaseSearchTerm);
                });

                let listHtml = '<div class="grid grid-cols-2 sm:grid-cols-4 gap-4">';
                if (filteredDocKeys.length > 0) {
                    filteredDocKeys.forEach(docKey => {
                        const doc = flow.documents[docKey];
                        listHtml += `
                            <button class="checklist-doc-btn flex flex-col items-center justify-center text-center gap-2 p-3 rounded-2xl neumorphic-outset-sm aspect-square transition-all duration-200 active:scale-95 hover:neumorphic-inset" data-flow="${flowKey}" data-doc="${docKey}">
                                <span class="text-3xl">${doc.icon}</span>
                                <span class="text-xs font-medium">${doc.name}</span>
                            </button>
                        `;
                    });
                } else {
                    listHtml += `<div class="col-span-full text-center py-8 text-subtle">Nenhum documento encontrado.</div>`;
                }
                listHtml += '</div>';

                listContainer.innerHTML = listHtml;
            }

            function showChecklistItemsView(flowKey, docKey) {
                const container = document.getElementById('checklist-module');
                container.querySelector('#checklist-flows-view').classList.add('hidden');
                container.querySelector('#checklist-documents-view').classList.add('hidden');
                container.querySelector('#checklist-items-view').classList.remove('hidden');

                const itemsView = container.querySelector('#checklist-items-view');
                const doc = checklistData.flows[flowKey].documents[docKey];

                itemsView.innerHTML = `
                    <div class="animate-fade-in">
                        <div class="flex items-center flex-shrink-0 mb-6">
                            <button class="checklist-back-btn p-3 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5" data-target="documents" data-flow="${flowKey}">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <h3 class="text-xl font-bold ml-4 flex items-center gap-2"><span class="text-2xl">${doc.icon}</span> ${doc.name}</h3>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                             <div class="flex flex-col gap-6 sticky top-4">
                                <div id="image-viewer-container" class="p-2 rounded-2xl neumorphic-outset relative min-h-[400px] flex-grow">
                                    <!-- Imagem aparece aqui -->
                                </div>
                                <div id="image-pagination-controls" class="flex justify-center">
                                    <!-- Paginação SÓ PARA IMAGENS -->
                                </div>
                            </div>

                            <div id="checklist-items-container" class="p-6 rounded-2xl neumorphic-inset flex flex-col h-full min-h-[50vh]">
                                <!-- Itens do checklist e sua paginação aparecem aqui -->
                            </div>
                        </div>
                    </div>
                `;
                
                const imageContainer = itemsView.querySelector('#image-viewer-container');
                const imagePaginationContainer = itemsView.querySelector('#image-pagination-controls');
                
                if (doc.imageUrl || doc.imageUrls) {
                    setupImageSlider(doc, imageContainer, imagePaginationContainer);
                } else {
                    imageContainer.innerHTML = `<div class="flex items-center justify-center h-full text-subtle">Nenhum documento para exibir.</div>`;
                }

                renderChecklistPage(flowKey, docKey, 0);
            }

            function setupImageSlider(doc, imageContainer, paginationContainer) {
                const images = doc.imageUrls || (doc.imageUrl ? [doc.imageUrl] : []);
                if (images.length === 0) return;

                let currentIndex = 0;

                function updateView() {
                    const currentImage = images[currentIndex];
                    imageContainer.innerHTML = `<img src="${currentImage}" alt="Documento" class="w-full h-full object-contain rounded-xl image-viewer-content cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x550/e0e5ec/5a6474?text=Imagem+indisponível';">`;
                    
                    if (images.length > 1) {
                        paginationContainer.innerHTML = `
                            <div class="flex items-center justify-center gap-4">
                                <button ${currentIndex === 0 ? 'disabled' : ''} class="checklist-image-prev p-3 rounded-full neumorphic-outset-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-90">
                                    <i data-lucide="arrow-left" class="w-5 h-5 pointer-events-none"></i>
                                </button>
                                <div class="flex gap-2 items-center">
                                    ${images.map((_, i) => `<div class="pagination-dot ${i === currentIndex ? 'active' : ''}"></div>`).join('')}
                                </div>
                                <button ${currentIndex === images.length - 1 ? 'disabled' : ''} class="checklist-image-next p-3 rounded-full neumorphic-outset-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-90">
                                    <i data-lucide="arrow-right" class="w-5 h-5 pointer-events-none"></i>
                                </button>
                            </div>
                        `;
                        safeCreateIcons();
                    }
                }

                paginationContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.checklist-image-next')) {
                        if (currentIndex < images.length - 1) {
                            currentIndex++;
                            updateView();
                        }
                    }
                    if (e.target.closest('.checklist-image-prev')) {
                        if (currentIndex > 0) {
                            currentIndex--;
                            updateView();
                        }
                    }
                });

                updateView();
            }

            function renderChecklistPage(flowKey, docKey, pageIndex) {
                const itemsContainer = document.getElementById('checklist-items-container');
                if (!itemsContainer) return;

                const doc = checklistData.flows[flowKey].documents[docKey];
                const checklistItems = Object.entries(doc.checklist || {});
                const itemsPerPage = 8;
                const totalPages = Math.ceil(checklistItems.length / itemsPerPage);

                const start = pageIndex * itemsPerPage;
                const end = start + itemsPerPage;
                const pageItems = checklistItems.slice(start, end);

                let checklistHtml = '<ul class="space-y-4 flex-grow">';
                pageItems.forEach(([itemKey, parecerKey]) => {
                    const isChecked = checklistState[flowKey]?.[docKey]?.[itemKey] || false;
                    checklistHtml += `
                        <li class="checklist-list-item p-3 rounded-lg transition-colors duration-200">
                            <label class="flex items-start gap-4 cursor-pointer">
                                <input type="checkbox" class="checklist-item-checkbox hidden" 
                                       data-parecer-key="${parecerKey}"
                                       data-item-key="${itemKey}"
                                       data-flow="${flowKey}"
                                       data-doc="${docKey}"
                                       ${isChecked ? 'checked' : ''}>
                                <span class="custom-checkbox neumorphic-outset-sm">
                                    <i data-lucide="check" class="check-icon w-4 h-4"></i>
                                </span>
                                <span class="font-medium flex-1">${itemKey}</span>
                            </label>
                        </li>`;
                });
                checklistHtml += '</ul>';

                let paginationHtml = '<div id="checklist-items-pagination" class="flex items-center justify-center gap-4 mt-4 py-2"></div>';
                
                let finishButtonHtml = '';
                if (totalPages === 0 || pageIndex >= totalPages - 1) {
                    finishButtonHtml = `
                        <div class="mt-auto pt-6">
                            <button class="checklist-finish-btn w-full p-4 rounded-2xl neumorphic-inset font-semibold text-accent transition-all duration-200 active:scale-95" data-flow="${flowKey}" data-doc="${docKey}" data-page="${pageIndex}">
                                Finalizar
                            </button>
                        </div>
                    `;
                }
                
                itemsContainer.innerHTML = checklistHtml + paginationHtml + finishButtonHtml;

                const checklistPaginationContainer = itemsContainer.querySelector('#checklist-items-pagination');
                if (totalPages > 1 && checklistPaginationContainer) {
                    let paginationControls = `
                        <button ${pageIndex === 0 ? 'disabled' : ''} class="checklist-page-prev p-3 rounded-full neumorphic-outset-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-90" data-flow="${flowKey}" data-doc="${docKey}" data-page="${pageIndex}">
                            <i data-lucide="arrow-left" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                        <div class="flex gap-2 items-center">
                            ${Array.from({ length: totalPages }, (_, i) => `<div class="pagination-dot ${i === pageIndex ? 'active' : ''}"></div>`).join('')}
                        </div>
                        <button ${pageIndex >= totalPages - 1 ? 'disabled' : ''} class="checklist-page-next p-3 rounded-full neumorphic-outset-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-90" data-flow="${flowKey}" data-doc="${docKey}" data-page="${pageIndex}">
                            <i data-lucide="arrow-right" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                    `;
                    checklistPaginationContainer.innerHTML = paginationControls;
                }

                safeCreateIcons();
            }
            
            function findParecerText(parecerKeyToFind) {
                if (typeof pareceresDataCorrigido === 'undefined') return null;

                for (const mainCategory in pareceresDataCorrigido) {
                    const subCategories = pareceresDataCorrigido[mainCategory];
                    for (const subCategoryTitle in subCategories) {
                        const items = subCategories[subCategoryTitle];
                        if (typeof items === 'object' && items !== null) {
                            if (items[parecerKeyToFind]) {
                                return items[parecerKeyToFind];
                            }
                        } 
                        else if (subCategoryTitle === parecerKeyToFind) {
                             return items;
                        }
                    }
                }
                return null; 
            }


            // --- ESTADO INICIAL DA APLICAÇÃO ---
            function initializeApp() {
                updateThemeIcons();
                if (dockButtons.length > 0) {
                    requestAnimationFrame(() => {
                         dockButtons[0].click();
                    });
                }
            }

            // --- LÓGICA DO MODAL DE TERMOS ---
            const TERMS_KEY = 'apoioBpoTermsAccepted_v1.1';
            
            termsCheckbox.addEventListener('change', () => {
                acceptTermsBtn.disabled = !termsCheckbox.checked;
            });

            if (localStorage.getItem(TERMS_KEY) === 'true') {
                initializeApp();
            } else {
                termsModal.classList.remove('hidden');
                mainContent.classList.add('blurred');
                
                acceptTermsBtn.addEventListener('click', () => {
                    if (!termsCheckbox.checked) return;

                    localStorage.setItem(TERMS_KEY, 'true');
                    
                    termsModal.classList.add('animate-fade-out');
                    termsModal.addEventListener('animationend', () => {
                        termsModal.classList.add('hidden');
                        mainContent.classList.remove('blurred');
                    }, { once: true });

                    initializeApp();
                }, { once: true });
            }
        };
    </script>
</body>
</html>
