<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApoioBPO - Sistema de Apoio BPO</title>
    <link rel="icon" type="image/png" href="./images/icone_meta.png" onerror="this.style.display='none'">

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Adicionada a biblioteca de gráficos Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Carregando os arquivos de dados externos -->
    <script src="data/pareceres.js" defer></script>
    <script src="data/regras.js" defer></script>
    <script src="data/checklists.js" defer></script>


    <style type="text/tailwindcss">
        :root {
            --color-bg: #e0e5ec;
            --color-text: #5a6474;
            --color-shadow-1: #ffffff;
            --color-shadow-2: #a3b1c6;
            --color-accent: #0ea5e9;
            --color-subtle: #9ca3af;
            --scrollbar-thumb: #a3b1c6;
            --scrollbar-thumb-hover: #5a6474;
        }

        html.dark {
            --color-bg: #1f2937;
            --color-text: #d1d9e6;
            --color-shadow-1: #374151;
            --color-shadow-2: #111827;
            --color-accent: #38bdf8;
            --color-subtle: #6b7280;
            --scrollbar-thumb: #5a6474;
            --scrollbar-thumb-hover: #9ca3af;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            transition: background-color 0.35s cubic-bezier(0.4, 0, 0.2, 1), color 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
        }

        .neumorphic-outset { box-shadow: 6px 6px 12px var(--color-shadow-2), -6px -6px 12px var(--color-shadow-1); }
        .neumorphic-inset { box-shadow: inset 6px 6px 12px var(--color-shadow-2), inset -6px -6px 12px var(--color-shadow-1); }
        .neumorphic-outset-sm { box-shadow: 3px 3px 6px var(--color-shadow-2), -3px -3px 6px var(--color-shadow-1); }
        
        .text-accent { color: var(--color-accent); }
        .text-subtle { color: var(--color-subtle); }

        ::placeholder { color: #9ca3af; }
        .dark ::placeholder { color: #6b7280; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px;}
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 20px; border: 2px solid var(--color-bg); }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: var(--scrollbar-thumb-hover); }

        .toggle-container {
            position: relative;
            width: 3.5rem;
            height: 1.75rem;
        }
        .toggle-label {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 9999px;
            box-shadow: inset 2px 2px 5px var(--color-shadow-2), inset -2px -2px 5px var(--color-shadow-1);
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .toggle-checkbox {
            appearance: none;
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            background-color: var(--color-bg);
            box-shadow: 2px 2px 4px var(--color-shadow-2), -2px -2px 4px var(--color-shadow-1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .toggle-checkbox:checked {
            transform: translateX(1.75rem);
            background-color: var(--color-accent);
        }


        @keyframes fade-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-fade-in { animation: fade-in 0.3s ease-out forwards; }
        @keyframes fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .animate-fade-out { animation: fade-out 0.3s ease-in forwards; }
        
        input, select { background-color: transparent !important; color: var(--color-text); }
        select option { background: var(--color-bg); color: var(--color-text); }

        #dock-slider { transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1); position: absolute; left: 0; margin-left: 0 !important; margin-right: 0 !important; }

        .custom-checkbox { width: 22px; height: 22px; border-radius: 6px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; transition: all 0.2s ease-in-out; cursor: pointer; }
        .custom-checkbox .check-icon { opacity: 0; transform: scale(0.5); transition: all 0.2s ease-in-out; color: var(--color-accent); }
        .checklist-item-checkbox:checked + .custom-checkbox { box-shadow: inset 3px 3px 6px var(--color-shadow-2), inset -3px -3px 6px var(--color-shadow-1); }
        .checklist-item-checkbox:checked + .custom-checkbox .check-icon { opacity: 1; transform: scale(1); }
        .checklist-list-item:has(.checklist-item-checkbox:checked) { background-color: rgba(0,0,0,0.02); }
        html.dark .checklist-list-item:has(.checklist-item-checkbox:checked) { background-color: rgba(255,255,255,0.02); }
        
        .pagination-dot { width: 10px; height: 10px; border-radius: 50%; transition: all 0.3s ease; background-color: var(--color-text); opacity: 0.3; }
        .pagination-dot.active { opacity: 1; transform: scale(1.2); background-color: var(--color-accent); }
        
        @keyframes image-fade-in { from { opacity: 0.4; } to { opacity: 1; } }
        .image-viewer-content-wrapper { animation: image-fade-in 0.5s ease-in-out; }
        
        #terms-modal.hidden, #info-modal.hidden, #image-viewer-modal.hidden { display: none; }
        #main-content.blurred { filter: blur(5px) saturate(0.9); transform: scale(0.98); pointer-events: none; user-select: none; transition: all 0.3s ease-out; }
        
        #accept-terms-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
        #timer-toggle:checked + .toggle-label {
            background-color: rgba(56, 189, 248, 0.1);
            box-shadow:
                0 0 5px var(--color-accent),
                0 0 10px var(--color-accent),
                0 0 20px var(--color-accent),
                inset 2px 2px 5px var(--color-shadow-2),
                inset -2px -2px 5px var(--color-shadow-1);
        }
        
        #image-viewer-content {
            transition: transform 0.2s ease-out;
            cursor: grab;
        }
        #image-viewer-content.dragging {
            cursor: grabbing;
        }
        
        .history-filter-btn.active {
             box-shadow: inset 3px 3px 6px var(--color-shadow-2), inset -3px -3px 6px var(--color-shadow-1);
             color: var(--color-accent);
        }
        
        .star-btn .star-icon { transition: all 0.2s ease-in-out; }
        .star-btn.active .star-icon {
            fill: #facc15;
            color: #facc15;
        }

    </style>
</head>

<body>
    <!-- MODAL DE TERMOS DE USO -->
<div id="terms-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
    <div class="absolute inset-0 bg-[var(--color-bg)] opacity-90"></div>
    <div class="relative w-full max-w-2xl p-6 sm:p-8 rounded-2xl neumorphic-outset animate-fade-in">
        <h2 class="text-2xl font-bold mb-2 text-accent">Termos e Condições de Uso — ApoioBPO</h2>
        <p class="text-xs text-subtle mb-4">Versão 1.6.0 — Agosto de 2025</p>

        <div class="max-h-[60vh] overflow-y-auto custom-scrollbar pr-4 text-sm space-y-4">
            <p>Bem-vindo ao ApoioBPO. Antes de utilizar o sistema, leia atentamente estes termos. Ao clicar em “Aceitar e Continuar”, você declara estar de acordo com as condições estabelecidas.</p>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">1. Propriedade Intelectual</h3>
                <p class="text-subtle">Este sistema foi desenvolvido por <strong>Wellington Juan Dutra Oliveira</strong>, com colaboração de:</p>
                <ul class="list-disc list-inside pl-4 text-subtle">
                    <li>Gabriel Artur Lopes Feltes</li>
                    <li>Mauricio Gabriel Freiberger Konig</li>
                    <li>Erika Mendonça Figueira</li>
                    <li>Bruno Corrêa Alves</li>
                </ul>
                <p class="text-subtle mt-2">Todos os direitos sobre o sistema, incluindo código-fonte, design, funcionalidades e lógica, são reservados ao autor.</p>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">2. Finalidade de Uso</h3>
                <p class="text-subtle">O ApoioBPO destina-se exclusivamente ao uso interno e profissional da equipe da Meta Serviços em Informática S.A., no âmbito dos serviços de BPO prestados ao Banco Cooperativo Sicoob S.A.</p>
                <p class="text-subtle mt-2">Principais funcionalidades:</p>
                <ul class="list-disc list-inside pl-4 text-subtle">
                    <li>Cálculo de renda para pessoas físicas (PF) e jurídicas (PJ);</li>
                    <li>Análise de atividades agropecuárias;</li>
                    <li>Verificação automatizada de CNPJ;</li>
                    <li>Checklist documental;</li>
                    <li>Registro e contagem de atividades por hora;</li>
                    <li>Consulta de pareceres técnicos e regras de operação.</li>
                </ul>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">3. Restrições de Uso</h3>
                <p class="text-subtle">É estritamente proibido:</p>
                <ul class="list-disc list-inside pl-4 text-subtle">
                    <li>Utilizar o sistema fora do ambiente corporativo e horário comercial;</li>
                    <li>Compartilhar acesso com pessoas não autorizadas;</li>
                    <li>Copiar, modificar, distribuir, vender ou sublicenciar o sistema sem autorização expressa;</li>
                    <li>Realizar engenharia reversa, descompilar ou tentar acessar o código-fonte;</li>
                    <li>Utilizar documentos, regras ou pareceres sem permissão formal;</li>
                    <li>Armazenar ou transmitir dados do sistema fora da rede corporativa sem autorização prévia.</li>
                </ul>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">4. Confidencialidade</h3>
                <p class="text-subtle">Todas as informações acessadas, processadas ou armazenadas são confidenciais, incluindo dados de clientes, cálculos, regras de negócio e pareceres técnicos. O usuário compromete-se a manter sigilo absoluto, mesmo após o desligamento da empresa, e a não divulgar ou armazenar externamente qualquer informação sem autorização.</p>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">5. Responsabilidade Limitada</h3>
                <p class="text-subtle">O sistema é fornecido “como está” e pode apresentar limitações técnicas decorrentes de atualizações, integrações externas ou uso indevido. Os desenvolvedores se responsabilizam apenas pelo funcionamento correto das funcionalidades especificadas.</p>
                <p class="text-subtle mt-2">Decisões operacionais, financeiras ou jurídicas baseadas no sistema devem ser validadas pelo usuário. Falhas devem ser comunicadas imediatamente pelos canais oficiais.</p>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">6. Suporte e Comunicação de Incidentes</h3>
                <p class="text-subtle">Dúvidas, falhas ou incidentes devem ser reportados imediatamente pelo canal oficial da Meta Serviços em Informática S.A. (Microsoft Teams, e-mail corporativo ou ferramenta designada). O não reporte pode limitar a responsabilidade dos autores.</p>
            </div>

            <div>
                <h3 class="font-semibold text-base mt-4 mb-2">7. Vigência e Atualizações</h3>
                <p class="text-subtle">Estes termos entram em vigor na data da versão indicada e podem ser atualizados a qualquer momento por motivos técnicos, legais ou operacionais. O usuário deve manter-se informado sobre a versão vigente.</p>
            </div>
        </div>

        <div class="mt-6 space-y-4">
            <label for="terms-checkbox" class="flex items-center justify-center gap-2 text-sm cursor-pointer">
                <input type="checkbox" id="terms-checkbox" class="h-4 w-4 rounded border-gray-300 text-accent focus:ring-accent">
                <span>Declaro que li, compreendi e aceito todos os termos e condições de uso descritos acima</span>
            </label>
            <button id="accept-terms-btn" class="w-full px-8 py-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 text-accent" disabled>
                Aceitar e Continuar
            </button>
        </div>
    </div>
</div>


    <div id="main-content" class="min-h-screen w-full flex flex-col items-center p-4 sm:p-8 transition-all duration-300">

        <main class="w-full max-w-5xl mx-auto flex flex-col gap-4 mb-24">
            <header class="flex justify-between items-center w-full px-2 flex-shrink-0">
                <h1 id="module-title" class="text-2xl font-bold transition-all duration-300"></h1>
                <div class="flex items-center gap-2">
                    <button id="info-button" class="p-3 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">
                        <i data-lucide="info" class="w-5 h-5"></i>
                    </button>
                    <button id="theme-toggle" class="p-3 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">
                        <i data-lucide="sun" id="sun-icon" class="w-5 h-5"></i>
                        <i data-lucide="moon" id="moon-icon" class="hidden w-5 h-5"></i>
                    </button>
                </div>
            </header>

            <div id="module-container" class="w-full p-6 md:p-8 rounded-2xl neumorphic-outset min-h-[60vh]">
                <div id="faturamento-module" class="module-content hidden">
                    <div class="flex mb-6 border-b border-slate-300 dark:border-slate-600 flex-shrink-0 overflow-x-auto">
                        <button class="faturamento-tab-button py-2 px-4 font-semibold whitespace-nowrap" data-tab="calculo-simples">Cálculo do Simples</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="rel-faturamento">Rel. Faturamento</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="semoventes">Semoventes</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="nfs">NF's</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="quotas">Quotas</button>
                        <button class="faturamento-tab-button py-2 px-4 font-semibold text-subtle whitespace-nowrap" data-tab="fcpr">FCPR</button>
                    </div>
                    <div>
                        <div id="calculo-simples-tab" class="faturamento-tab-content">
                             <form id="faturamento-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div class="flex flex-col gap-2">
                                    <label for="rbt12" class="text-sm font-medium">Receita Bruta 12 Meses (RBT12)</label>
                                    <input type="text" inputmode="decimal" id="rbt12" placeholder="0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label class="text-sm font-medium">1º Cálculo (Somente RBT12)</label>
                                    <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                        <p id="resultado1" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label for="rpa" class="text-sm font-medium">Receita Bruta do Período (RPA)</label>
                                    <input type="text" inputmode="decimal" id="rpa" placeholder="0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label class="text-sm font-medium">2º Cálculo (+12 Meses)</label>
                                    <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                        <p id="resultado2" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label for="mes_anterior" class="text-sm font-medium">Redução Mês Ano Anterior</label>
                                    <input type="text" inputmode="decimal" id="mes_anterior" placeholder="0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                </div>
                                 <div class="flex flex-col gap-2">
                                    <label class="text-sm font-medium">3º Cálculo (&lt;12 Meses)</label>
                                    <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                        <p id="resultado3" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                    </div>
                                </div>

                                <div class="flex flex-col gap-2">
                                    <label for="num_meses" class="text-sm font-medium">Quantidade de Meses (&lt; 12)</label>
                                    <input type="number" id="num_meses" placeholder="1" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                </div>
                                
                                <div></div>

                                <div class="md:col-span-2 flex gap-4 mt-4">
                                    <button id="calcular-faturamento" type="button" class="flex-1 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="calculator" class="w-5 h-5"></i> Calcular
                                    </button>
                                    <button id="limpar-faturamento" type="button" class="flex-1 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                            </form>
                        </div>
                        <div id="rel-faturamento-tab" class="faturamento-tab-content hidden">
                           <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div class="flex flex-col gap-2">
                                    <h3 class="text-lg font-semibold mb-2">Valores Mensais</h3>
                                    <div id="rel-faturamento-inputs" class="space-y-2">
                                        <!-- Inputs serão gerados pelo JS -->
                                    </div>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda 12 Meses</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="rel-faturamento-renda-12-meses" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Mensal</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="rel-faturamento-renda-mensal" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <button id="rel-faturamento-limpar" type="button" class="mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                           </div>
                        </div>
                        <div id="semoventes-tab" class="faturamento-tab-content hidden">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2">
                                    <h3 class="text-lg font-semibold mb-4">Rebanho</h3>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead class="border-b-2 border-slate-300 dark:border-slate-600">
                                                <tr>
                                                    <th class="p-2 text-left">Descrição</th>
                                                    <th class="p-2 text-left">Quantidade</th>
                                                    <th class="p-2 text-left">Valor Unitário</th>
                                                    <th class="p-2 text-left">Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="semoventes-tbody">
                                                <!-- Linhas geradas por JS -->
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <h3 class="text-lg font-semibold">Resultados</h3>
                                     <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Quantidade Total</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="semoventes-qtd-total" class="text-2xl font-bold text-accent">0</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Anual</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="semoventes-renda-anual" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Mensal</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="semoventes-renda-mensal" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <button id="semoventes-limpar" type="button" class="mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="nfs-tab" class="faturamento-tab-content hidden">
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2">
                                    <h3 class="text-lg font-semibold mb-4">Notas Fiscais</h3>
                                    <div id="nfs-grid" class="grid grid-flow-col grid-rows-10 gap-x-8 gap-y-2 overflow-x-auto custom-scrollbar pb-2">
                                        <!-- Inputs gerados por JS -->
                                    </div>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <h3 class="text-lg font-semibold">Cálculo</h3>
                                    <div class="flex flex-col gap-2">
                                        <label for="nfs-propriedade" class="text-sm font-medium">Propriedade (%)</label>
                                        <input type="text" inputmode="decimal" id="nfs-propriedade" value="100" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Anual</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="nfs-renda-anual" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Mensal</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="nfs-renda-mensal" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <button id="nfs-limpar" type="button" class="mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                         <div id="quotas-tab" class="faturamento-tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                <div class="space-y-4 p-4 rounded-2xl neumorphic-inset">
                                    <h3 class="text-lg font-semibold text-center">Calcular % por Valor</h3>
                                    <div class="flex flex-col gap-2">
                                        <label for="quotas-valor-total-empresa-1" class="text-sm font-medium">Valor total das quotas da empresa</label>
                                        <input type="text" inputmode="decimal" id="quotas-valor-total-empresa-1" placeholder="R$ 0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label for="quotas-valor-associado-1" class="text-sm font-medium">Valor monetário das quotas do associado</label>
                                        <input type="text" inputmode="decimal" id="quotas-valor-associado-1" placeholder="R$ 0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    </div>
                                    <div class="flex flex-col gap-2 mt-2">
                                        <label class="text-sm font-medium">% Percentual Propriedade do Associado</label>
                                        <div class="p-3 rounded-2xl neumorphic-inset min-h-[44px] flex items-center">
                                            <p id="quotas-percentual-resultado" class="font-bold text-accent">0.00%</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="space-y-4 p-4 rounded-2xl neumorphic-inset">
                                    <h3 class="text-lg font-semibold text-center">Calcular Valor por %</h3>
                                    <div class="flex flex-col gap-2">
                                        <label for="quotas-valor-total-empresa-2" class="text-sm font-medium">Valor total das quotas da empresa</label>
                                        <input type="text" inputmode="decimal" id="quotas-valor-total-empresa-2" placeholder="R$ 0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label for="quotas-percentual-associado-2" class="text-sm font-medium">% Percentual Propriedade do Associado</label>
                                        <input type="text" inputmode="decimal" id="quotas-percentual-associado-2" placeholder="0,00%" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    </div>
                                    <div class="flex flex-col gap-2 mt-2">
                                        <label class="text-sm font-medium">Valor monetário das quotas do associado</label>
                                        <div class="p-3 rounded-2xl neumorphic-inset min-h-[44px] flex items-center">
                                            <p id="quotas-valor-resultado" class="font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                     <button id="quotas-limpar" type="button" class="w-full mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                            </div>
                        </div>
                         <div id="fcpr-tab" class="faturamento-tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                                <div class="flex flex-col gap-2">
                                    <h3 class="text-lg font-semibold mb-2">Renda Agrícola & Agropecuária</h3>
                                    <div id="fcpr-inputs" class="space-y-2">
                                        <!-- Inputs serão gerados pelo JS -->
                                    </div>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <h3 class="text-lg font-semibold">Percentual Propriedade / Período</h3>
                                    <div class="flex flex-col gap-2">
                                        <label for="fcpr-percentual" class="text-sm font-medium">Percentual (%)</label>
                                        <input type="text" inputmode="decimal" id="fcpr-percentual" value="100" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label for="fcpr-meses" class="text-sm font-medium">Meses</label>
                                        <input type="number" id="fcpr-meses" value="12" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-16">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Anual</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="fcpr-renda-anual" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium">Renda Mensal</label>
                                        <div class="p-4 rounded-2xl neumorphic-inset h-16 flex items-center">
                                            <p id="fcpr-renda-mensal" class="text-2xl font-bold text-accent">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <button id="fcpr-limpar" type="button" class="mt-4 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                    </button>
                                </div>
                           </div>
                        </div>
                    </div>
                </div>

                <div id="renda-pf-module" class="module-content hidden">
                    <div class="flex mb-6 border-b border-slate-300 dark:border-slate-600 flex-shrink-0">
                        <button class="renda-pf-tab-button py-2 px-4 font-semibold" data-tab="calculadora">Calculadora</button>
                        <button class="renda-pf-tab-button py-2 px-4 font-semibold text-subtle" data-tab="media">Média de Holerites</button>
                        <button class="renda-pf-tab-button py-2 px-4 font-semibold text-subtle" data-tab="soma">Soma de Valores</button>
                    </div>
                    <div>
                        <div id="calculadora-tab" class="renda-pf-tab-content">
                           <h3 class="text-2xl font-bold mb-6">Calculadora Simples</h3>
                           <div class="flex flex-col gap-6">
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 items-end">
                                   <input type="text" inputmode="decimal" id="valor_sisbr" placeholder="0,00" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm h-full">
                                   <div class="p-4 rounded-2xl neumorphic-inset">
                                       <p class="text-sm text-subtle uppercase tracking-wide">Multiplicado por 12</p>
                                       <p id="sisbr_mult" class="text-2xl font-bold text-accent mt-1">R$ 0,00</p>
                                   </div>
                               </div>
                               <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 items-stretch">
                                   <button id="limpar_sisbr" type="button" class="h-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">Limpar</button>
                                   <div class="p-4 rounded-2xl neumorphic-inset">
                                       <p class="text-sm text-subtle uppercase tracking-wide">Dividido por 12</p>
                                       <p id="sisbr_div" class="text-2xl font-bold text-accent mt-1">R$ 0,00</p>
                                   </div>
                               </div>
                           </div>
                        </div>
                        <div id="media-tab" class="renda-pf-tab-content hidden">
                            <h3 class="text-2xl font-bold mb-6">Média de Holerites</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="flex flex-col gap-4">
                                    <h4 class="text-sm text-subtle uppercase tracking-wide">Valores</h4>
                                    <input type="text" inputmode="decimal" placeholder="Valor 1" class="media-holerite-input w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    <input type="text" inputmode="decimal" placeholder="Valor 2" class="media-holerite-input w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    <input type="text" inputmode="decimal" placeholder="Valor 3" class="media-holerite-input w-full bg-transparent p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                </div>
                                <div class="flex flex-col gap-4">
                                    <h4 class="text-sm text-subtle uppercase tracking-wide">Resultado</h4>
                                    <div class="p-4 rounded-2xl neumorphic-inset">
                                        <p class="text-sm font-medium">Média dos Valores</p>
                                        <p id="media_resultado" class="text-2xl font-bold text-accent mt-1">R$ 0,00</p>
                                    </div>
                                    <button id="limpar_media" type="button" class="mt-2 p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">Limpar</button>
                                </div>
                            </div>
                        </div>
                        <div id="soma-tab" class="renda-pf-tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="flex flex-col gap-2">
                                    <h4 class="text-sm text-subtle uppercase tracking-wide mb-2">Valores a Somar</h4>
                                    <div id="soma-inputs-container" class="flex flex-col gap-2">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="soma-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    </div>
                                </div>
                                <div class="flex flex-col gap-2">
                                    <h4 class="text-sm text-subtle uppercase tracking-wide mb-2">Valores a Subtrair</h4>
                                    <div id="sub-inputs-container" class="flex flex-col gap-2">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                        <input type="text" inputmode="decimal" placeholder="0,00" class="sub-valor-input w-full p-2 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                    </div>
                                </div>
                                <div class="md:col-span-2 flex flex-col md:flex-row gap-4 mt-4">
                                     <div class="flex-1 p-4 rounded-2xl neumorphic-inset">
                                         <p class="text-sm font-medium">Soma Total</p>
                                         <p id="soma_total_resultado" class="text-2xl font-bold text-accent mt-1">R$ 0,00</p>
                                     </div>
                                     <div class="flex-1 p-4 rounded-2xl neumorphic-inset">
                                         <p class="text-sm font-medium">Divisão por 12</p>
                                         <p id="soma_div12_resultado" class="text-2xl font-bold text-accent mt-1">R$ 0,00</p>
                                     </div>
                                </div>
                                <div class="md:col-span-2 mt-4">
                                    <button id="limpar_soma" type="button" class="w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="regras-module" class="module-content hidden">
                    <h2 class="text-2xl font-bold mb-6">Regras do Imposto de Renda</h2>
                    <div class="overflow-auto custom-scrollbar">
                        <table class="w-full text-left text-sm">
                            <thead class="border-b-2 border-slate-300 dark:border-slate-600 sticky top-0 bg-[var(--color-bg)]">
                                <tr>
                                    <th class="p-2">Item</th>
                                    <th class="p-2">Referência</th>
                                    <th class="p-2">Tipo de Renda Aceito</th>
                                </tr>
                            </thead>
                            <tbody id="regras-irpf-tbody">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="cnpj-module" class="module-content hidden">
                    <h3 class="text-2xl font-bold mb-6">Consultar CNPJ</h3>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="cnpj-input" placeholder="00.000.000/0000-00" class="flex-grow p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                        <button id="consultar-cnpj" class="p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                            <i data-lucide="search" class="w-5 h-5"></i> Consultar
                        </button>
                        <button id="limpar-cnpj" class="p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                            <i data-lucide="x" class="w-5 h-5"></i> Limpar
                        </button>
                    </div>
                    <div id="cnpj-results-container" class="mt-6">
                        </div>
                </div>

                <div id="parecer-module" class="module-content hidden flex flex-col">
                    <div class="flex flex-col sm:flex-row items-center mb-6 gap-4 flex-shrink-0">
                        <div class="relative flex-grow w-full">
                            <input type="text" id="searchInput" placeholder="Pesquisar pareceres por tipo ou descrição..." class="w-full p-3 pr-12 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                            <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-subtle"></i>
                        </div>
                        <div class="w-full sm:w-auto">
                            <select id="parecer-category-filter" class="w-full p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                </select>
                        </div>
                    </div>
                    <div id="pareceresContainer" class="space-y-4 overflow-auto custom-scrollbar flex-grow">
                        </div>
                </div>
                
                <!-- INÍCIO DO MÓDULO CONTADOR ATUALIZADO -->
                <div id="contador-module" class="module-content hidden h-full flex flex-col gap-4">
                    <!-- Abas do Módulo Contador -->
                    <div class="flex mb-4 border-b border-slate-300 dark:border-slate-600 flex-shrink-0">
                        <button class="contador-tab-button py-2 px-4 font-semibold" data-tab="contador-main">Contador</button>
                        <button class="contador-tab-button py-2 px-4 font-semibold text-subtle" data-tab="contador-history">Histórico</button>
                    </div>

                    <!-- Conteúdo da Aba Principal do Contador -->
                    <div id="contador-main-tab" class="contador-tab-content flex flex-col gap-8 h-full">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div id="counters-grid" class="grid grid-cols-1 sm:grid-cols-2 grid-rows-2 gap-4 min-h-[320px]">
                               <!-- Contadores são inseridos aqui via JS -->
                            </div>
                            <div class="flex flex-col gap-4 p-4 md:p-6 rounded-2xl neumorphic-inset h-full justify-center">
                                 <h3 class="text-sm text-subtle uppercase tracking-wide">Configurações</h3>
                                 <div class="flex items-center justify-between">
                                     <label for="timer-toggle" class="font-medium text-sm">Modo Timer</label>
                                     <div class="toggle-container">
                                         <input type="checkbox" name="toggle" id="timer-toggle" class="toggle-checkbox"/>
                                         <label for="timer-toggle" class="toggle-label"></label>
                                     </div>
                                 </div>
                                 <div class="flex flex-col gap-2">
                                     <label for="increment-by-input" class="text-sm font-medium">Incrementar por</label>
                                     <input type="number" id="increment-by-input" value="1" class="w-full bg-transparent p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                 </div>
                                 <div class="flex flex-col gap-2">
                                     <label for="counter-start-input" class="text-sm font-medium">Valor Inicial</label>
                                     <input type="number" id="counter-start-input" value="0" class="w-full bg-transparent p-3 rounded-2xl neumorphic-inset focus:outline-none text-sm">
                                 </div>
                                  <div class="grid grid-cols-2 gap-4 mt-2">
                                     <button id="add-counter-btn" class="w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase text-xs transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                         <i data-lucide="plus-circle" class="w-4 h-4"></i> Adicionar
                                     </button>
                                      <button id="finalizar-dia-btn" class="w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase text-xs transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2">
                                         <i data-lucide="check-circle" class="w-4 h-4"></i> Finalizar Dia
                                     </button>
                                  </div>
                                  <button id="contador-reset" class="col-span-2 w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase text-xs transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2 text-red-500">
                                     <i data-lucide="trash-2" class="w-4 h-4"></i> Resetar Tudo
                                 </button>
                            </div>
                        </div>
                        <!-- Seção Inferior: Gráfico de Atividade por Hora -->
                        <div class="p-4 rounded-2xl neumorphic-inset flex-1 flex flex-col min-h-[200px]">
                            <h3 class="text-sm text-subtle uppercase tracking-wide mb-4 flex-shrink-0">Atividade por Hora (Hoje)</h3>
                            <div class="relative flex-grow">
                                <canvas id="counter-chart"></canvas>
                            </div>
                        </div>
                         <div id="finalizar-dia-feedback" class="text-center p-4 rounded-2xl neumorphic-inset text-green-500 font-semibold hidden animate-fade-in"></div>
                    </div>

                    <!-- Conteúdo da Aba de Histórico -->
                    <div id="contador-history-tab" class="contador-tab-content hidden h-full">
                        <div class="flex flex-col h-full gap-4">
                            <div class="flex items-center justify-center gap-2 flex-wrap">
                                <button class="history-filter-btn p-2 px-4 rounded-xl neumorphic-outset-sm text-sm font-semibold" data-period="week">Última Semana</button>
                                <button class="history-filter-btn p-2 px-4 rounded-xl neumorphic-outset-sm text-sm font-semibold" data-period="month">Últimos 12 Meses</button>
                                <button class="history-filter-btn p-2 px-4 rounded-xl neumorphic-outset-sm text-sm font-semibold" data-period="year">Últimos 10 Anos</button>
                            </div>
                            <div class="p-4 rounded-2xl neumorphic-inset flex-1 flex flex-col min-h-[300px]">
                                <h3 id="history-chart-title" class="text-sm text-subtle uppercase tracking-wide mb-4 flex-shrink-0 text-center"></h3>
                                <div class="relative flex-grow">
                                    <canvas id="history-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- FIM DO MÓDULO CONTADOR ATUALIZADO -->

                <div id="checklist-module" class="module-content hidden flex flex-col gap-4 h-full">
                    </div>
            </div>
        </main>

        <nav class="fixed bottom-0 left-0 right-0 p-4 w-full flex justify-center">
            <div id="dock-container" class="relative flex items-center justify-start rounded-full neumorphic-outset overflow-x-auto max-w-full py-1">
                <div id="dock-slider" class="absolute top-0 bottom-0 rounded-full neumorphic-inset"></div>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="faturamento-module" data-title="Cálculo Renda PJ">Renda PJ</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="renda-pf-module" data-title="Cálculo Renda PF">Renda PF</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="cnpj-module" data-title="Consulta CNPJ">Consulta CNPJ</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="contador-module" data-title="Contador">Contador</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="regras-module" data-title="Regras IRPF">Regras</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="parecer-module" data-title="Pareceres">Pareceres</button>
                <button class="dock-button relative z-10 px-4 py-3 whitespace-nowrap text-sm" data-target="checklist-module" data-title="Checklist">Checklist</button>
            </div>
        </nav>
    </div>

    <!-- MODAL DE VISUALIZAÇÃO DE IMAGEM -->
    <div id="image-viewer-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden bg-black/80 backdrop-blur-sm overflow-hidden">
        <button id="image-viewer-close" class="absolute top-4 right-4 text-white p-2 rounded-full transition-colors z-20 hover:bg-white/20">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 flex items-center gap-2">
            <button id="zoom-out-btn" class="text-white p-2 rounded-full transition-colors hover:bg-white/20">
                <i data-lucide="zoom-out" class="w-6 h-6"></i>
            </button>
            <button id="zoom-in-btn" class="text-white p-2 rounded-full transition-colors hover:bg-white/20">
                <i data-lucide="zoom-in" class="w-6 h-6"></i>
            </button>
        </div>
        <div id="image-viewer-wrapper" class="relative w-full h-full flex items-center justify-center image-viewer-content-wrapper">
            <img id="image-viewer-content" src="" alt="Imagem Ampliada" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
        </div>
    </div>

    <!-- MODAL DE INFORMAÇÕES (CRÉDITOS) -->
    <div id="info-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="modal-overlay absolute inset-0 bg-[var(--color-bg)] opacity-80"></div>
        <div class="modal-content relative w-full max-w-lg p-6 rounded-2xl neumorphic-outset animate-fade-in">
            <button class="modal-close-btn absolute top-4 right-4 p-2 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/10 dark:hover:bg-white/10">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-accent">Créditos e Uso</h2>
            <div class="text-sm space-y-3">
                <p><strong>Desenvolvido por:</strong> Wellington Juan Dutra Oliveira</p>
                <p><strong>Com colaboração de:</strong></p>
                <ul class="list-disc list-inside pl-4 text-subtle">
                    <li>Gabriel Artur Lopes Feltes (Coordenador de BPO)</li>
                    <li>Mauricio Gabriel Freiberger Konig (Líder de BPO)</li>
                    <li>Erika Mendonça Figueira (Assistente de BPO)</li>
                    <li>Bruno Corrêa Alves (Assistente de BPO)</li>
                </ul>
                <p><strong>Lembrete de Uso:</strong></p>
                <p class="text-subtle">Esta ferramenta é de uso exclusivo para colaboradores da Meta Serviços em Informática S.A. a serviço do Sicoob. É proibida a cópia, distribuição ou uso fora do âmbito profissional designado.</p>
                <p class="text-xs text-center text-subtle pt-4 mt-4 border-t border-[var(--color-shadow-2)]">© 2025 Wellington Juan Dutra Oliveira e colaboradores. Todos os direitos reservados.</p>
            </div>
        </div>
    </div>

    <template id="counter-template">
        <div class="counter-card p-3 rounded-2xl neumorphic-inset flex flex-col items-center justify-center gap-2 relative h-full">
            <button class="star-btn absolute top-2 left-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                <i data-lucide="star" class="star-icon w-4 h-4"></i>
            </button>
            <button class="remove-counter-btn absolute top-2 right-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
            <h4 class="counter-title font-semibold text-center w-full px-8 truncate" contenteditable="true">Contador</h4>
            <span class="counter-display font-bold text-6xl text-accent cursor-pointer" contenteditable="false">0</span>
            <div class="flex items-center gap-3">
                <button class="counter-minus w-12 h-12 rounded-2xl neumorphic-outset-sm text-2xl font-bold active:scale-95 transition-transform flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/5">-</button>
                <button class="counter-plus w-12 h-12 rounded-2xl neumorphic-outset-sm text-2xl font-bold active:scale-95 transition-transform flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/5">+</button>
                
                <button class="timer-play w-12 h-12 rounded-2xl neumorphic-outset-sm text-2xl font-bold active:scale-95 transition-transform flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/5 hidden"><i data-lucide="play"></i></button>
                <button class="timer-reset w-12 h-12 rounded-2xl neumorphic-outset-sm text-2xl font-bold active:scale-95 transition-transform flex items-center justify-center hover:bg-black/5 dark:hover:bg-white/5 hidden"><i data-lucide="rotate-cw"></i></button>
            </div>
        </div>
    </template>

    <script>
        // --- FUNÇÕES GLOBAIS ---
        function copyParecer(text, buttonElement) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = 0;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            if (buttonElement) {
                const icon = buttonElement.querySelector('i');
                const originalIcon = icon.dataset.lucide;
                icon.dataset.lucide = 'check';
                if (typeof lucide !== 'undefined') lucide.createIcons();

                setTimeout(() => {
                    icon.dataset.lucide = originalIcon;
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 1500);
            }
        }

        window.onload = () => {
            // --- SELEÇÃO DOS ELEMENTOS DO DOM ---
            const themeToggleButton = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const dockContainer = document.getElementById('dock-container');
            const dockSlider = document.getElementById('dock-slider');
            const dockButtons = document.querySelectorAll('.dock-button');
            const moduleTitle = document.getElementById('module-title');
            const modules = document.querySelectorAll('.module-content');
            const infoButton = document.getElementById('info-button');
            const infoModal = document.getElementById('info-modal');
            const modalOverlay = infoModal.querySelector('.modal-overlay');
            const modalCloseBtn = infoModal.querySelector('.modal-close-btn');
            const mainContent = document.getElementById('main-content');

            // --- Elementos do Modal de Termos ---
            const termsModal = document.getElementById('terms-modal');
            const acceptTermsBtn = document.getElementById('accept-terms-btn');
            const termsCheckbox = document.getElementById('terms-checkbox');
            
            // --- Elementos do Modal de Visualização de Imagem ---
            const imageViewerModal = document.getElementById('image-viewer-modal');
            const imageViewerClose = document.getElementById('image-viewer-close');
            const imageViewerContent = document.getElementById('image-viewer-content');
            const zoomInBtn = document.getElementById('zoom-in-btn');
            const zoomOutBtn = document.getElementById('zoom-out-btn');

            // --- Variável de estado para o Checklist ---
            let checklistState = {};


            // --- FUNÇÕES AUXILIARES ---
            function formatCurrency(value) {
                if (isNaN(value) || !isFinite(value)) {
                    return "R$ 0,00";
                }
                return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            }

            function parseLocalFloat(value) {
                return parseFloat(String(value).replace(/\./g, '').replace(',', '.')) || 0;
            }

            function safeCreateIcons() {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }

            // --- LÓGICA DO MODO CLARO/ESCURO ---
            themeToggleButton.addEventListener('click', () => {
                document.documentElement.classList.toggle('dark');
                updateThemeIcons();
                // Atualiza os gráficos se eles estiverem visíveis
                if (currentModuleId === 'contador-module') {
                    if(counterChart) updateCounterChart();
                    if(historyChart) {
                        const activeFilter = document.querySelector('.history-filter-btn.active');
                        if (activeFilter) {
                            renderHistoryChart(activeFilter.dataset.period);
                        }
                    }
                }
            });
            
            function updateThemeIcons() {
                safeCreateIcons();
                const isDarkMode = document.documentElement.classList.contains('dark');
                sunIcon.classList.toggle('hidden', isDarkMode);
                moonIcon.classList.toggle('hidden', !isDarkMode);
            }

            // --- LÓGICA DO MODAL DE INFORMAÇÕES (CRÉDITOS) ---
            infoButton.addEventListener('click', () => {
                infoModal.classList.remove('hidden');
                mainContent.classList.add('blurred');
                safeCreateIcons();
            });

            function closeModal() {
                infoModal.classList.add('hidden');
                mainContent.classList.remove('blurred');
            }

            modalOverlay.addEventListener('click', closeModal);
            modalCloseBtn.addEventListener('click', closeModal);
            
            // --- LÓGICA DO MODAL DE VISUALIZAÇÃO DE IMAGEM COM ZOOM ---
            let zoomLevel = 1;
            let isDragging = false;
            let startX, startY, translateX = 0, translateY = 0;

            function applyTransform() {
                imageViewerContent.style.transform = `translate(${translateX}px, ${translateY}px) scale(${zoomLevel})`;
            }

            function openImageViewer(src) {
                if (!imageViewerModal || !mainContent || !imageViewerContent) return;
                imageViewerContent.src = src;
                imageViewerModal.classList.remove('hidden');
                mainContent.classList.add('blurred');
                safeCreateIcons();
            }

            function closeImageViewer() {
                if (!imageViewerModal || !mainContent) return;
                imageViewerModal.classList.add('hidden');
                mainContent.classList.remove('blurred');
                imageViewerContent.src = ''; // Limpa o src para evitar flash da imagem antiga
                // Reset zoom and pan on close
                zoomLevel = 1;
                translateX = 0;
                translateY = 0;
                applyTransform();
            }

            zoomInBtn.addEventListener('click', () => {
                zoomLevel = Math.min(zoomLevel + 0.2, 5); // Max zoom 5x
                applyTransform();
            });

            zoomOutBtn.addEventListener('click', () => {
                zoomLevel = Math.max(zoomLevel - 0.2, 0.5); // Min zoom 0.5x
                if (zoomLevel <= 1) { // Reset pan when zooming out to fit
                    translateX = 0;
                    translateY = 0;
                }
                applyTransform();
            });

            imageViewerContent.addEventListener('wheel', (e) => {
                e.preventDefault();
                if (e.deltaY < 0) {
                    zoomInBtn.click();
                } else {
                    zoomOutBtn.click();
                }
            });

            imageViewerContent.addEventListener('mousedown', (e) => {
                if (zoomLevel > 1) {
                    e.preventDefault();
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    imageViewerContent.classList.add('dragging');
                }
            });

            window.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    e.preventDefault();
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    applyTransform();
                }
            });

            window.addEventListener('mouseup', () => {
                isDragging = false;
                imageViewerContent.classList.remove('dragging');
            });


            imageViewerClose.addEventListener('click', closeImageViewer);
            imageViewerModal.addEventListener('click', (e) => {
                if (e.target === imageViewerModal) { // Fecha apenas se clicar no fundo
                    closeImageViewer();
                }
            });


            // --- LÓGICA DA NAVEGAÇÃO E MÓDULOS ---
            let currentModuleId = null;

            function updateSlider(button) {
                if (!button) return;
                const containerRect = dockContainer.getBoundingClientRect();
                const buttonRect = button.getBoundingClientRect();
                dockSlider.style.width = `${buttonRect.width}px`;
                dockSlider.style.left = `${buttonRect.left - containerRect.left}px`;
                dockButtons.forEach(btn => btn.classList.remove('text-accent', 'font-semibold'));
                button.classList.add('text-accent', 'font-semibold');
            }

            dockButtons.forEach((button) => {
                button.addEventListener('click', () => {
                    const targetModuleId = button.dataset.target;
                    if (targetModuleId === currentModuleId) return;
                    currentModuleId = targetModuleId;
                    
                    const targetTitle = button.dataset.title;
                    updateSlider(button);
                    moduleTitle.textContent = targetTitle;
                    
                    modules.forEach(module => module.classList.add('hidden'));
                    const activeModule = document.getElementById(targetModuleId);
                    if (activeModule) {
                       activeModule.classList.remove('hidden');
                       if (targetModuleId === 'regras-module') renderRegrasTable();
                       if (targetModuleId === 'parecer-module') {
                            populateParecerFilter();
                            filterPareceres();
                       }
                       if (targetModuleId === 'contador-module') {
                           loadCountersState();
                           setTimeout(() => {
                               updateCounterChart();
                               const defaultFilter = document.querySelector('.history-filter-btn[data-period="week"]');
                               if(defaultFilter) defaultFilter.click();
                           }, 50);
                       }
                       if (targetModuleId === 'checklist-module') {
                           renderChecklist();
                       }
                    }
                });
            });
            
            // --- LÓGICA DO MÓDULO DE FATURAMENTO (ABAS E CÁLCULOS) ---
            const faturamentoTabButtons = document.querySelectorAll('.faturamento-tab-button');
            const faturamentoTabContents = document.querySelectorAll('.faturamento-tab-content');
            
            faturamentoTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = `${button.dataset.tab}-tab`;
                    faturamentoTabButtons.forEach(btn => btn.classList.add('text-subtle'));
                    button.classList.remove('text-subtle');
                    faturamentoTabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== targetTabId);
                    });
                    safeCreateIcons();
                });
            });

            // Aba 1: Calculo do Simples
            const faturamentoForm = document.getElementById('faturamento-form');
            document.getElementById('calcular-faturamento').addEventListener('click', () => {
                const rbt12 = parseLocalFloat(document.getElementById('rbt12').value);
                const rpa = parseLocalFloat(document.getElementById('rpa').value);
                const mesAnterior = parseLocalFloat(document.getElementById('mes_anterior').value);
                const numMeses = parseInt(document.getElementById('num_meses').value) || 0;
                document.getElementById('resultado1').textContent = formatCurrency(rbt12 / 12);
                document.getElementById('resultado2').textContent = formatCurrency(((rbt12 + rpa) - mesAnterior) / 12);
                document.getElementById('resultado3').textContent = formatCurrency(numMeses > 0 ? (rpa + rbt12) / numMeses : 0);
            });
            document.getElementById('limpar-faturamento').addEventListener('click', () => {
                faturamentoForm.reset();
                document.getElementById('resultado1').textContent = formatCurrency(0);
                document.getElementById('resultado2').textContent = formatCurrency(0);
                document.getElementById('resultado3').textContent = formatCurrency(0);
            });

            // Aba 2: Rel. Faturamento
            const relFaturamentoInputsContainer = document.getElementById('rel-faturamento-inputs');
            for (let i = 1; i <= 12; i++) {
                relFaturamentoInputsContainer.innerHTML += `
                    <div class="flex items-center gap-2">
                        <label for="rel-mes-${i}" class="w-20 text-sm font-medium">Mês ${i}</label>
                        <input type="text" inputmode="decimal" id="rel-mes-${i}" placeholder="R$ 0,00" class="rel-faturamento-input w-full p-2 rounded-xl neumorphic-inset focus:outline-none text-sm">
                    </div>
                `;
            }
            const relFaturamentoInputs = document.querySelectorAll('.rel-faturamento-input');
            const calcularRelFaturamento = () => {
                let total = 0;
                relFaturamentoInputs.forEach(input => {
                    total += parseLocalFloat(input.value);
                });
                document.getElementById('rel-faturamento-renda-12-meses').textContent = formatCurrency(total);
                document.getElementById('rel-faturamento-renda-mensal').textContent = formatCurrency(total / 12);
            };
            relFaturamentoInputs.forEach(input => input.addEventListener('input', calcularRelFaturamento));
            document.getElementById('rel-faturamento-limpar').addEventListener('click', () => {
                relFaturamentoInputs.forEach(input => input.value = '');
                calcularRelFaturamento();
            });

            // Aba 3: Semoventes
            const semoventesTbody = document.getElementById('semoventes-tbody');
            const semoventesData = [
                'Matrizes (+ 36 meses)', 'Touros', 'Bois (+ 36 meses)', 'Novilhas (25 a 36 meses)',
                'Novilhos (25 a 36 meses)', 'Novilhas (13 a 24 meses)', 'Novilhos (13 a 24 meses)',
                'Bezerras/terneiras até 12 meses', 'Bezerros/terneiros até 12 meses'
            ];
            semoventesData.forEach((desc, index) => {
                semoventesTbody.innerHTML += `
                    <tr class="border-b border-slate-300 dark:border-slate-700">
                        <td class="p-2">${desc}</td>
                        <td class="p-2"><input type="number" id="semovente-qtd-${index}" class="semovente-input w-20 p-2 rounded-xl neumorphic-inset focus:outline-none text-sm" placeholder="0"></td>
                        <td class="p-2"><input type="text" inputmode="decimal" id="semovente-valor-${index}" class="semovente-input w-32 p-2 rounded-xl neumorphic-inset focus:outline-none text-sm" placeholder="R$ 0,00"></td>
                        <td class="p-2 font-semibold" id="semovente-total-${index}">R$ 0,00</td>
                    </tr>
                `;
            });
            const semoventeInputs = document.querySelectorAll('.semovente-input');
            const calcularSemoventes = () => {
                let grandTotalAnual = 0;
                let grandTotalQtd = 0;
                semoventesData.forEach((_, index) => {
                    const qtd = parseInt(document.getElementById(`semovente-qtd-${index}`).value) || 0;
                    const valor = parseLocalFloat(document.getElementById(`semovente-valor-${index}`).value);
                    const total = qtd * valor;
                    document.getElementById(`semovente-total-${index}`).textContent = formatCurrency(total);
                    grandTotalAnual += total;
                    grandTotalQtd += qtd;
                });
                document.getElementById('semoventes-qtd-total').textContent = grandTotalQtd;
                document.getElementById('semoventes-renda-anual').textContent = formatCurrency(grandTotalAnual);
                document.getElementById('semoventes-renda-mensal').textContent = formatCurrency(grandTotalAnual / 12);
            };
            semoventeInputs.forEach(input => input.addEventListener('input', calcularSemoventes));
            document.getElementById('semoventes-limpar').addEventListener('click', () => {
                semoventeInputs.forEach(input => input.value = '');
                calcularSemoventes();
            });

            // Aba 4: NF's
            const nfsGrid = document.getElementById('nfs-grid');
            for (let i = 1; i <= 50; i++) {
                nfsGrid.innerHTML += `
                    <div class="flex items-center gap-2">
                        <label for="nf-${i}" class="text-sm font-medium w-12"> ${i}</label>
                        <input type="text" inputmode="decimal" id="nf-${i}" class="nf-input w-full p-2 rounded-xl neumorphic-inset focus:outline-none text-sm" placeholder="0,00">
                    </div>
                `;
            }
            const nfInputs = document.querySelectorAll('.nf-input');
            const nfsPropriedadeInput = document.getElementById('nfs-propriedade');
            const calcularNFs = () => {
                let total = 0;
                nfInputs.forEach(input => {
                    total += parseLocalFloat(input.value);
                });
                const propriedade = parseLocalFloat(nfsPropriedadeInput.value) / 100;
                const rendaAnual = total * (propriedade > 0 ? propriedade : 1);
                document.getElementById('nfs-renda-anual').textContent = formatCurrency(rendaAnual);
                document.getElementById('nfs-renda-mensal').textContent = formatCurrency(rendaAnual / 12);
            };
            nfInputs.forEach(input => input.addEventListener('input', calcularNFs));
            nfsPropriedadeInput.addEventListener('input', calcularNFs);
            document.getElementById('nfs-limpar').addEventListener('click', () => {
                nfInputs.forEach(input => input.value = '');
                nfsPropriedadeInput.value = '100';
                calcularNFs();
            });

            // Aba 5: Quotas
            const quotasInputs = document.querySelectorAll('#quotas-tab input');
            const calcularQuotas = () => {
                // Bloco 1: Calcular %
                const valorTotal1 = parseLocalFloat(document.getElementById('quotas-valor-total-empresa-1').value);
                const valorAssociado1 = parseLocalFloat(document.getElementById('quotas-valor-associado-1').value);
                let percentual = 0;
                if (valorTotal1 > 0) {
                    percentual = (valorAssociado1 / valorTotal1) * 100;
                }
                document.getElementById('quotas-percentual-resultado').textContent = percentual.toFixed(2).replace('.', ',') + '%';

                // Bloco 2: Calcular Valor
                const valorTotal2 = parseLocalFloat(document.getElementById('quotas-valor-total-empresa-2').value);
                const percentualAssociado2 = parseLocalFloat(document.getElementById('quotas-percentual-associado-2').value);
                const valorMonetario = valorTotal2 * (percentualAssociado2 / 100);
                document.getElementById('quotas-valor-resultado').textContent = formatCurrency(valorMonetario);
            };
            quotasInputs.forEach(input => input.addEventListener('input', calcularQuotas));
            document.getElementById('quotas-limpar').addEventListener('click', () => {
                quotasInputs.forEach(input => input.value = '');
                calcularQuotas();
            });

            // Aba 6: FCPR
            const fcprInputsContainer = document.getElementById('fcpr-inputs');
            for (let i = 1; i <= 10; i++) {
                fcprInputsContainer.innerHTML += `
                    <div class="flex items-center gap-2">
                        <label for="fcpr-renda-${i}" class="w-24 text-sm font-medium">Renda ${i}</label>
                        <input type="text" inputmode="decimal" id="fcpr-renda-${i}" placeholder="R$ 0,00" class="fcpr-input w-full p-2 rounded-xl neumorphic-inset focus:outline-none text-sm">
                    </div>
                `;
            }
            const fcprInputs = document.querySelectorAll('.fcpr-input');
            const fcprPercentualInput = document.getElementById('fcpr-percentual');
            const fcprMesesInput = document.getElementById('fcpr-meses');
            const calcularFCPR = () => {
                let totalRendas = 0;
                fcprInputs.forEach(input => {
                    totalRendas += parseLocalFloat(input.value);
                });
                const percentual = parseLocalFloat(fcprPercentualInput.value) / 100;
                const meses = parseInt(fcprMesesInput.value) || 12;
                const rendaAnual = totalRendas * (percentual > 0 ? percentual : 1);
                document.getElementById('fcpr-renda-anual').textContent = formatCurrency(rendaAnual);
                document.getElementById('fcpr-renda-mensal').textContent = formatCurrency(meses > 0 ? rendaAnual / meses : 0);
            };
            fcprInputs.forEach(input => input.addEventListener('input', calcularFCPR));
            fcprPercentualInput.addEventListener('input', calcularFCPR);
            fcprMesesInput.addEventListener('input', calcularFCPR);
            document.getElementById('fcpr-limpar').addEventListener('click', () => {
                fcprInputs.forEach(input => input.value = '');
                fcprPercentualInput.value = '100';
                fcprMesesInput.value = '12';
                calcularFCPR();
            });


            // --- LÓGICA DO MÓDULO RENDA PF (ABAS E CÁLCULOS) ---
            const rendaPfTabButtons = document.querySelectorAll('.renda-pf-tab-button');
            const rendaPfTabContents = document.querySelectorAll('.renda-pf-tab-content');
            rendaPfTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = `${button.dataset.tab}-tab`;
                    rendaPfTabButtons.forEach(btn => btn.classList.add('text-subtle'));
                    button.classList.remove('text-subtle');
                    rendaPfTabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== targetTabId);
                    });
                });
            });

            // Aba 1: Calculadora SISBR
            const valorSisbrInput = document.getElementById('valor_sisbr');
            valorSisbrInput.addEventListener('input', () => {
                const valor = parseLocalFloat(valorSisbrInput.value);
                document.getElementById('sisbr_mult').textContent = formatCurrency(valor * 12);
                document.getElementById('sisbr_div').textContent = formatCurrency(valor / 12);
            });
            document.getElementById('limpar_sisbr').addEventListener('click', () => {
                valorSisbrInput.value = '';
                valorSisbrInput.dispatchEvent(new Event('input'));
            });

            // Aba 2: Média Holerites
            const mediaInputs = document.querySelectorAll('.media-holerite-input');
            const limparMediaBtn = document.getElementById('limpar_media');
            function calcularMedia() {
                let total = 0;
                let count = 0;
                mediaInputs.forEach(inp => {
                    const val = parseLocalFloat(inp.value);
                    if (!isNaN(val) && val > 0) {
                        total += val;
                        count++;
                    }
                });
                const media = count > 0 ? total / count : 0;
                document.getElementById('media_resultado').textContent = formatCurrency(media);
            }
            mediaInputs.forEach(input => input.addEventListener('input', calcularMedia));
            limparMediaBtn.addEventListener('click', () => {
                mediaInputs.forEach(input => input.value = '');
                calcularMedia();
            });

            // Aba 3: Soma de Valores
            const somaInputs = document.querySelectorAll('.soma-valor-input');
            const subInputs = document.querySelectorAll('.sub-valor-input');
            const limparSomaBtn = document.getElementById('limpar_soma');
            function calcularSomaTotal() {
                let totalSoma = 0;
                somaInputs.forEach(inp => totalSoma += parseLocalFloat(inp.value));
                let totalSub = 0;
                subInputs.forEach(inp => totalSub += parseLocalFloat(inp.value));
                const somaFinal = totalSoma - totalSub;
                document.getElementById('soma_total_resultado').textContent = formatCurrency(somaFinal);
                document.getElementById('soma_div12_resultado').textContent = formatCurrency(somaFinal / 12);
            }
            somaInputs.forEach(input => input.addEventListener('input', calcularSomaTotal));
            subInputs.forEach(input => input.addEventListener('input', calcularSomaTotal));
            limparSomaBtn.addEventListener('click', () => {
                somaInputs.forEach(input => input.value = '');
                subInputs.forEach(input => input.value = '');
                calcularSomaTotal();
            });

            // --- LÓGICA DO MÓDULO DE REGRAS (ABAS E FILTRO) ---
            const regrasTbody = document.getElementById('regras-irpf-tbody');
            
            function renderRegrasTable() {
                if(typeof regrasData === 'undefined' || !regrasTbody) return;
                regrasTbody.innerHTML = '';
                regrasData.forEach(regra => {
                    const row = `
                        <tr class="border-b border-slate-300 dark:border-slate-700">
                            <td class="p-2 font-semibold">${regra.item}</td>
                            <td class="p-2">${regra.ref}</td>
                            <td class="p-2">${regra.type.join(', ')}</td>
                        </tr>
                    `;
                    regrasTbody.innerHTML += row;
                });
            }

            // --- LÓGICA DO MÓDULO DE CONSULTA CNPJ ---
            const cnpjInput = document.getElementById('cnpj-input');
            const consultarCnpjBtn = document.getElementById('consultar-cnpj');
            const limparCnpjBtn = document.getElementById('limpar-cnpj');
            const cnpjResultsContainer = document.getElementById('cnpj-results-container');

            cnpjInput.addEventListener('input', (e) => {
                let value = e.target.value.replace(/\D/g, '');
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
                e.target.value = value.slice(0, 18);
            });

            consultarCnpjBtn.addEventListener('click', async () => {
                const cnpj = cnpjInput.value.replace(/\D/g, '');
                if (cnpj.length !== 14) {
                    cnpjResultsContainer.innerHTML = `<div class="p-4 rounded-2xl neumorphic-inset text-center text-red-500">Por favor, insira um CNPJ válido.</div>`;
                    return;
                }

                cnpjResultsContainer.innerHTML = `<div class="p-4 rounded-2xl neumorphic-inset text-center">Consultando...</div>`;

                try {
                    // Using a public CORS proxy for the CNPJ WS API
                    const response = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://publica.cnpj.ws/cnpj/${cnpj}`)}`);
                    if (!response.ok) throw new Error(`Network response was not ok: ${response.statusText}`);
                    
                    const data = await response.json();
                    const content = JSON.parse(data.contents);

                    if (content.status === 404) throw new Error("CNPJ não encontrado.");
                    if (content.status === 429) throw new Error("Muitas requisições. Por favor, aguarde um minuto.");
                    if (content.status && content.status !== 200) throw new Error(content.detalhes || `Erro ao consultar o CNPJ.`);

                    displayCnpjResults(content);
                } catch (error) {
                    cnpjResultsContainer.innerHTML = `<div class="p-4 rounded-2xl neumorphic-inset text-center text-red-500">${error.message}</div>`;
                }
            });


            function displayCnpjResults(data) {
                const isSimples = data.simples?.optante_pelo_simples ? 'Sim' : 'Não';
                const isSimei = data.simples?.optante_pelo_simei ? 'Sim' : 'Não';
                const porteEmpresa = data.porte?.descricao || 'Não informado';
                const lastUpdated = data.atualizado_em ? new Date(data.atualizado_em).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : 'Não informado';
                
                const nomeEmpresa = data.razao_social || 'Não informado'; 
                const data_abertura = data.data_inicio_atividade ? new Date(data.data_inicio_atividade.split('/').reverse().join('-')).toLocaleDateString('pt-BR') : 'Não informado';

                let sociosHtml = '<p class="text-subtle">Nenhum sócio encontrado.</p>';
                if (data.socios && data.socios.length > 0) {
                    sociosHtml = `<ul class="list-disc list-inside">${data.socios.map(socio => `<li>${socio.nome} <span class="text-subtle">(${socio.qualificacao_socio.descricao || 'Sócio'})</span></li>`).join('')}</ul>`;
                }

                const rawJsonHtml = `
                    <details class="mt-4">
                        <summary class="cursor-pointer font-semibold text-sm text-subtle">Ver resposta JSON completa</summary>
                        <pre class="mt-2 p-4 rounded-2xl neumorphic-inset text-xs overflow-auto custom-scrollbar"><code>${JSON.stringify(data, null, 2)}</code></pre>
                    </details>
                `;

                cnpjResultsContainer.innerHTML = `
                    <div class="space-y-4">
                        <div class="p-4 rounded-2xl neumorphic-inset">
                            <p class="text-sm text-subtle uppercase tracking-wide">Nome da Empresa</p>
                            <p class="text-lg font-bold text-accent mt-1">${nomeEmpresa}</p>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Data de Abertura</p>
                                <p class="font-semibold mt-1">${data_abertura}</p>
                            </div>
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Última Atualização</p>
                                <p class="font-semibold mt-1">${lastUpdated}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Situação Cadastral</p>
                                <p class="text-lg font-bold text-accent mt-1">${data.situacao_cadastral?.descricao || 'Não informado'}</p>
                            </div>
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Porte da Empresa</p>
                                <p class="font-semibold mt-1">${porteEmpresa}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Optante Simples</p>
                                <p class="text-lg font-bold text-accent mt-1">${isSimples}</p>
                            </div>
                            <div class="p-4 rounded-2xl neumorphic-inset">
                                <p class="text-sm text-subtle uppercase tracking-wide">Optante SIMEI</p>
                                <p class="text-lg font-bold text-accent mt-1">${isSimei}</p>
                            </div>
                        </div>
                        <div class="p-4 rounded-2xl neumorphic-inset">
                            <p class="text-sm text-subtle uppercase tracking-wide">Atividade Principal (CNAE)</p>
                            <p class="font-semibold mt-1">${data.estabelecimento?.atividade_principal?.descricao || 'Não informado'}</p>
                        </div>
                        <div class="p-4 rounded-2xl neumorphic-inset">
                            <p class="text-sm text-subtle uppercase tracking-wide mb-2">Sócios</p>
                            <div class="font-semibold">${sociosHtml}</div>
                        </div>
                        ${rawJsonHtml}
                    </div>
                `;
            };

            limparCnpjBtn.addEventListener('click', () => {
                cnpjInput.value = '';
                cnpjResultsContainer.innerHTML = '';
            });

            // --- LÓGICA DO MÓDULO DE PARECERES ---
            const searchInput = document.getElementById('searchInput');
            const parecerCategoryFilter = document.getElementById('parecer-category-filter');
            const pareceresContainer = document.getElementById('pareceresContainer');

            function populateParecerFilter() {
                if(typeof pareceresDataCorrigido === 'undefined' || !parecerCategoryFilter) return;
                parecerCategoryFilter.innerHTML = '<option value="all">Todas as Categorias</option>';
                for (const mainCategory in pareceresDataCorrigido) {
                    parecerCategoryFilter.innerHTML += `<option value="${mainCategory}">${mainCategory}</option>`;
                }
            }

            function renderPareceres(data) {
                pareceresContainer.innerHTML = '';
                let mainContentRendered = false;

                for (const mainCategory in data) {
                    const subCategories = data[mainCategory];
                    let mainCategoryHtml = `<h3 class="text-2xl font-bold mb-4 border-b-2 border-slate-300 dark:border-slate-600 pb-2">${mainCategory}</h3>`;
                    let contentHtml = '<div class="space-y-4">';
                    let hasSubResults = false;

                    function createParecerHTML(key, value, button) {
                        hasSubResults = true;
                        mainContentRendered = true;
                        const fullParecerText = `${key}: ${value}`;
                        return `
                            <div class="p-4 rounded-2xl neumorphic-inset flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                <div class="flex-1 min-w-0">
                                    <h5 class="font-semibold mb-1">${key}</h5>
                                    <p class="text-sm whitespace-normal break-words text-subtle">${value}</p>
                                </div>
                                <div class="flex-shrink-0 flex items-center self-start sm:self-center">
                                    <button class="p-2 rounded-2xl neumorphic-outset-sm text-sm font-bold transition duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center gap-2"
                                            onclick="copyParecer(decodeURIComponent('${encodeURIComponent(fullParecerText)}'), this)">
                                        <i data-lucide="copy" class="w-4 h-4"></i> Copiar
                                    </button>
                                </div>
                            </div>
                        `;
                    }

                    for (const subCategoryTitle in subCategories) {
                        const items = subCategories[subCategoryTitle];
                        if (typeof items === 'object' && items !== null) {
                            let subCategoryContent = '';
                            for (const key in items) {
                                subCategoryContent += createParecerHTML(key, items[key]);
                            }
                            if(subCategoryContent) {
                                contentHtml += `<h4 class="text-xl font-semibold mb-3 mt-4">${subCategoryTitle}</h4>` + subCategoryContent;
                            }
                        } else {
                            contentHtml += createParecerHTML(subCategoryTitle, items);
                        }
                    }
                    contentHtml += '</div>';
                    if (hasSubResults) {
                        pareceresContainer.innerHTML += mainCategoryHtml + contentHtml;
                    }
                }

                if (!mainContentRendered) {
                    pareceresContainer.innerHTML = `
                        <div class="text-center text-lg py-8 text-subtle">
                            Nenhum parecer encontrado para a sua pesquisa.
                        </div>
                    `;
                }
                 safeCreateIcons();
            }
            
            function filterPareceres() {
                if(typeof pareceresDataCorrigido === 'undefined' || !pareceresContainer) return;
                const searchTerm = searchInput.value.toLowerCase();
                const selectedCategory = parecerCategoryFilter.value;
                
                const sourceData = selectedCategory === 'all' 
                    ? pareceresDataCorrigido 
                    : { [selectedCategory]: pareceresDataCorrigido[selectedCategory] };

                const filteredData = {};
                for (const mainCategory in sourceData) {
                    const subCategories = sourceData[mainCategory];
                    const filteredSubCategories = {};
                    let hasMatch = false;
                    for (const subCategoryTitle in subCategories) {
                        const items = subCategories[subCategoryTitle];
                        if (typeof items === 'object' && items !== null) {
                            const filteredItems = {};
                            for(const key in items) {
                                if (key.toLowerCase().includes(searchTerm) || items[key].toLowerCase().includes(searchTerm)) {
                                    filteredItems[key] = items[key];
                                    hasMatch = true;
                                }
                            }
                            if(Object.keys(filteredItems).length > 0) {
                                filteredSubCategories[subCategoryTitle] = filteredItems;
                            }
                        } else {
                            if (subCategoryTitle.toLowerCase().includes(searchTerm) || items.toLowerCase().includes(searchTerm)) {
                                filteredSubCategories[subCategoryTitle] = items;
                                hasMatch = true;
                            }
                        }
                    }
                    if (hasMatch) {
                        filteredData[mainCategory] = filteredSubCategories;
                    }
                }
                renderPareceres(filteredData);
            }

            searchInput.addEventListener('input', filterPareceres);
            parecerCategoryFilter.addEventListener('change', filterPareceres);

            // --- LÓGICA DO MÓDULO CONTADOR ---
            const countersGrid = document.getElementById('counters-grid');
            const addCounterBtn = document.getElementById('add-counter-btn');
            const counterTemplate = document.getElementById('counter-template');
            const incrementInput = document.getElementById('increment-by-input');
            const startInput = document.getElementById('counter-start-input');
            const timerToggle = document.getElementById('timer-toggle');
            const resetAllBtn = document.getElementById('contador-reset');
            const finalizarDiaBtn = document.getElementById('finalizar-dia-btn');
            const finalizarDiaFeedback = document.getElementById('finalizar-dia-feedback');

            let counters = [];
            let counterChart = null;
            let historyChart = null;
            const DAILY_HISTORY_KEY = 'apoioBpoDailyHistory';
            const INCREMENT_HISTORY_KEY = 'apoioBpoIncrementHistory';

            function saveCountersState() {
                const state = counters.map(c => ({
                    id: c.id,
                    title: c.getTitle(),
                    value: c.getValue(),
                    isTimer: c.isTimer,
                    isStarred: c.isStarred, // Salva o estado da estrela
                    initialTimerValue: c.initialTimerValue
                }));
                localStorage.setItem('apoioBpoCountersState', JSON.stringify(state));
            }

            function loadCountersState() {
                const savedState = JSON.parse(localStorage.getItem('apoioBpoCountersState') || 'null');
                countersGrid.innerHTML = ''; 
                counters = [];

                if (savedState && savedState.length > 0) {
                    savedState.forEach(state => {
                        createCounterInstance(state.id, state.value, state.isTimer, state.title, state.initialTimerValue, state.isStarred);
                    });
                } else {
                    // Cria o primeiro contador como "starred" por padrão
                    createCounterInstance(Date.now(), 0, false, "Contador Principal", undefined, true);
                }
                updateCountersLayout();
            }

            function updateCountersLayout() {
                const count = counters.length;
                const cards = countersGrid.querySelectorAll('.counter-card');
                cards.forEach(card => {
                    card.classList.remove('sm:col-span-2', 'sm:row-span-2');
                });
                
                if (count === 1) {
                    cards[0].classList.add('sm:col-span-2', 'sm:row-span-2');
                } else if (count === 2) {
                    cards.forEach(card => card.classList.add('sm:row-span-2'));
                } else if (count === 3) {
                    cards[2].classList.add('sm:col-span-2');
                }
            }
            
            function saveActivityToHistory(type, count) {
                let history = JSON.parse(localStorage.getItem(INCREMENT_HISTORY_KEY) || '[]');
                history.push({
                    timestamp: new Date().toISOString(),
                    type: type, // 'add' ou 'subtract'
                    count: count
                });
                localStorage.setItem(INCREMENT_HISTORY_KEY, JSON.stringify(history));
            }

            function updateCounterChart() {
                const chartCanvas = document.getElementById('counter-chart');
                if (!chartCanvas) return;
                const ctx = chartCanvas.getContext('2d');

                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const activityHistory = JSON.parse(localStorage.getItem(INCREMENT_HISTORY_KEY) || '[]');

                const todaysActivities = activityHistory
                    .map(item => ({ ...item, timestamp: new Date(item.timestamp) }))
                    .filter(item => item.timestamp >= today);

                const fixedLabels = [];
                for (let i = 6; i <= 19; i++) {
                    fixedLabels.push(`${i.toString().padStart(2, '0')}:00`);
                }
                
                let data = Array(fixedLabels.length).fill(0);

                todaysActivities.forEach(activity => {
                    const hour = activity.timestamp.getHours();
                    const index = hour - 6;
                    if (index >= 0 && index < data.length) {
                        if (activity.type === 'add') {
                            data[index] += activity.count;
                        } else if (activity.type === 'subtract') {
                            data[index] -= activity.count;
                        }
                    }
                });

                const isDarkMode = document.documentElement.classList.contains('dark');
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDarkMode ? '#d1d9e6' : '#5a6474';
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim();

                if (counterChart) {
                    counterChart.data.labels = fixedLabels;
                    counterChart.data.datasets[0].data = data;
                    counterChart.options.scales.x.ticks.color = textColor;
                    counterChart.options.scales.y.ticks.color = textColor;
                    counterChart.options.scales.x.grid.color = gridColor;
                    counterChart.options.scales.y.grid.color = gridColor;
                    counterChart.update();
                } else {
                    counterChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: fixedLabels,
                            datasets: [{
                                label: 'Atividades',
                                data: data,
                                backgroundColor: accentColor,
                                borderRadius: 5,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { 
                                        color: textColor, 
                                        stepSize: 1,
                                        callback: v => (Number.isInteger(v) ? v : null)
                                    },
                                    grid: { color: gridColor }
                                },
                                x: {
                                    ticks: { color: textColor },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
            }


            function createCounterInstance(id, initialValue, isTimer, title, initialTimerVal, isStarred = false) {
                const counterElement = counterTemplate.content.cloneNode(true).firstElementChild;
                counterElement.dataset.id = id;
                
                const titleElement = counterElement.querySelector('.counter-title');
                const display = counterElement.querySelector('.counter-display');
                const plusBtn = counterElement.querySelector('.counter-plus');
                const minusBtn = counterElement.querySelector('.counter-minus');
                const removeBtn = counterElement.querySelector('.remove-counter-btn');
                const starBtn = counterElement.querySelector('.star-btn');
                const playBtn = counterElement.querySelector('.timer-play');
                const resetBtn = counterElement.querySelector('.timer-reset');

                titleElement.textContent = title || (isTimer ? `Timer ${counters.length + 1}` : `Contador ${counters.length + 1}`);
                
                let value = initialValue;
                let timerInterval = null;
                let initialTimerValue = initialTimerVal || initialValue;

                const instance = {
                    id, element: counterElement, isTimer, isStarred, initialTimerValue,
                    getValue: () => value,
                    getTitle: () => titleElement.textContent,
                    setValue(newValue) {
                        value = newValue;
                        this.updateDisplay();
                    },
                    updateDisplay() {
                        if (isTimer) {
                            const minutes = Math.floor(value / 60).toString().padStart(2, '0');
                            const seconds = (value % 60).toString().padStart(2, '0');
                            display.textContent = `${minutes}:${seconds}`;
                        } else {
                            display.textContent = value;
                        }
                    },
                    remove() {
                        clearInterval(timerInterval);
                        counterElement.classList.add('animate-fade-out');
                        counterElement.addEventListener('animationend', () => {
                            counterElement.remove();
                            counters = counters.filter(c => c.id !== id);
                            updateCountersLayout();
                            saveCountersState();
                        }, { once: true });
                    }
                };
                
                starBtn.classList.toggle('active', instance.isStarred);
                
                starBtn.addEventListener('click', () => {
                    instance.isStarred = !instance.isStarred;
                    starBtn.classList.toggle('active', instance.isStarred);
                    saveCountersState();
                });

                removeBtn.addEventListener('click', instance.remove);
                titleElement.addEventListener('blur', saveCountersState);

                if (isTimer) {
                    // Lógica do Timer (inalterada)
                } else {
                    plusBtn.addEventListener('click', () => {
                        const change = parseInt(incrementInput.value) || 1;
                        value += change;
                        instance.updateDisplay();
                        if (instance.isStarred) {
                           saveActivityToHistory('add', change);
                           updateCounterChart();
                        }
                        saveCountersState();
                    });
                    
                    // *** CORREÇÃO: Event listener para o botão de subtrair com limite mínimo de 0 ***
                    minusBtn.addEventListener('click', () => {
                        const change = parseInt(incrementInput.value) || 1;
                        const originalValue = value;

                        // Garante que o valor não ficará negativo
                        const newValue = Math.max(0, originalValue - change);
                        
                        // Calcula a mudança real para registrar no histórico
                        const actualChange = originalValue - newValue;

                        value = newValue;
                        instance.updateDisplay();

                        // Só registra a subtração se o valor realmente diminuiu
                        if (instance.isStarred && actualChange > 0) {
                            saveActivityToHistory('subtract', actualChange);
                            updateCounterChart();
                        }
                        saveCountersState();
                    });
                }
                
                instance.updateDisplay();
                counters.push(instance);
                countersGrid.appendChild(counterElement);
                safeCreateIcons();
                counterElement.classList.add('animate-fade-in');
            }

            addCounterBtn.addEventListener('click', () => {
                if (counters.length >= 4) return;
                const initialValue = parseInt(startInput.value) || 0;
                const isTimer = timerToggle.checked;
                createCounterInstance(Date.now(), initialValue, isTimer, `Contador ${counters.length + 1}`, undefined, false);
                updateCountersLayout();
                saveCountersState();
            });
            
            finalizarDiaBtn.addEventListener('click', () => {
                const totalDoDia = counters
                    .filter(c => c.isStarred && !c.isTimer)
                    .reduce((sum, counter) => sum + counter.getValue(), 0);

                if (totalDoDia <= 0) {
                    finalizarDiaFeedback.textContent = "Nenhuma contagem (com estrela) para salvar hoje.";
                    finalizarDiaFeedback.classList.remove('hidden', 'text-green-500');
                    finalizarDiaFeedback.classList.add('text-yellow-500');
                    setTimeout(() => finalizarDiaFeedback.classList.add('hidden'), 3000);
                    return;
                }

                const history = JSON.parse(localStorage.getItem(DAILY_HISTORY_KEY) || '[]');
                const today = new Date().toISOString().slice(0, 10); // Formato YYYY-MM-DD

                const todayEntryIndex = history.findIndex(entry => entry.date === today);

                if (todayEntryIndex > -1) {
                    history[todayEntryIndex].count += totalDoDia;
                } else {
                    history.push({ date: today, count: totalDoDia });
                }

                localStorage.setItem(DAILY_HISTORY_KEY, JSON.stringify(history));

                // Resetar contadores
                const initialValue = parseInt(startInput.value) || 0;
                counters.forEach(counter => {
                    if (!counter.isTimer) {
                        counter.setValue(initialValue);
                    }
                });
                saveCountersState();

                // Feedback visual
                finalizarDiaFeedback.textContent = `Total de ${totalDoDia} salvo no histórico de hoje!`;
                finalizarDiaFeedback.classList.remove('hidden', 'text-yellow-500');
                finalizarDiaFeedback.classList.add('text-green-500');
                setTimeout(() => finalizarDiaFeedback.classList.add('hidden'), 3000);
            });

            resetAllBtn.addEventListener('click', () => {
                if (confirm("Você tem certeza que deseja resetar tudo? ISSO APAGARÁ TODOS OS CONTADORES E O HISTÓRICO DE CONTAGEM PERMANENTEMENTE.")) {
                    countersGrid.innerHTML = '';
                    counters = [];
                    
                    localStorage.removeItem(DAILY_HISTORY_KEY);
                    localStorage.removeItem('apoioBpoCountersState');
                    localStorage.removeItem(INCREMENT_HISTORY_KEY);

                    if (counterChart) {
                        counterChart.destroy();
                        counterChart = null;
                    }
                    if (historyChart) {
                        historyChart.destroy();
                        historyChart = null;
                    }
                    
                    updateCounterChart();
                    loadCountersState();
                }
            });

            // --- LÓGICA DO HISTÓRICO DO CONTADOR ---
            const contadorTabButtons = document.querySelectorAll('.contador-tab-button');
            const contadorTabContents = document.querySelectorAll('.contador-tab-content');
            const historyFilterButtons = document.querySelectorAll('.history-filter-btn');
            const historyChartTitle = document.getElementById('history-chart-title');

            contadorTabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTabId = `${button.dataset.tab}-tab`;
                    
                    contadorTabButtons.forEach(btn => btn.classList.add('text-subtle'));
                    button.classList.remove('text-subtle');
                    
                    contadorTabContents.forEach(content => {
                        content.classList.toggle('hidden', content.id !== targetTabId);
                    });

                    if (targetTabId === 'contador-history-tab') {
                        const activeFilter = document.querySelector('.history-filter-btn.active') || document.querySelector('.history-filter-btn[data-period="week"]');
                        activeFilter.classList.add('active');
                        renderHistoryChart(activeFilter.dataset.period);
                    }
                });
            });

            historyFilterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    historyFilterButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    renderHistoryChart(button.dataset.period);
                });
            });

            function getHistoryChartData(period) {
                const history = JSON.parse(localStorage.getItem(DAILY_HISTORY_KEY) || '[]');
                const now = new Date();
                
                if (period === 'week') {
                    const labels = [];
                    const data = Array(7).fill(0);
                    const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                    
                    for (let i = 6; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(now.getDate() - i);
                        labels.push(dayNames[d.getDay()]);
                        const dateString = d.toISOString().slice(0, 10);
                        
                        const dayEntry = history.find(entry => entry.date === dateString);
                        if (dayEntry) {
                            data[6 - i] = dayEntry.count;
                        }
                    }
                    return { labels, data, title: 'Contagem Finalizada na Última Semana' };
                }

                if (period === 'month') {
                    const labels = [];
                    const data = Array(12).fill(0);
                    const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

                    for (let i = 11; i >= 0; i--) {
                        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                        labels.push(`${monthNames[d.getMonth()]}/${d.getFullYear().toString().slice(-2)}`);
                        
                        const monthEntries = history.filter(entry => entry.date.startsWith(`${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`));
                        const monthTotal = monthEntries.reduce((sum, entry) => sum + entry.count, 0);
                        data[11-i] = monthTotal;
                    }
                    return { labels, data, title: 'Contagem Finalizada nos Últimos 12 Meses' };
                }

                if (period === 'year') {
                    const labels = [];
                    const data = Array(10).fill(0);
                    const currentYear = now.getFullYear();

                    for (let i = 9; i >= 0; i--) {
                        const year = currentYear - i;
                        labels.push(year.toString());
                        
                        const yearEntries = history.filter(entry => entry.date.startsWith(year.toString()));
                        const yearTotal = yearEntries.reduce((sum, entry) => sum + entry.count, 0);
                        data[9-i] = yearTotal;
                    }
                    return { labels, data, title: 'Contagem Finalizada nos Últimos 10 Anos' };
                }
            }

            function renderHistoryChart(period) {
                const chartCanvas = document.getElementById('history-chart');
                if (!chartCanvas) return;
                const ctx = chartCanvas.getContext('2d');
                
                const { labels, data, title } = getHistoryChartData(period);
                historyChartTitle.textContent = title;

                const isDarkMode = document.documentElement.classList.contains('dark');
                const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                const textColor = isDarkMode ? '#d1d9e6' : '#5a6474';
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--color-accent').trim();

                if (historyChart) {
                    historyChart.data.labels = labels;
                    historyChart.data.datasets[0].data = data;
                    historyChart.options.scales.x.ticks.color = textColor;
                    historyChart.options.scales.y.ticks.color = textColor;
                    historyChart.options.scales.x.grid.color = gridColor;
                    historyChart.options.scales.y.grid.color = gridColor;
                    historyChart.update();
                } else {
                    historyChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Adições',
                                data: data,
                                backgroundColor: accentColor,
                                borderRadius: 5,
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: textColor, stepSize: 1, callback: v => (Number.isInteger(v) ? v : null) },
                                    grid: { color: gridColor }
                                },
                                x: {
                                    ticks: { color: textColor },
                                    grid: { display: false }
                                }
                            }
                        }
                    });
                }
            }


            // --- LÓGICA DO MÓDULO CHECKLIST ---
            function handleChecklistChange(e) {
                const checkbox = e.target.closest('.checklist-item-checkbox');
                if (checkbox) {
                    const { flow, doc, itemKey } = checkbox.dataset;
                    if (flow && doc && itemKey) {
                        checklistState[flow] = checklistState[flow] || {};
                        checklistState[flow][doc] = checklistState[flow][doc] || {};
                        checklistState[flow][doc][itemKey] = checkbox.checked;
                    }
                }
            }

            function renderChecklist() {
                const container = document.getElementById('checklist-module');
                if (!container || typeof checklistData === 'undefined') return;
                
                container.innerHTML = `
                    <div id="checklist-flows-view"></div>
                    <div id="checklist-documents-view" class="hidden"></div>
                    <div id="checklist-items-view" class="hidden"></div>
                `;
                
                showFlowsView();
                
                container.addEventListener('click', handleChecklistNavigation);
                container.addEventListener('change', handleChecklistChange);
            }

            function handleChecklistNavigation(e) {
                const flowBtn = e.target.closest('.checklist-flow-btn');
                const docBtn = e.target.closest('.checklist-doc-btn');
                const backBtn = e.target.closest('.checklist-back-btn');
                const finishBtn = e.target.closest('.checklist-finish-btn');
                const copyResultBtn = e.target.closest('.checklist-copy-result-btn');
                const pageNextBtn = e.target.closest('.checklist-page-next');
                const pagePrevBtn = e.target.closest('.checklist-page-prev');
                const backToItemsBtn = e.target.closest('.checklist-back-to-items');
                const imageToView = e.target.closest('#image-viewer-container img');

                if (imageToView) {
                    openImageViewer(imageToView.src);
                    return;
                }
                if (flowBtn) {
                    showDocumentsView(flowBtn.dataset.flow);
                } else if (docBtn) {
                    showChecklistItemsView(docBtn.dataset.flow, docBtn.dataset.doc);
                } else if (backBtn) {
                    const targetView = backBtn.dataset.target;
                    const flowKey = backBtn.dataset.flow;
                    if (targetView === 'flows') {
                        showFlowsView();
                    } else if (targetView === 'documents') {
                        showDocumentsView(flowKey);
                    }
                } else if (finishBtn) {
                    const { flow, doc, page } = finishBtn.dataset;
                    
                    const allChecklistItems = Object.entries(checklistData.flows[flow].documents[doc].checklist || {});
                    const devolucoes = [];

                    allChecklistItems.forEach(([itemKey, parecerKey]) => {
                        const isChecked = checklistState[flow]?.[doc]?.[itemKey] || false;
                        if (!isChecked) {
                            const parecerText = findParecerText(parecerKey);
                            // Formata para "TÍTULO: Parecer completo."
                            const formattedParecer = `${parecerKey}: ${parecerText || 'Parecer não encontrado.'}`;
                            devolucoes.push(formattedParecer);
                        }
                    });

                    let resultHTML = '<div class="flex flex-col h-full">';
                    let parecerTextForCopy = "APROVAR";
                    if (devolucoes.length === 0) {
                        resultHTML += `<div class="flex-grow flex flex-col items-center justify-center text-center gap-4"><i data-lucide="party-popper" class="w-16 h-16 text-green-500"></i><p class="text-2xl text-green-500 font-bold">APROVAR</p></div>`;
                    } else {
                        parecerTextForCopy = devolucoes.join(' '); // Junta com espaço
                        resultHTML += `<div class="flex-grow"><p class="text-red-500 font-medium">${parecerTextForCopy}</p></div>`;
                    }

                    resultHTML += `
                        <div class="mt-auto pt-6 flex flex-col gap-4">
                             <button class="checklist-copy-result-btn w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2" data-text-to-copy="${encodeURIComponent(parecerTextForCopy)}">
                                <i data-lucide="copy" class="w-5 h-5"></i> Copiar Parecer
                            </button>
                            <button class="checklist-back-to-items w-full p-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5 flex items-center justify-center gap-2 text-accent" data-flow="${flow}" data-doc="${doc}" data-page="${page}">
                                <i data-lucide="arrow-left-circle" class="w-5 h-5"></i> Voltar
                            </button>
                        </div>
                    </div>
                    `;
                    
                    const itemsContainer = document.getElementById('checklist-items-container');
                    itemsContainer.innerHTML = resultHTML;
                    safeCreateIcons();

                } else if (copyResultBtn) {
                    const textToCopy = decodeURIComponent(copyResultBtn.dataset.textToCopy);
                    copyParecer(textToCopy, copyResultBtn);
                } else if (pageNextBtn) {
                    const { flow, doc, page } = pageNextBtn.dataset;
                    renderChecklistPage(flow, doc, parseInt(page) + 1);
                } else if (pagePrevBtn) {
                    const { flow, doc, page } = pagePrevBtn.dataset;
                    renderChecklistPage(flow, doc, parseInt(page) - 1);
                } else if (backToItemsBtn) {
                    const { flow, doc, page } = backToItemsBtn.dataset;
                    renderChecklistPage(flow, doc, parseInt(page));
                }
            }
            
            function showFlowsView() {
                const container = document.getElementById('checklist-module');
                container.querySelector('#checklist-flows-view').classList.remove('hidden');
                container.querySelector('#checklist-documents-view').classList.add('hidden');
                container.querySelector('#checklist-items-view').classList.add('hidden');

                const flowsView = container.querySelector('#checklist-flows-view');
                let html = '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">';
                for (const flowKey in checklistData.flows) {
                    const flow = checklistData.flows[flowKey];
                    html += `
                        <button class="checklist-flow-btn flex flex-col items-center justify-center text-center gap-2 p-3 rounded-2xl neumorphic-outset-sm aspect-square transition-all duration-200 active:scale-95 hover:neumorphic-inset" data-flow="${flowKey}">
                            <span class="text-4xl">${flow.icon}</span>
                            <span class="font-semibold">${flow.name}</span>
                        </button>
                    `;
                }
                html += '</div>';
                flowsView.innerHTML = html;
                safeCreateIcons();
            }

            function showDocumentsView(flowKey) {
                const container = document.getElementById('checklist-module');
                container.querySelector('#checklist-flows-view').classList.add('hidden');
                container.querySelector('#checklist-documents-view').classList.remove('hidden');
                container.querySelector('#checklist-items-view').classList.add('hidden');
                
                const documentsView = container.querySelector('#checklist-documents-view');
                documentsView.className = 'flex flex-col h-full'; 
                
                const flow = checklistData.flows[flowKey];
                
                let headerHtml = `
                    <div class="flex-shrink-0">
                        <div class="flex items-center justify-between gap-4 mb-4">
                            <div class="flex items-center gap-2">
                                <button class="checklist-back-btn p-3 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5" data-target="flows">
                                    <i data-lucide="arrow-left" class="w-5 h-5"></i>
                                </button>
                                <h3 class="text-xl font-bold truncate">${flow.name}</h3>
                            </div>
                            <div class="relative flex-grow min-w-0">
                                 <input type="text" id="checklist-doc-search" placeholder="Buscar..." class="w-full p-3 pr-10 rounded-2xl neumorphic-inset focus:outline-none text-sm" data-flow="${flowKey}">
                                 <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-subtle"></i>
                            </div>
                        </div>
                    </div>
                `;

                let contentHtml = '';
                const docKeys = Object.keys(flow.documents);

                if (docKeys.length > 0) {
                    contentHtml = `
                        <div id="checklist-doc-list-container" class="flex-grow overflow-y-auto custom-scrollbar max-h-[50vh] p-3">
                            <!-- A lista de documentos será renderizada aqui -->
                        </div>
                    `;
                } else {
                     contentHtml = `
                        <div class="flex-grow flex flex-col items-center justify-center h-full min-h-[300px] gap-4 text-center p-4 rounded-2xl neumorphic-inset">
                            <i data-lucide="wrench" class="w-12 h-12 text-subtle"></i>
                            <p class="text-lg font-medium text-subtle">Os checklists para ${flow.name} estão sendo construídos.</p>
                        </div>
                    `;
                }

                documentsView.innerHTML = headerHtml + contentHtml;

                if (docKeys.length > 0) {
                    renderDocumentList(flowKey, '');
                }

                const searchInput = document.getElementById('checklist-doc-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        renderDocumentList(flowKey, e.target.value);
                    });
                }

                safeCreateIcons();
            }

            function renderDocumentList(flowKey, searchTerm) {
                const listContainer = document.getElementById('checklist-doc-list-container');
                if (!listContainer) return;

                const flow = checklistData.flows[flowKey];
                const lowerCaseSearchTerm = searchTerm.toLowerCase().trim();

                const filteredDocKeys = Object.keys(flow.documents).filter(docKey => {
                    const doc = flow.documents[docKey];
                    return doc.name.toLowerCase().includes(lowerCaseSearchTerm);
                });

                let listHtml = '<div class="grid grid-cols-2 sm:grid-cols-4 gap-4">';
                if (filteredDocKeys.length > 0) {
                    filteredDocKeys.forEach(docKey => {
                        const doc = flow.documents[docKey];
                        listHtml += `
                            <button class="checklist-doc-btn flex flex-col items-center justify-center text-center gap-2 p-3 rounded-2xl neumorphic-outset-sm aspect-square transition-all duration-200 active:scale-95 hover:neumorphic-inset" data-flow="${flowKey}" data-doc="${docKey}">
                                <span class="text-3xl">${doc.icon}</span>
                                <span class="text-xs font-medium">${doc.name}</span>
                            </button>
                        `;
                    });
                } else {
                    listHtml += `<div class="col-span-full text-center py-8 text-subtle">Nenhum documento encontrado.</div>`;
                }
                listHtml += '</div>';

                listContainer.innerHTML = listHtml;
            }

            function showChecklistItemsView(flowKey, docKey) {
                const container = document.getElementById('checklist-module');
                container.querySelector('#checklist-flows-view').classList.add('hidden');
                container.querySelector('#checklist-documents-view').classList.add('hidden');
                container.querySelector('#checklist-items-view').classList.remove('hidden');

                const itemsView = container.querySelector('#checklist-items-view');
                const doc = checklistData.flows[flowKey].documents[docKey];

                itemsView.innerHTML = `
                    <div class="animate-fade-in">
                        <div class="flex items-center flex-shrink-0 mb-6">
                            <button class="checklist-back-btn p-3 rounded-full neumorphic-outset-sm transition-all duration-200 active:scale-95 hover:bg-black/5 dark:hover:bg-white/5" data-target="documents" data-flow="${flowKey}">
                                <i data-lucide="arrow-left" class="w-5 h-5"></i>
                            </button>
                            <h3 class="text-xl font-bold ml-4 flex items-center gap-2"><span class="text-2xl">${doc.icon}</span> ${doc.name}</h3>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-start">
                             <div class="flex flex-col gap-6 sticky top-4">
                                <div id="image-viewer-container" class="p-2 rounded-2xl neumorphic-outset relative min-h-[400px] flex-grow">
                                    <!-- Imagem aparece aqui -->
                                </div>
                                <div id="image-pagination-controls" class="flex justify-center">
                                    <!-- Paginação SÓ PARA IMAGENS -->
                                </div>
                            </div>

                            <div id="checklist-items-container" class="p-6 rounded-2xl neumorphic-inset flex flex-col h-full min-h-[50vh]">
                                <!-- Itens do checklist e sua paginação aparecem aqui -->
                            </div>
                        </div>
                    </div>
                `;
                
                const imageContainer = itemsView.querySelector('#image-viewer-container');
                const imagePaginationContainer = itemsView.querySelector('#image-pagination-controls');
                
                if (doc.imageUrl || doc.imageUrls) {
                    setupImageSlider(doc, imageContainer, imagePaginationContainer);
                } else {
                    imageContainer.innerHTML = `<div class="flex items-center justify-center h-full text-subtle">Nenhum documento para exibir.</div>`;
                }

                renderChecklistPage(flowKey, docKey, 0);
            }

            function setupImageSlider(doc, imageContainer, paginationContainer) {
                const images = doc.imageUrls || (doc.imageUrl ? [doc.imageUrl] : []);
                if (images.length === 0) return;

                let currentIndex = 0;

                function updateView() {
                    const currentImage = images[currentIndex];
                    imageContainer.innerHTML = `<img src="${currentImage}" alt="Documento" class="w-full h-full object-contain rounded-xl image-viewer-content cursor-pointer" onerror="this.onerror=null;this.src='https://placehold.co/400x550/e0e5ec/5a6474?text=Imagem+indisponível';">`;
                    
                    if (images.length > 1) {
                        paginationContainer.innerHTML = `
                            <div class="flex items-center justify-center gap-4">
                                <button ${currentIndex === 0 ? 'disabled' : ''} class="checklist-image-prev p-3 rounded-full neumorphic-outset-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-90">
                                    <i data-lucide="arrow-left" class="w-5 h-5 pointer-events-none"></i>
                                </button>
                                <div class="flex gap-2 items-center">
                                    ${images.map((_, i) => `<div class="pagination-dot ${i === currentIndex ? 'active' : ''}"></div>`).join('')}
                                </div>
                                <button ${currentIndex === images.length - 1 ? 'disabled' : ''} class="checklist-image-next p-3 rounded-full neumorphic-outset-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-90">
                                    <i data-lucide="arrow-right" class="w-5 h-5 pointer-events-none"></i>
                                </button>
                            </div>
                        `;
                        safeCreateIcons();
                    }
                }

                paginationContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.checklist-image-next')) {
                        if (currentIndex < images.length - 1) {
                            currentIndex++;
                            updateView();
                        }
                    }
                    if (e.target.closest('.checklist-image-prev')) {
                        if (currentIndex > 0) {
                            currentIndex--;
                            updateView();
                        }
                    }
                });

                updateView();
            }

            function renderChecklistPage(flowKey, docKey, pageIndex) {
                const itemsContainer = document.getElementById('checklist-items-container');
                if (!itemsContainer) return;

                const doc = checklistData.flows[flowKey].documents[docKey];
                const checklistItems = Object.entries(doc.checklist || {});
                const itemsPerPage = 8;
                const totalPages = Math.ceil(checklistItems.length / itemsPerPage);

                const start = pageIndex * itemsPerPage;
                const end = start + itemsPerPage;
                const pageItems = checklistItems.slice(start, end);

                let checklistHtml = '<ul class="space-y-4 flex-grow">';
                pageItems.forEach(([itemKey, parecerKey]) => {
                    const isChecked = checklistState[flowKey]?.[docKey]?.[itemKey] || false;
                    checklistHtml += `
                        <li class="checklist-list-item p-3 rounded-lg transition-colors duration-200">
                            <label class="flex items-start gap-4 cursor-pointer">
                                <input type="checkbox" class="checklist-item-checkbox hidden" 
                                       data-parecer-key="${parecerKey}"
                                       data-item-key="${itemKey}"
                                       data-flow="${flowKey}"
                                       data-doc="${docKey}"
                                       ${isChecked ? 'checked' : ''}>
                                <span class="custom-checkbox neumorphic-outset-sm">
                                    <i data-lucide="check" class="check-icon w-4 h-4"></i>
                                </span>
                                <span class="font-medium flex-1">${itemKey}</span>
                            </label>
                        </li>`;
                });
                checklistHtml += '</ul>';

                let paginationHtml = '<div id="checklist-items-pagination" class="flex items-center justify-center gap-4 mt-4 py-2"></div>';
                
                let finishButtonHtml = '';
                if (totalPages === 0 || pageIndex >= totalPages - 1) {
                    finishButtonHtml = `
                        <div class="mt-auto pt-6">
                            <button class="checklist-finish-btn w-full p-4 rounded-2xl neumorphic-inset font-semibold text-accent transition-all duration-200 active:scale-95" data-flow="${flowKey}" data-doc="${docKey}" data-page="${pageIndex}">
                                Finalizar
                            </button>
                        </div>
                    `;
                }
                
                itemsContainer.innerHTML = checklistHtml + paginationHtml + finishButtonHtml;

                const checklistPaginationContainer = itemsContainer.querySelector('#checklist-items-pagination');
                if (totalPages > 1 && checklistPaginationContainer) {
                    let paginationControls = `
                        <button ${pageIndex === 0 ? 'disabled' : ''} class="checklist-page-prev p-3 rounded-full neumorphic-outset-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-90" data-flow="${flowKey}" data-doc="${docKey}" data-page="${pageIndex}">
                            <i data-lucide="arrow-left" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                        <div class="flex gap-2 items-center">
                            ${Array.from({ length: totalPages }, (_, i) => `<div class="pagination-dot ${i === pageIndex ? 'active' : ''}"></div>`).join('')}
                        </div>
                        <button ${pageIndex >= totalPages - 1 ? 'disabled' : ''} class="checklist-page-next p-3 rounded-full neumorphic-outset-sm disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-200 active:scale-90" data-flow="${flowKey}" data-doc="${docKey}" data-page="${pageIndex}">
                            <i data-lucide="arrow-right" class="w-5 h-5 pointer-events-none"></i>
                        </button>
                    `;
                    checklistPaginationContainer.innerHTML = paginationControls;
                }

                safeCreateIcons();
            }
            
            // *** NOVA FUNÇÃO PARA BUSCAR O TEXTO DO PARECER ***
            function findParecerText(parecerKeyToFind) {
                if (typeof pareceresDataCorrigido === 'undefined') return null;

                for (const mainCategory in pareceresDataCorrigido) {
                    const subCategories = pareceresDataCorrigido[mainCategory];
                    for (const subCategoryTitle in subCategories) {
                        const items = subCategories[subCategoryTitle];
                        // Se for um objeto de pareceres (como em "Pareceres Gerais")
                        if (typeof items === 'object' && items !== null) {
                            if (items[parecerKeyToFind]) {
                                return items[parecerKeyToFind];
                            }
                        } 
                        // Se a própria chave da subcategoria for o parecer (caso raro)
                        else if (subCategoryTitle === parecerKeyToFind) {
                             return items;
                        }
                    }
                }
                return null; // Retorna nulo se não encontrar
            }


            // --- ESTADO INICIAL DA APLICAÇÃO ---
            function initializeApp() {
                updateThemeIcons();
                if (dockButtons.length > 0) {
                    requestAnimationFrame(() => {
                         dockButtons[0].click();
                    });
                }
            }

            // --- LÓGICA DO MODAL DE TERMOS ---
            const TERMS_KEY = 'apoioBpoTermsAccepted_v1.1';
            
            termsCheckbox.addEventListener('change', () => {
                acceptTermsBtn.disabled = !termsCheckbox.checked;
            });

            if (localStorage.getItem(TERMS_KEY) === 'true') {
                initializeApp();
            } else {
                termsModal.classList.remove('hidden');
                mainContent.classList.add('blurred');
                
                acceptTermsBtn.addEventListener('click', () => {
                    if (!termsCheckbox.checked) return;

                    localStorage.setItem(TERMS_KEY, 'true');
                    
                    termsModal.classList.add('animate-fade-out');
                    termsModal.addEventListener('animationend', () => {
                        termsModal.classList.add('hidden');
                        mainContent.classList.remove('blurred');
                    }, { once: true });

                    initializeApp();
                }, { once: true });
            }
        };
    </script>
</body>
</html>
