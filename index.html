<!DOCTYPE html>
<html lang="pt-BR" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApoioBPO - Sistema de Apoio BPO</title>
    <link rel="icon" type="image/png" href="./images/logo/logo_apoiobpo_solo_semfundo.png">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Carregando os arquivos de dados externos -->
    <script src="data/pareceres.js" defer></script>
    <script src="data/regras.js" defer></script>
    <script src="data/checklists.js" defer></script>

    <link rel="stylesheet" href="style.css">
    
    <style>
        .star-btn .star-icon { transition: all 0.2s ease-in-out; }
        .star-btn.active .star-icon {
            fill: #facc15; /* Amarelo para a estrela preenchida */
            color: #facc15;
        }

        .history-filter-btn.active {
             box-shadow: inset 3px 3px 6px var(--shadow-color-dark), inset -3px -3px 6px var(--shadow-color-light);
             color: var(--accent-color);
        }

        /* Estilos para o toggle switch do timer, adaptados do index.html */
        .toggle-switch {
            position: relative;
            width: 3.5rem;
            height: 1.75rem;
        }
        .toggle-label {
            display: block;
            width: 100%;
            height: 100%;
            border-radius: 9999px;
            box-shadow: inset 2px 2px 5px var(--shadow-color-dark), inset -2px -2px 5px var(--shadow-color-light);
            transition: background-color 0.3s ease;
            cursor: pointer;
        }
        .toggle-checkbox {
            appearance: none;
            position: absolute;
            top: 0.25rem;
            left: 0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            border-radius: 9999px;
            background-color: var(--card-bg-color);
            box-shadow: 2px 2px 4px var(--shadow-color-dark), -2px -2px 4px var(--shadow-color-light);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
        }
        .toggle-checkbox:checked {
            transform: translateX(1.75rem);
            background-color: var(--accent-color);
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: rgba(56, 189, 248, 0.1);
        }
        
        /* Estilos Padrão (Substituindo Neumórfico) e Animação */
        .neumorphic-outset { 
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .neumorphic-outset-sm { 
            background-color: var(--card-bg-color);
            border: 1px solid var(--border-color);
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transition: background-color 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
        }
        .neumorphic-outset-sm:hover {
             border-color: var(--accent-color);
        }
        @keyframes fade-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        .animate-fade-out { animation: fade-out 0.3s ease-in forwards; }
        #accept-terms-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Estilo Liquid Glass para o Dock */
        .bottom-dock-container {
            background-color: rgba(255, 255, 255, 0.3); /* Fundo claro semi-transparente */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px); /* Suporte para Safari */
            border: 1px solid rgba(255, 255, 255, 0.4);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
        }

        html.dark .bottom-dock-container {
            background-color: rgba(31, 41, 55, 0.3); /* Fundo escuro semi-transparente (#1f2937 com alpha) */
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        
        /* Ajuste para o item ativo para combinar com o novo estilo */
        .dock-item.active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        html.dark .dock-item.active {
            background-color: rgba(255, 255, 255, 0.1);
        }

        /* Estilos para o visualizador de imagem e zoom */
        .cursor-zoom-in { cursor: zoom-in; }
        #image-viewer-content {
            transition: transform 0.2s ease-out;
            will-change: transform;
            cursor: inherit; /* Herda o cursor do wrapper (grab/grabbing) */
        }

        /* NOVOS ESTILOS PARA O POSICIONAMENTO DO DOCK */
        #main-dock, #dock-inner-container {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #main-content {
            transition: padding-left 0.4s cubic-bezier(0.4, 0, 0.2, 1), margin-bottom 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        /* DOCK INFERIOR (PADRÃO) */
        #main-dock.dock-bottom {
            bottom: 0; left: 0; right: 0; padding: 1rem; display: flex; justify-content: center;
        }
        #dock-inner-container.dock-bottom {
            flex-direction: row; gap: 0.5rem; padding: 0.75rem; border-radius: 1.5rem;
        }
        #main-content.dock-bottom {
            padding-bottom: 8rem; /* Espaço para o dock inferior */
        }
        .dock-item .label { display: inline; }

        /* DOCK LATERAL */
        #main-dock.dock-side {
            /* A propriedade 'left' será definida via JavaScript para posicionamento dinâmico */
            top: 64px; /* Altura do header */ 
            bottom: 0; 
            width: auto;
            display: flex; 
            align-items: center;   /* Centraliza o container interno na vertical */
        }
        #dock-inner-container.dock-side {
            flex-direction: column; 
            width: fit-content; 
            height: fit-content;
            gap: 0.75rem; 
            padding: 1rem; /* Ajuste no padding para estética */
            border-radius: 1.5rem; /* Garante o formato retangular arredondado */
        }
        #main-content.dock-side {
            padding-left: 0; 
            padding-bottom: 2rem;
        }
        #dock-inner-container.dock-side .label { display: none; }
    </style>

</head>

<body>
    <!-- MODAL DE TERMOS DE USO -->
    <div id="terms-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-[var(--bg-color)] opacity-90"></div>
        <div class="relative w-full max-w-2xl p-6 sm:p-8 rounded-2xl neumorphic-outset animate-fade-in">
            <h2 class="text-2xl font-bold mb-2 text-[var(--accent-color)]">Termos e Condições de Uso — ApoioBPO</h2>
            <p class="text-xs text-[var(--text-secondary)] mb-4">Versão 1.7.0 — Setembro de 2025</p>

            <div class="max-h-[60vh] overflow-y-auto custom-scrollbar pr-4 text-sm space-y-4 text-[var(--text-secondary)]">
                <p>Bem-vindo ao ApoioBPO. Antes de utilizar o sistema, leia atentamente estes termos. Ao clicar em “Aceitar e Continuar”, você declara estar de acordo com as condições estabelecidas.</p>

                <div>
                    <h3 class="font-semibold text-base mt-4 mb-2 text-[var(--text-primary)]">1. Propriedade Intelectual</h3>
                    <p>Este sistema foi desenvolvido por <strong>Wellington Juan Dutra Oliveira</strong>, com colaboração de:</p>
                    <ul class="list-disc list-inside pl-4">
                        <li>Gabriel Artur Lopes Feltes</li>
                        <li>Mauricio Gabriel Freiberger Konig</li>
                        <li>Erika Mendonça Figueira</li>
                        <li>Bruno Corrêa Alves</li>
                    </ul>
                    <p class="mt-2">Todos os direitos sobre o sistema, incluindo código-fonte, design, funcionalidades e lógica, são reservados ao autor.</p>
                </div>

                <div>
                    <h3 class="font-semibold text-base mt-4 mb-2 text-[var(--text-primary)]">2. Finalidade de Uso</h3>
                    <p>O ApoioBPO destina-se exclusivamente ao uso interno e profissional da equipe da Meta Serviços em Informática S.A., no âmbito dos serviços de BPO prestados ao Banco Cooperativo Sicoob S.A.</p>
                    <p class="mt-2">Principais funcionalidades:</p>
                    <ul class="list-disc list-inside pl-4">
                        <li>Cálculo de renda para pessoas físicas (PF) e jurídicas (PJ);</li>
                        <li>Análise de atividades agropecuárias;</li>
                        <li>Verificação automatizada de CNPJ;</li>
                        <li>Checklist documental;</li>
                        <li>Registro e contagem de atividades por hora;</li>
                        <li>Consulta de pareceres técnicos e regras de operação.</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-base mt-4 mb-2 text-[var(--text-primary)]">3. Restrições de Uso</h3>
                    <p>É estritamente proibido:</p>
                    <ul class="list-disc list-inside pl-4">
                        <li>Utilizar o sistema fora do ambiente corporativo e horário comercial;</li>
                        <li>Compartilhar acesso com pessoas não autorizadas;</li>
                        <li>Copiar, modificar, distribuir, vender ou sublicenciar o sistema sem autorização expressa;</li>
                        <li>Realizar engenharia reversa, descompilar ou tentar acessar o código-fonte;</li>
                        <li>Utilizar documentos, regras ou pareceres sem permissão formal;</li>
                        <li>Armazenar ou transmitir dados do sistema fora da rede corporativa sem autorização prévia.</li>
                    </ul>
                </div>

                <div>
                    <h3 class="font-semibold text-base mt-4 mb-2 text-[var(--text-primary)]">5. Responsabilidade Limitada</h3>
                    <p>O sistema é fornecido “como está” e pode apresentar limitações técnicas decorrentes de atualizações, integrações externas ou uso indevido. Os desenvolvedores se responsabilizam apenas pelo funcionamento correto das funcionalidades especificadas.</p>
                    <p class="mt-2">Decisões operacionais, financeiras ou jurídicas baseadas no sistema devem ser validadas pelo usuário. Falhas devem ser comunicadas imediatamente pelos canais oficiais.</p>
                </div>

                <div>
                    <h3 class="font-semibold text-base mt-4 mb-2 text-[var(--text-primary)]">6. Suporte e Comunicação de Incidentes</h3>
                    <p>Dúvidas, falhas ou incidentes devem ser reportados imediatamente pelo canal oficial da Meta Serviços em Informática S.A. (Microsoft Teams, e-mail corporativo ou ferramenta designada). O não reporte pode limitar a responsabilidade dos autores.</p>
                </div>

                <div>
                    <h3 class="font-semibold text-base mt-4 mb-2 text-[var(--text-primary)]">7. Vigência e Atualizações</h3>
                    <p>Estes termos entram em vigor na data da versão indicada e podem ser atualizados a qualquer momento por motivos técnicos, legais ou operacionais. O usuário deve manter-se informado sobre a versão vigente.</p>
                </div>
            </div>

            <div class="mt-6 space-y-4">
                <label for="terms-checkbox" class="flex items-center justify-center gap-2 text-sm cursor-pointer text-[var(--text-primary)]">
                    <input type="checkbox" id="terms-checkbox" class="h-4 w-4 rounded border-gray-300 text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
                    <span>Declaro que li, compreendi e aceito todos os termos e condições de uso descritos acima</span>
                </label>
                <button id="accept-terms-btn" class="w-full px-8 py-3 rounded-2xl neumorphic-outset-sm font-semibold tracking-wider uppercase transition-all duration-200 active:scale-95 text-[var(--accent-color)]" disabled>
                    Aceitar e Continuar
                </button>
            </div>
        </div>
    </div>

    <!-- BARRA SUPERIOR FIXA -->
    <header class="w-full bg-[var(--card-bg-color)] border-b border-[var(--border-color)] transition-colors duration-300 sticky top-0 z-30 h-[64px]">
        <div class="flex justify-between items-center w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3">
            <div class="flex items-center gap-3">
                <img src="./images/logo/logo_apoiobpo_solo_semfundo.png" alt="ApoioBPO Logo" class="w-8 h-8 sm:w-10 sm:h-10 ">
                <span class="font-bold text-xl hidden sm:block">ApoioBPO</span>
            </div>
            <div class="flex items-center gap-3">
                <!-- BOTÃO PARA ALTERNAR POSIÇÃO DO DOCK -->
                <button id="dock-toggle-btn" title="Mudar Posição do Dock" class="p-3 rounded-full secondary-btn hidden sm:flex">
                    <i data-lucide="layout-sidebar-left" class="w-5 h-5"></i>
                </button>
                <button id="info-button" class="p-3 rounded-full secondary-btn">
                    <i data-lucide="info" class="w-5 h-5"></i>
                </button>
                <button id="theme-toggle" class="p-3 rounded-full secondary-btn">
                    <i data-lucide="sun" id="sun-icon" class="w-5 h-5"></i>
                    <i data-lucide="moon" id="moon-icon" class="hidden w-5 h-5"></i>
                </button>
                <label for="profile-pic-input" 
                    class="w-11 h-11 rounded-full flex items-center justify-center bg-[var(--bg-color)] border border-[var(--border-color)] cursor-pointer overflow-hidden">
                    <img id="profile-pic" src="" alt="Foto do Perfil" class="w-full h-full object-cover hidden">
                    <i data-lucide="user-circle-2" id="profile-pic-icon" class="w-5 h-5 text-[var(--text-secondary)]"></i>
                </label>
                <input type="file" id="profile-pic-input" class="hidden" accept="image/*">
            </div>
        </div>
    </header>

    <!-- Conteúdo Principal -->
    <div id="main-content" class="min-h-screen w-full flex flex-col items-center p-4 sm:p-8 transition-all duration-300">
        <main class="w-full max-w-7xl mx-auto flex flex-col gap-4">
            <div id="module-container" class="w-full p-6 md:p-8 main-module-card min-h-[60vh]">
                <h1 id="module-title" class="text-3xl font-bold mb-8 text-center"></h1>
                
                <div id="faturamento-module" class="module-content hidden"></div>
                <div id="renda-pf-module" class="module-content hidden"></div>
                <div id="renda-agro-module" class="module-content hidden"></div>
                <div id="regras-module" class="module-content hidden"></div>
                <div id="cnpj-module" class="module-content hidden"></div>
                <div id="parecer-module" class="module-content hidden"></div>
                <div id="contador-module" class="module-content hidden"></div>
                <div id="checklist-module" class="module-content hidden"></div>
            </div>
        </main>

        <!-- DOCK DE NAVEGAÇÃO -->
        <nav id="main-dock" class="fixed z-40">
            <div id="dock-inner-container" class="bottom-dock-container">
                <button class="dock-item" data-target="faturamento-module" data-title="Cálculo Renda PJ">
                    <div class="icon-bg" style="background: linear-gradient(135deg, #6dd5ed, #2193b0);">
                        <i data-lucide="building-2" class="icon"></i>
                    </div>
                    <span class="label">Renda PJ</span>
                </button>
                <button class="dock-item" data-target="renda-pf-module" data-title="Cálculo Renda PF">
                    <div class="icon-bg" style="background: linear-gradient(135deg, #ff9966, #ff5e62);">
                        <i data-lucide="user" class="icon"></i>
                    </div>
                    <span class="label">Renda PF</span>
                </button>
                 <button class="dock-item" data-target="renda-agro-module" data-title="Cálculo Renda Agro">
                    <div class="icon-bg" style="background: linear-gradient(135deg, #76b852, #8dc26f);">
                        <i data-lucide="tractor" class="icon"></i>
                    </div>
                    <span class="label">Renda Agro</span>
                </button>
                <button class="dock-item" data-target="cnpj-module" data-title="Consulta CNPJ">
                    <div class="icon-bg" style="background: linear-gradient(135deg, #89f7fe, #66a6ff);">
                        <i data-lucide="search" class="icon"></i>
                    </div>
                    <span class="label">CNPJ</span>
                </button>
                 <button class="dock-item" data-target="contador-module" data-title="Contador">
                    <div class="icon-bg" style="background: linear-gradient(135deg, #43e97b, #38f9d7);">
                        <i data-lucide="plus-circle" class="icon"></i>
                    </div>
                    <span class="label">Contador</span>
                </button>
                <button class="dock-item" data-target="regras-module" data-title="Regras IRPF">
                    <div class="icon-bg" style="background: linear-gradient(135deg, #f6d365, #fda085);">
                        <i data-lucide="book-marked" class="icon"></i>
                    </div>
                    <span class="label">Regras</span>
                </button>
                <button class="dock-item" data-target="parecer-module" data-title="Pareceres">
                    <div class="icon-bg" style="background: linear-gradient(135deg, #a9c9ff, #ffbbec);">
                        <i data-lucide="message-square-quote" class="icon"></i>
                    </div>
                    <span class="label">Pareceres</span>
                </button>
                <button class="dock-item" data-target="checklist-module" data-title="Checklist">
                    <div class="icon-bg" style="background: linear-gradient(135deg, #d4fc79, #96e6a1);">
                        <i data-lucide="check-square" class="icon"></i>
                    </div>
                    <span class="label">Checklist</span>
                </button>
            </div>
        </nav>
    </div>

    <!-- MODAIS E TEMPLATES -->
    <div id="image-viewer-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 hidden bg-black/80 backdrop-blur-sm overflow-hidden">
        <button id="image-viewer-close" class="absolute top-4 right-4 text-white p-2 rounded-full transition-colors z-20 hover:bg-white/20">
            <i data-lucide="x" class="w-8 h-8"></i>
        </button>
        <div class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 flex items-center gap-2 bg-black/20 p-2 rounded-full">
            <button id="zoom-out-btn" class="text-white p-2 rounded-full transition-colors hover:bg-white/20">
                <i data-lucide="zoom-out" class="w-6 h-6"></i>
            </button>
            <button id="zoom-in-btn" class="text-white p-2 rounded-full transition-colors hover:bg-white/20">
                <i data-lucide="zoom-in" class="w-6 h-6"></i>
            </button>
        </div>
        <div id="image-viewer-wrapper" class="relative w-full h-full flex items-center justify-center">
            <img id="image-viewer-content" src="" alt="Imagem Ampliada" class="max-w-full max-h-full object-contain rounded-lg shadow-2xl">
        </div>
    </div>

    <div id="info-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" id="info-modal-overlay"></div>
        <div class="relative w-full max-w-lg p-6 rounded-2xl bg-[var(--card-bg-color)] shadow-xl animate-fade-in">
            <button id="info-modal-close" class="absolute top-4 right-4 p-2 rounded-full secondary-btn">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-[var(--accent-color)]">Créditos e Uso</h2>
            <div class="text-sm space-y-3">
                <p><strong>Desenvolvido por:</strong> Wellington Juan Dutra Oliveira</p>
                <p><strong>Com colaboração de:</strong></p>
                <ul class="list-disc list-inside pl-4 text-[var(--text-secondary)]">
                    <li>Gabriel Artur Lopes Feltes (Coordenador de BPO)</li>
                    <li>Mauricio Gabriel Freiberger Konig (Líder de BPO)</li>
                    <li>Erika Mendonça Figueira (Assistente de BPO)</li>
                    <li>Bruno Corrêa Alves (Assistente de BPO)</li>
                </ul>
                <p><strong>Lembrete de Uso:</strong></p>
                <p class="text-[var(--text-secondary)]">Esta ferramenta é de uso exclusivo para colaboradores da Meta Serviços em Informática S.A. a serviço do Sicoob. É proibida a cópia, distribuição ou uso fora do âmbito profissional designado.</p>
                <p class="text-xs text-center text-[var(--text-secondary)] pt-4 mt-4 border-t border-[var(--border-color)]">© 2025 Wellington Juan Dutra Oliveira e colaboradores. Todos os direitos reservados.</p>
            </div>
        </div>
    </div>

    <template id="counter-template">
        <div class="counter-card p-3 rounded-2xl content-card flex flex-col items-center justify-center gap-2 relative h-full">
            <button class="star-btn absolute top-2 left-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                <i data-lucide="star" class="star-icon w-4 h-4"></i>
            </button>
            <button class="remove-counter-btn absolute top-2 right-2 p-1 rounded-full hover:bg-black/10 dark:hover:bg-white/10">
                <i data-lucide="x" class="w-4 h-4"></i>
            </button>
            <h4 class="counter-title font-semibold text-center w-full px-8 truncate" contenteditable="true">Contador</h4>
            <span class="counter-display font-bold text-6xl text-[var(--accent-color)] cursor-pointer" contenteditable="false">0</span>
            <div class="flex items-center gap-3">
                <button class="counter-minus w-16 h-16 rounded-2xl secondary-btn text-4xl font-bold active:scale-95 transition-transform flex items-center justify-center">-</button>
                <button class="counter-plus w-16 h-16 rounded-2xl secondary-btn text-4xl font-bold active:scale-95 transition-transform flex items-center justify-center">+</button>
                
                <button class="timer-play-pause w-16 h-16 rounded-2xl secondary-btn text-4xl font-bold active:scale-95 transition-transform flex items-center justify-center hidden"><i data-lucide="play" class="w-6 h-6"></i></button>
                <button class="timer-reset w-16 h-16 rounded-2xl secondary-btn text-4xl font-bold active:scale-95 transition-transform flex items-center justify-center hidden"><i data-lucide="rotate-cw" class="w-6 h-6"></i></button>
            </div>
        </div>
    </template>

    <script>
        window.onload = () => {
            // --- VARIÁVEIS GLOBAIS ---
            let currentModuleId = null;
            let checklistState = JSON.parse(localStorage.getItem('apoioBpoChecklistState')) || {};
            let counterChart = null;
            let historyChart = null;
            let counters = [];

            // --- CONSTANTES DE CHAVES DO LOCALSTORAGE ---
            const DAILY_HISTORY_KEY = 'apoioBpoDailyHistory';
            const INCREMENT_HISTORY_KEY = 'apoioBpoIncrementHistory';
            const COUNTERS_STATE_KEY = 'apoioBpoCountersState_v3';
            const TERMS_KEY = 'apoioBpoTermsAccepted_v1.1';
            const PROFILE_PIC_KEY = 'apoioBpoProfilePic';
            const DOCK_POSITION_KEY = 'apoioBpoDockPosition'; // Chave para posição do dock

            // --- SELEÇÃO INICIAL DE ELEMENTOS DO DOM ---
            const mainContent = document.getElementById('main-content');
            const moduleTitle = document.getElementById('module-title');
            const modules = document.querySelectorAll('.module-content');
            const dockButtons = document.querySelectorAll('.dock-item');
            
            // --- FUNÇÕES AUXILIARES GLOBAIS ---
            const formatCurrency = (value) => (isNaN(value) || !isFinite(value)) ? "R$ 0,00" : value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
            const parseLocalFloat = (value) => parseFloat(String(value).replace(/\./g, '').replace(',', '.')) || 0;
            const removeAccents = (str) => (typeof str !== 'string') ? '' : str.normalize("NFD").replace(/[\u0300-\u036f]/g, "");
            const safeCreateIcons = () => { if (typeof lucide !== 'undefined') lucide.createIcons(); };
            const formatDate = (dateString) => dateString ? new Date(dateString).toLocaleDateString('pt-BR', { timeZone: 'UTC' }) : 'N/A';

            // --- FORÇA O ÍCONE DO BOTÃO DOCK A APARECER NA PRIMEIRA CARGA ---
            const dockToggleBtnInit = document.getElementById("dock-toggle-btn");
            if (dockToggleBtnInit) {
                const dockToggleIcon = dockToggleBtnInit.querySelector("i");
                const savedDockPosition = localStorage.getItem("apoioBpoDockPosition") || "bottom";
                if (dockToggleIcon) {
                    if (savedDockPosition === "side") {
                    dockToggleIcon.setAttribute("data-lucide", "layout-panel-left");
                    } else {
                    dockToggleIcon.setAttribute("data-lucide", "layout-sidebar-left");
                    }
                if (typeof lucide !== "undefined") {
                lucide.createIcons();
                }   
            }
}

            // --- GERENCIAMENTO DA POSIÇÃO DO DOCK ---
            function setupDockToggling() {
                const dockToggleBtn = document.getElementById('dock-toggle-btn');
                const mainDock = document.getElementById('main-dock');
                const dockInnerContainer = document.getElementById('dock-inner-container');
                const mainContentEl = document.getElementById('main-content');
                const dockToggleIcon = dockToggleBtn ? dockToggleBtn.querySelector('i') : null;

                if (!dockToggleBtn || !mainDock || !dockInnerContainer || !mainContentEl || !dockToggleIcon) {
                    console.error("Um ou mais elementos do dock não foram encontrados. A funcionalidade de troca de posição não funcionará.");
                    if(dockToggleBtn) dockToggleBtn.style.display = 'none'; // Esconde o botão se algo der errado
                    return;
                }

                function positionSideDock() {
                    if (!mainDock.classList.contains('dock-side')) return;

                    const mainContainer = mainContentEl.querySelector('main');
                    if (!mainContainer) return;

                    const mainRect = mainContainer.getBoundingClientRect();
                    const dockWidth = mainDock.offsetWidth;
                    const gap = 16; // 1rem em pixels

                    // Calcula a posição à esquerda do container principal
                    let newLeft = mainRect.left - dockWidth - gap;

                    // Garante que o dock não saia da tela em viewports menores
                    if (newLeft < gap) {
                        newLeft = gap;
                    }

                    mainDock.style.left = `${newLeft}px`;
                    mainDock.style.right = 'auto'; // Remove a propriedade 'right' se existir
                }

                function setDockPosition(position) { // 'side' or 'bottom'
                    // Reset inline styles to allow for correct measurements and default positioning
                    mainDock.style.left = '';
                    mainDock.style.right = '';

                    if (position === 'side') {
                        mainDock.classList.remove('dock-bottom');
                        dockInnerContainer.classList.remove('dock-bottom');
                        mainContentEl.classList.remove('dock-bottom');
                        mainDock.classList.add('dock-side');
                        dockInnerContainer.classList.add('dock-side');
                        mainContentEl.classList.add('dock-side');
                        dockToggleIcon.setAttribute('data-lucide', 'layout-panel-left');
                        // Use requestAnimationFrame to ensure the new classes are applied before calculating position
                        requestAnimationFrame(positionSideDock);
                    } else { // Default to bottom
                        mainDock.classList.remove('dock-side');
                        dockInnerContainer.classList.remove('dock-side');
                        mainContentEl.classList.remove('dock-side');
                        mainDock.classList.add('dock-bottom');
                        dockInnerContainer.classList.add('dock-bottom');
                        mainContentEl.classList.add('dock-bottom');
                        dockToggleIcon.setAttribute('data-lucide', 'layout-sidebar-left');
                    }
                    safeCreateIcons();
                    localStorage.setItem(DOCK_POSITION_KEY, position);
                }

                // Add resize listener to reposition the dock
                window.addEventListener('resize', positionSideDock);

                dockToggleBtn.addEventListener('click', () => {
                    const currentPosition = localStorage.getItem(DOCK_POSITION_KEY) || 'bottom';
                    const newPosition = currentPosition === 'bottom' ? 'side' : 'bottom';
                    setDockPosition(newPosition);
                });

                // Configuração inicial no carregamento
                const savedDockPosition = localStorage.getItem(DOCK_POSITION_KEY) || 'bottom';
                setDockPosition(savedDockPosition);
            }

            function copyText(text, buttonElement) {
                navigator.clipboard.writeText(text).then(() => {
                    if (buttonElement) {
                        const originalHTML = buttonElement.innerHTML;
                        buttonElement.disabled = true; // Previne múltiplos cliques
                        buttonElement.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Copiado`;
                        safeCreateIcons();
                        
                        setTimeout(() => {
                            buttonElement.innerHTML = originalHTML;
                            buttonElement.disabled = false;
                            safeCreateIcons(); // Renderiza novamente caso o original tivesse um ícone
                        }, 2000);
                    }
                }).catch(err => {
                    console.error('Falha ao copiar texto: ', err);
                });
            }

            function findParecerText(parecerKeyToFind) {
                if (typeof pareceresDataCorrigido === 'undefined') return null;
                for (const mainCategory in pareceresDataCorrigido) {
                    const subCategories = pareceresDataCorrigido[mainCategory];
                    for (const subCategoryTitle in subCategories) {
                        const items = subCategories[subCategoryTitle];
                        if (typeof items === 'object' && items !== null) {
                            if (items[parecerKeyToFind]) {
                                return items[parecerKeyToFind];
                            }
                        } else if (subCategoryTitle === parecerKeyToFind) {
                            return items;
                        }
                    }
                }
                return null;
            }
            
            // --- INICIALIZAÇÃO DA APLICAÇÃO ---
            function initializeApp() {
                setupEventListeners();
                setupProfilePic();
                setupImageViewerModal(); // Configura o modal de imagem
                updateTheme(localStorage.getItem('apoioBpoTheme') === 'dark');
                if (dockButtons.length > 0) {
                    requestAnimationFrame(() => dockButtons[0].click());
                }
            }
            
            // --- GERENCIAMENTO DO VISUALIZADOR DE IMAGEM (MODAL) ---
            function setupImageViewerModal() {
                const modal = document.getElementById('image-viewer-modal');
                if (!modal) return;

                const content = document.getElementById('image-viewer-content');
                const wrapper = document.getElementById('image-viewer-wrapper');
                const closeBtn = document.getElementById('image-viewer-close');
                const zoomInBtn = document.getElementById('zoom-in-btn');
                const zoomOutBtn = document.getElementById('zoom-out-btn');

                let scale = 1, isDragging = false, startX, startY, translateX = 0, translateY = 0;

                const updateTransform = () => {
                    content.style.transform = `translate(${translateX}px, ${translateY}px) scale(${scale})`;
                     wrapper.style.cursor = scale > 1 ? 'grab' : 'default';
                };
                
                const resetTransform = () => {
                    scale = 1;
                    translateX = 0;
                    translateY = 0;
                    content.style.transition = 'transform 0.2s ease-out';
                    updateTransform();
                };

                const openModal = (src) => {
                    content.src = src;
                    modal.classList.remove('hidden');
                    document.body.style.overflow = 'hidden';
                    resetTransform();
                };

                const closeModal = () => {
                    modal.classList.add('hidden');
                    document.body.style.overflow = '';
                };
                
                // Delegação de evento para abrir o modal
                const checklistModule = document.getElementById('checklist-module');
                if (checklistModule) {
                    checklistModule.addEventListener('click', e => {
                        const image = e.target;
                        if (image.tagName === 'IMG' && image.closest('#checklist-main-layout')) {
                             openModal(image.src);
                        }
                    });
                }

                closeBtn.addEventListener('click', closeModal);
                modal.addEventListener('click', e => { if (e.target === modal) closeModal(); });
                
                zoomInBtn.addEventListener('click', () => { scale = Math.min(scale + 0.2, 5); updateTransform(); });
                zoomOutBtn.addEventListener('click', () => { scale = Math.max(scale - 0.2, 1); updateTransform(); });

                wrapper.addEventListener('mousedown', e => {
                    if (scale <= 1) return;
                    e.preventDefault();
                    isDragging = true;
                    startX = e.clientX - translateX;
                    startY = e.clientY - translateY;
                    content.style.transition = 'none'; // Permite arrastar suavemente
                    wrapper.style.cursor = 'grabbing';
                });
                
                window.addEventListener('mousemove', e => {
                    if (!isDragging) return;
                    e.preventDefault();
                    translateX = e.clientX - startX;
                    translateY = e.clientY - startY;
                    updateTransform();
                });
                
                window.addEventListener('mouseup', () => {
                    if (isDragging) {
                        isDragging = false;
                        wrapper.style.cursor = 'grab';
                    }
                });
                
                wrapper.addEventListener('wheel', e => {
                    e.preventDefault();
                    const zoomIntensity = 0.1;
                    const delta = e.deltaY > 0 ? -1 : 1;
                    const newScale = Math.max(1, Math.min(scale + delta * zoomIntensity, 5));
                    
                    const rect = wrapper.getBoundingClientRect();
                    const mouseX = e.clientX - rect.left;
                    const mouseY = e.clientY - rect.top;
                    
                    const newTranslateX = translateX - (mouseX - (rect.width/2) - translateX) * (newScale/scale - 1);
                    const newTranslateY = translateY - (mouseY - (rect.height/2) - translateY) * (newScale/scale - 1);

                    scale = newScale;
                    translateX = newTranslateX;
                    translateY = newTranslateY;
                    
                    updateTransform();
                });
            }


            // --- GERENCIAMENTO DE FOTO DE PERFIL ---
            function setupProfilePic() {
                const picInput = document.getElementById('profile-pic-input');
                const picImg = document.getElementById('profile-pic');
                const picIcon = document.getElementById('profile-pic-icon');

                const savedPic = localStorage.getItem(PROFILE_PIC_KEY);
                if (savedPic) {
                    picImg.src = savedPic;
                    picImg.classList.remove('hidden');
                    picIcon.classList.add('hidden');
                }

                picInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            const imgData = event.target.result;
                            picImg.src = imgData;
                            localStorage.setItem(PROFILE_PIC_KEY, imgData);
                            picImg.classList.remove('hidden');
                            picIcon.classList.add('hidden');
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            // --- GERENCIAMENTO DO TEMA (CLARO/ESCURO) ---
            function updateTheme(isDark) {
                document.documentElement.classList.toggle('dark', isDark);
                localStorage.setItem('apoioBpoTheme', isDark ? 'dark' : 'light');
                const sunIcon = document.getElementById('sun-icon');
                const moonIcon = document.getElementById('moon-icon');
                if (sunIcon && moonIcon) {
                    sunIcon.classList.toggle('hidden', isDark);
                    moonIcon.classList.toggle('hidden', !isDark);
                }
                if (currentModuleId === 'contador-module') {
                    if (counterChart) updateCounterChart();
                    if (historyChart) {
                        const activeFilter = document.querySelector('.history-filter-btn.active');
                        if (activeFilter) renderHistoryChart(activeFilter.dataset.period);
                    }
                }
            }

            // --- NAVEGAÇÃO PRINCIPAL E CARREGAMENTO DE MÓDULOS ---
            function switchModule(targetModuleId, targetTitle) {
                if (targetModuleId === currentModuleId) return;
                currentModuleId = targetModuleId;
                moduleTitle.textContent = targetTitle;
                modules.forEach(module => {
                    module.innerHTML = ''; 
                    module.classList.add('hidden');
                });
                const activeModule = document.getElementById(targetModuleId);
                if (activeModule) {
                    activeModule.classList.remove('hidden');
                    activeModule.classList.add('animate-fade-in');
                    loadModuleContent(targetModuleId);
                }
            }
            
            // --- CARREGADOR DE CONTEÚDO DINÂMICO DOS MÓDULOS ---
            function loadModuleContent(moduleId) {
                const container = document.getElementById(moduleId);
                if (!container) return;
                const modules = {
                    'faturamento-module': initFaturamentoModule,
                    'renda-pf-module': initRendaPfModule,
                    'renda-agro-module': initRendaAgroModule,
                    'regras-module': initRegrasModule,
                    'cnpj-module': initCnpjModule,
                    'parecer-module': initParecerModule,
                    'contador-module': initContadorModule,
                    'checklist-module': initChecklistModule,
                };
                if (modules[moduleId]) {
                    modules[moduleId](container);
                }
                safeCreateIcons();
            }

            // --- LÓGICA DE CADA MÓDULO ---

            function initFaturamentoModule(container) {
                container.innerHTML = `
                    <div class="flex mb-6 border-b border-[var(--border-color)] flex-shrink-0 overflow-x-auto">
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap active" data-tab="calculo-simples">Cálculo do Simples</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="rel-faturamento">Rel. Faturamento</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="porcentagem">Porcentagem</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="calc-datas">Cal. Datas</button>
                    </div>
                    <div>
                        <div id="calculo-simples-tab" class="faturamento-tab-content">
                            <form id="faturamento-form" class="space-y-6">
                                <!-- 1º MÉTODO DE CÁLCULO -->
                                <div class="p-4 content-card space-y-4">
                                    <h3 class="text-lg font-bold text-center text-[var(--accent-color)]">1º MÉTODO DE CÁLCULO (SOMENTE RBT12)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                                        <div class="space-y-4">
                                            <div class="flex flex-col gap-2">
                                                <label for="rbt12_metodo1" class="text-sm font-medium text-[var(--text-secondary)]">Receita Bruta Acumulada (RBT12)</label>
                                                <input type="text" inputmode="decimal" id="rbt12_metodo1" placeholder="R$ 0,00" class="w-full p-3 form-input h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="meses_metodo1" class="text-sm font-medium text-[var(--text-secondary)]">Quantidade de Meses RBT12</label>
                                                <input type="number" id="meses_metodo1" placeholder="12" value="12" class="w-full p-3 form-input h-14">
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium text-[var(--text-secondary)]">Renda 1º Cálculo</label>
                                            <div class="p-3 result-display h-28 flex items-center justify-center">
                                                <p id="resultado1" class="text-2xl font-bold value">R$ 0,00</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 2º MÉTODO DE CÁLCULO -->
                                <div class="p-4 content-card space-y-4">
                                    <h3 class="text-lg font-bold text-center text-[var(--accent-color)]">2º MÉTODO DE CÁLCULO (> 12 MESES)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                                        <div class="space-y-4">
                                            <div class="flex flex-col gap-2">
                                                <label for="rpa_metodo2" class="text-sm font-medium text-[var(--text-secondary)]">Receita Bruta do PA (RPA)</label>
                                                <input type="text" inputmode="decimal" id="rpa_metodo2" placeholder="R$ 0,00" class="w-full p-3 form-input h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="rbt12_metodo2" class="text-sm font-medium text-[var(--text-secondary)]">Receita Bruta Acumulada (RBT12)</label>
                                                <input type="text" inputmode="decimal" id="rbt12_metodo2" placeholder="R$ 0,00" class="w-full p-3 form-input h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="mes_anterior_metodo2" class="text-sm font-medium text-[var(--text-secondary)]">Valor a ser Reduzido (Mês Anterior)</label>
                                                <input type="text" inputmode="decimal" id="mes_anterior_metodo2" placeholder="R$ 0,00" class="w-full p-3 form-input h-14">
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium text-[var(--text-secondary)]">Renda 2º Cálculo</label>
                                            <div class="p-3 result-display h-28 flex items-center justify-center">
                                                <p id="resultado2" class="text-2xl font-bold value">R$ 0,00</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- 3º MÉTODO DE CÁLCULO -->
                                <div class="p-4 content-card space-y-4">
                                    <h3 class="text-lg font-bold text-center text-[var(--accent-color)]">3º MÉTODO DE CÁLCULO (&lt; 12 MESES)</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-start">
                                        <div class="space-y-4">
                                            <div class="flex flex-col gap-2">
                                                <label for="rpa_metodo3" class="text-sm font-medium text-[var(--text-secondary)]">Receita Bruta do PA (RPA)</label>
                                                <input type="text" inputmode="decimal" id="rpa_metodo3" placeholder="R$ 0,00" class="w-full p-3 form-input h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="rbt12_metodo3" class="text-sm font-medium text-[var(--text-secondary)]">Receita Bruta Acumulada (RBT12)</label>
                                                <input type="text" inputmode="decimal" id="rbt12_metodo3" placeholder="R$ 0,00" class="w-full p-3 form-input h-14">
                                            </div>
                                            <div class="flex flex-col gap-2">
                                                <label for="num_meses_metodo3" class="text-sm font-medium text-[var(--text-secondary)]">Quantidade de Meses (RBT12 + RPA)</label>
                                                <input type="number" id="num_meses_metodo3" placeholder="Ex: 1" class="w-full p-3 form-input h-14">
                                            </div>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label class="text-sm font-medium text-[var(--text-secondary)]">Renda 3º Cálculo</label>
                                            <div class="p-3 result-display h-28 flex items-center justify-center">
                                                <p id="resultado3" class="text-2xl font-bold value">R$ 0,00</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-4 mt-4">
                                    <button id="calcular-faturamento" type="button" class="w-full p-3 primary-btn flex items-center justify-center gap-2"><i data-lucide="calculator" class="w-5 h-5"></i> Calcular Todos</button>
                                    <button id="limpar-faturamento" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2"><i data-lucide="trash-2" class="w-5 h-5"></i> Limpar Tudo</button>
                                </div>
                            </form>
                        </div>
                        <div id="rel-faturamento-tab" class="faturamento-tab-content hidden"></div>
                        <div id="porcentagem-tab" class="faturamento-tab-content hidden"></div>
                        <div id="calc-datas-tab" class="faturamento-tab-content hidden"></div>
                    </div>
                `;
            
                const tabButtons = container.querySelectorAll('.tab-button');
                const tabContents = container.querySelectorAll('.faturamento-tab-content');
            
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        const targetTabId = `${button.dataset.tab}-tab`;
                        tabContents.forEach(content => {
                            content.classList.toggle('hidden', content.id !== targetTabId);
                        });
            
                        if (targetTabId === 'rel-faturamento-tab' && !container.querySelector('#rel-faturamento-tab').innerHTML) {
                            initRelFaturamentoTab(container.querySelector('#rel-faturamento-tab'));
                        } else if (targetTabId === 'porcentagem-tab' && !container.querySelector('#porcentagem-tab').innerHTML) {
                            initPorcentagemTab(container.querySelector('#porcentagem-tab'));
                        } else if (targetTabId === 'calc-datas-tab' && !container.querySelector('#calc-datas-tab').innerHTML) {
                            initCalcDatasTab(container.querySelector('#calc-datas-tab'));
                        }
                        safeCreateIcons();
                    });
                });
                
                const faturamentoForm = container.querySelector('#faturamento-form');
                container.querySelector('#calcular-faturamento').addEventListener('click', () => {
                     const rbt12_m1 = parseLocalFloat(container.querySelector('#rbt12_metodo1').value);
                     const meses_m1 = parseInt(container.querySelector('#meses_metodo1').value) || 12;
                     container.querySelector('#resultado1').textContent = formatCurrency(meses_m1 > 0 ? rbt12_m1 / meses_m1 : 0);
            
                     const rpa_m2 = parseLocalFloat(container.querySelector('#rpa_metodo2').value);
                     const rbt12_m2 = parseLocalFloat(container.querySelector('#rbt12_metodo2').value);
                     const mesAnterior_m2 = parseLocalFloat(container.querySelector('#mes_anterior_metodo2').value);
                     container.querySelector('#resultado2').textContent = formatCurrency(((rbt12_m2 + rpa_m2) - mesAnterior_m2) / 12);
            
                     const rpa_m3 = parseLocalFloat(container.querySelector('#rpa_metodo3').value);
                     const rbt12_m3 = parseLocalFloat(container.querySelector('#rbt12_metodo3').value);
                     const numMeses_m3 = parseInt(container.querySelector('#num_meses_metodo3').value) || 0;
                     container.querySelector('#resultado3').textContent = formatCurrency(numMeses_m3 > 0 ? (rpa_m3 + rbt12_m3) / numMeses_m3 : 0);
                });
            
                container.querySelector('#limpar-faturamento').addEventListener('click', () => {
                    faturamentoForm.reset();
                    container.querySelector('#meses_metodo1').value = '12';
                    container.querySelector('#resultado1').textContent = formatCurrency(0);
                    container.querySelector('#resultado2').textContent = formatCurrency(0);
                    container.querySelector('#resultado3').textContent = formatCurrency(0);
                });
            }

            function initRelFaturamentoTab(container) {
                container.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div class="flex flex-col gap-2 content-card p-4">
                            <h3 class="text-lg font-semibold mb-2">Valores Mensais</h3>
                            <div id="rel-faturamento-inputs" class="space-y-2"></div>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="p-4 content-card space-y-4">
                                <div class="flex flex-col gap-2">
                                    <label for="rel-faturamento-divisor" class="text-sm font-medium text-[var(--text-secondary)]">Dividir Total por (Nº de Meses)</label>
                                    <input type="number" id="rel-faturamento-divisor" placeholder="Padrão: 12" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2 text-center">
                                    <label class="text-sm font-medium text-[var(--text-secondary)]">Soma Total dos Valores</label>
                                    <p id="rel-faturamento-renda-12-meses" class="text-2xl font-bold value">R$ 0,00</p>
                                </div>
                                <div class="flex flex-col gap-2 text-center">
                                    <label class="text-sm font-medium text-[var(--text-secondary)]">Renda Mensal Resultante</label>
                                    <p id="rel-faturamento-renda-mensal" class="text-2xl font-bold value">R$ 0,00</p>
                                </div>
                            </div>
                            <button id="rel-faturamento-limpar" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                            </button>
                        </div>
                    </div>`;

                const relFaturamentoInputsContainer = container.querySelector('#rel-faturamento-inputs');
                for (let i = 1; i <= 12; i++) {
                    relFaturamentoInputsContainer.innerHTML += `
                        <div class="flex items-center gap-2">
                            <label for="rel-mes-${i}" class="w-20 text-sm font-medium">Mês ${i}</label>
                            <input type="text" inputmode="decimal" id="rel-mes-${i}" placeholder="R$ 0,00" class="rel-faturamento-input w-full p-2 form-input">
                        </div>
                    `;
                }

                const calcularRelFaturamento = () => {
                    let total = 0;
                    container.querySelectorAll('.rel-faturamento-input').forEach(input => total += parseLocalFloat(input.value));
                    const divisor = parseInt(container.querySelector('#rel-faturamento-divisor').value) || 12;
                    container.querySelector('#rel-faturamento-renda-12-meses').textContent = formatCurrency(total);
                    container.querySelector('#rel-faturamento-renda-mensal').textContent = formatCurrency(divisor > 0 ? total / divisor : 0);
                };

                container.addEventListener('input', calcularRelFaturamento);
                container.querySelector('#rel-faturamento-limpar').addEventListener('click', () => {
                    container.querySelectorAll('.rel-faturamento-input, #rel-faturamento-divisor').forEach(input => input.value = '');
                    calcularRelFaturamento();
                });
            }

            function initPorcentagemTab(container) {
                 container.innerHTML = `
                    <div class="space-y-6">
                        <h3 class="text-xl font-bold text-center text-[var(--accent-color)]">Calculadora de Quotas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="space-y-4 p-4 content-card">
                                <h4 class="text-lg font-semibold text-center">Calcular % por Valor</h4>
                                <div class="flex flex-col gap-2">
                                    <label for="quotas-valor-total-empresa-1" class="text-sm font-medium text-[var(--text-secondary)]">Valor total das quotas da empresa</label>
                                    <input type="text" inputmode="decimal" id="quotas-valor-total-empresa-1" placeholder="R$ 0,00" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label for="quotas-valor-associado-1" class="text-sm font-medium text-[var(--text-secondary)]">Valor monetário das quotas do associado</label>
                                    <input type="text" inputmode="decimal" id="quotas-valor-associado-1" placeholder="R$ 0,00" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2 mt-2">
                                    <label class="text-sm font-medium text-[var(--text-secondary)]">% Propriedade do Associado</label>
                                    <div class="p-3 result-display min-h-[44px] flex items-center justify-center">
                                        <p id="quotas-percentual-resultado" class="font-bold value">0.00%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-4 p-4 content-card">
                                <h4 class="text-lg font-semibold text-center">Calcular Valor por %</h4>
                                <div class="flex flex-col gap-2">
                                    <label for="quotas-valor-total-empresa-2" class="text-sm font-medium text-[var(--text-secondary)]">Valor total das quotas da empresa</label>
                                    <input type="text" inputmode="decimal" id="quotas-valor-total-empresa-2" placeholder="R$ 0,00" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label for="quotas-percentual-associado-2" class="text-sm font-medium text-[var(--text-secondary)]">% Propriedade do Associado</label>
                                    <input type="text" inputmode="decimal" id="quotas-percentual-associado-2" placeholder="0,00%" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2 mt-2">
                                    <label class="text-sm font-medium text-[var(--text-secondary)]">Valor monetário das quotas</label>
                                    <div class="p-3 result-display min-h-[44px] flex items-center justify-center">
                                        <p id="quotas-valor-resultado" class="font-bold value">R$ 0,00</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                         <button id="porcentagem-limpar-btn" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2 mt-4">
                            <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                        </button>
                    </div>`;

                const calcularQuotas = () => {
                    const valTotal1 = parseLocalFloat(container.querySelector('#quotas-valor-total-empresa-1').value);
                    const valAssoc1 = parseLocalFloat(container.querySelector('#quotas-valor-associado-1').value);
                    const perc = valTotal1 > 0 ? (valAssoc1 / valTotal1) * 100 : 0;
                    container.querySelector('#quotas-percentual-resultado').textContent = perc.toFixed(2).replace('.', ',') + '%';

                    const valTotal2 = parseLocalFloat(container.querySelector('#quotas-valor-total-empresa-2').value);
                    const percAssoc2 = parseLocalFloat(container.querySelector('#quotas-percentual-associado-2').value);
                    const valMonetario = valTotal2 * (percAssoc2 / 100);
                    container.querySelector('#quotas-valor-resultado').textContent = formatCurrency(valMonetario);
                };

                container.addEventListener('input', calcularQuotas);
                container.querySelector('#porcentagem-limpar-btn').addEventListener('click', () => {
                    container.querySelectorAll('input').forEach(input => input.value = '');
                    calcularQuotas();
                });
            }

            function initCalcDatasTab(container) {
                container.innerHTML = `
                    <div class="max-w-xl mx-auto">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6 items-end">
                            <div class="flex flex-col gap-2">
                                <label for="data-inicio" class="text-sm font-medium text-[var(--text-secondary)]">Data de Início</label>
                                <input type="date" id="data-inicio" class="w-full p-3 form-input">
                            </div>
                            <div class="flex flex-col gap-2">
                                <label for="data-fim" class="text-sm font-medium text-[var(--text-secondary)]">Data Final</label>
                                <input type="date" id="data-fim" class="w-full p-3 form-input">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                            <button id="calcular-datas" type="button" class="p-3 primary-btn flex items-center justify-center gap-2">
                                <i data-lucide="calendar-clock" class="w-5 h-5"></i> Calcular
                            </button>
                            <button id="limpar-datas" type="button" class="p-3 secondary-btn flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                            </button>
                        </div>
                        <div id="resultado-datas" class="mt-6 p-6 result-display min-h-[100px] text-center flex items-center justify-center hidden animate-fade-in"></div>
                    </div>`;

                const dataInicioInput = container.querySelector('#data-inicio');
                const dataFimInput = container.querySelector('#data-fim');
                const resultadoDatasDiv = container.querySelector('#resultado-datas');

                container.querySelector('#calcular-datas').addEventListener('click', () => {
                    const dataInicio = dataInicioInput.value, dataFim = dataFimInput.value;
                    if (!dataInicio || !dataFim) {
                        resultadoDatasDiv.innerHTML = `<p class="text-red-500 font-semibold">Selecione as duas datas.</p>`;
                        resultadoDatasDiv.classList.remove('hidden');
                        return;
                    }
                    const start = new Date(dataInicio + 'T00:00:00'), end = new Date(dataFim + 'T00:00:00');
                    if (start > end) {
                         resultadoDatasDiv.innerHTML = `<p class="text-red-500 font-semibold">A data de início não pode ser posterior à data final.</p>`;
                         resultadoDatasDiv.classList.remove('hidden');
                         return;
                    }

                    let anos = end.getFullYear() - start.getFullYear(), meses = end.getMonth() - start.getMonth(), dias = end.getDate() - start.getDate();
                    if (dias < 0) {
                        meses--;
                        dias += new Date(end.getFullYear(), end.getMonth(), 0).getDate();
                    }
                    if (meses < 0) {
                        anos--;
                        meses += 12;
                    }
                    
                    const totalDias = Math.ceil(Math.abs(end - start) / (1000 * 60 * 60 * 24)) + 1;
                    let resultadoTexto = [];
                    if (anos > 0) resultadoTexto.push(`${anos} ano${anos > 1 ? 's' : ''}`);
                    if (meses > 0) resultadoTexto.push(`${meses} ${meses > 1 ? 'meses' : 'mês'}`);
                    if (dias > 0 || (anos === 0 && meses === 0)) resultadoTexto.push(`${dias} dia${dias > 1 ? 's' : ''}`);
                    if (start.getTime() === end.getTime()) resultadoTexto = ["1 dia"];

                    resultadoDatasDiv.innerHTML = `
                        <div class="text-center">
                            <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Período Detalhado</p>
                            <p class="text-2xl font-bold value mt-1">${resultadoTexto.join(', ')}</p>
                            <p class="text-sm text-[var(--text-secondary)] mt-2">(Total de ${totalDias} dias corridos)</p>
                        </div>`;
                    resultadoDatasDiv.classList.remove('hidden');
                });
                
                container.querySelector('#limpar-datas').addEventListener('click', () => {
                    dataInicioInput.value = '';
                    dataFimInput.value = '';
                    resultadoDatasDiv.classList.add('hidden');
                });
            }

            function initRendaPfModule(container) {
                container.innerHTML = `
                    <div class="flex mb-6 border-b border-[var(--border-color)] flex-shrink-0">
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap active" data-tab="calculadora">Calculadora</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="media">Média de Holerites</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="soma">Soma de Valores</button>
                    </div>
                    <div>
                        <div id="calculadora-tab" class="renda-pf-tab-content">
                            <h3 class="text-2xl font-bold mb-6 text-center">Calculadora Renda PF</h3>
                            <div class="max-w-sm mx-auto p-4 content-card">
                                <div class="p-4 result-display text-right mb-4">
                                    <div id="renda-pf-history" class="text-2xl text-[var(--text-secondary)] h-10 truncate"></div>
                                    <input type="text" id="renda-pf-display" readonly class="w-full bg-transparent focus:outline-none text-4xl font-bold value" value="0">
                                </div>
                                <div class="grid grid-cols-4 gap-3">
                                    <button data-action="clear" class="calculator-btn p-4 secondary-btn font-semibold text-xl">AC</button>
                                    <button data-action="special" data-value="*12" class="calculator-btn p-4 secondary-btn font-semibold text-xl">x12</button>
                                    <button data-action="special" data-value="/12" class="calculator-btn p-4 secondary-btn font-semibold text-xl">/12</button>
                                    <button data-operator="/" class="calculator-btn p-4 secondary-btn font-semibold text-xl text-[var(--accent-color)]">÷</button>
                                    <button data-number="7" class="calculator-btn p-4 secondary-btn font-semibold text-xl">7</button>
                                    <button data-number="8" class="calculator-btn p-4 secondary-btn font-semibold text-xl">8</button>
                                    <button data-number="9" class="calculator-btn p-4 secondary-btn font-semibold text-xl">9</button>
                                    <button data-operator="*" class="calculator-btn p-4 secondary-btn font-semibold text-xl text-[var(--accent-color)]">×</button>
                                    <button data-number="4" class="calculator-btn p-4 secondary-btn font-semibold text-xl">4</button>
                                    <button data-number="5" class="calculator-btn p-4 secondary-btn font-semibold text-xl">5</button>
                                    <button data-number="6" class="calculator-btn p-4 secondary-btn font-semibold text-xl">6</button>
                                    <button data-operator="-" class="calculator-btn p-4 secondary-btn font-semibold text-xl text-[var(--accent-color)]">−</button>
                                    <button data-number="1" class="calculator-btn p-4 secondary-btn font-semibold text-xl">1</button>
                                    <button data-number="2" class="calculator-btn p-4 secondary-btn font-semibold text-xl">2</button>
                                    <button data-number="3" class="calculator-btn p-4 secondary-btn font-semibold text-xl">3</button>
                                    <button data-operator="+" class="calculator-btn p-4 secondary-btn font-semibold text-xl text-[var(--accent-color)]">+</button>
                                    <button data-number="0" class="calculator-btn col-span-2 p-4 secondary-btn font-semibold text-xl">0</button>
                                    <button data-number="." class="calculator-btn p-4 secondary-btn font-semibold text-xl">.</button>
                                    <button data-action="equals" class="calculator-btn p-4 primary-btn font-semibold text-xl">=</button>
                                </div>
                            </div>
                        </div>
                        <div id="media-tab" class="renda-pf-tab-content hidden">
                            <h3 class="text-2xl font-bold mb-6 text-center">Média de Holerites</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="flex flex-col gap-4">
                                    <h4 class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Valores</h4>
                                    <input type="text" inputmode="decimal" placeholder="Valor 1" class="media-holerite-input w-full p-3 form-input">
                                    <input type="text" inputmode="decimal" placeholder="Valor 2" class="media-holerite-input w-full p-3 form-input">
                                    <input type="text" inputmode="decimal" placeholder="Valor 3" class="media-holerite-input w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-4">
                                    <h4 class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Resultado</h4>
                                    <div class="p-4 result-display">
                                        <p class="text-sm font-medium">Média dos Valores</p>
                                        <p id="media_resultado" class="text-2xl font-bold value mt-1">R$ 0,00</p>
                                    </div>
                                    <button id="limpar_media" type="button" class="mt-2 p-3 secondary-btn">Limpar</button>
                                </div>
                            </div>
                        </div>
                        <div id="soma-tab" class="renda-pf-tab-content hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                                <div class="flex flex-col gap-2">
                                    <h4 class="text-sm text-[var(--text-secondary)] uppercase tracking-wide mb-2">Lançamentos</h4>
                                    <div id="soma-valores-container" class="space-y-2 max-h-[40vh] overflow-y-auto custom-scrollbar pr-2">
                                    </div>
                                </div>
                                <div class="flex flex-col gap-4">
                                     <div class="p-4 result-display">
                                         <p class="text-sm font-medium">Soma dos Itens Marcados</p>
                                         <p id="soma_total_resultado" class="text-2xl font-bold value mt-1">R$ 0,00</p>
                                     </div>
                                     <div class="p-4 result-display">
                                         <p class="text-sm font-medium">Resultado / 12</p>
                                         <p id="soma_div12_resultado" class="text-2xl font-bold value mt-1">R$ 0,00</p>
                                     </div>
                                     <button id="limpar_soma" type="button" class="w-full mt-auto p-3 secondary-btn">Limpar</button>
                                </div>
                            </div>
                        </div>
                    </div>`;

                // Lógica das Abas
                const tabButtons = container.querySelectorAll('.tab-button');
                const tabContents = container.querySelectorAll('.renda-pf-tab-content');
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        const targetTabId = `${button.dataset.tab}-tab`;
                        tabContents.forEach(content => {
                            content.classList.toggle('hidden', content.id !== targetTabId);
                        });
                    });
                });

                // Lógica da Calculadora
                const displayElement = container.querySelector('#renda-pf-display');
                const historyElement = container.querySelector('#renda-pf-history');
                const calculatorButtonsContainer = container.querySelector('#calculadora-tab');

                class Calculator {
                    constructor(displayElement, historyElement) { this.displayElement = displayElement; this.historyElement = historyElement; this.clear(); }
                    clear() { this.currentOperand = '0'; this.previousOperand = ''; this.operation = undefined; this.historyElement.innerText = ''; this.updateDisplay(); }
                    delete() { this.currentOperand = String(this.currentOperand).slice(0, -1); if (this.currentOperand === '') { this.currentOperand = '0'; } }
                    appendNumber(number) { if (this.historyElement.innerText.includes('=')) { this.clear(); } if (number === '.' && this.currentOperand.includes('.')) return; if (this.currentOperand.length > 15) return; if (this.currentOperand === '0' && number !== '.') { this.currentOperand = number; } else { this.currentOperand = this.currentOperand.toString() + number.toString(); } }
                    chooseOperation(operation) { if (this.currentOperand === '' && this.previousOperand === '') return; if (this.currentOperand === '' && this.previousOperand !== '') { this.operation = operation; this.updateDisplay(); return; } if (this.previousOperand !== '') { this.compute(); } this.operation = operation; this.previousOperand = this.currentOperand; this.currentOperand = ''; }
                    compute() { let computation; const prev = parseFloat(this.previousOperand); const current = parseFloat(this.currentOperand); if (isNaN(prev) || isNaN(current)) return; const historyText = `${this.formatDisplay(this.previousOperand)} ${this.operation.replace('*','×').replace('/','÷')} ${this.formatDisplay(this.currentOperand)} =`; switch (this.operation) { case '+': computation = prev + current; break; case '-': computation = prev - current; break; case '*': computation = prev * current; break; case '/': computation = prev / current; break; default: return; } this.currentOperand = computation.toString(); this.operation = undefined; this.previousOperand = ''; this.historyElement.innerText = historyText; }
                    handleSpecial(op) { if (this.currentOperand === '') return; const current = parseFloat(this.currentOperand); if (isNaN(current)) return; let computation; let historyText; if (op === '*12') { computation = current * 12; historyText = `${this.formatDisplay(this.currentOperand)} × 12 =`; } else if (op === '/12') { computation = current / 12; historyText = `${this.formatDisplay(this.currentOperand)} ÷ 12 =`; } else { return; } this.currentOperand = computation.toString(); this.operation = undefined; this.previousOperand = ''; this.historyElement.innerText = historyText; this.updateDisplay(); }
                    formatDisplay(numberStr) { if (numberStr === '' || numberStr === null || numberStr === undefined) return ''; const stringNumber = numberStr.toString(); const [integerPart, decimalPart] = stringNumber.split('.'); let integerDisplay; if (integerPart === '' || isNaN(parseFloat(integerPart))) { integerDisplay = '0'; } else { integerDisplay = parseFloat(integerPart).toLocaleString('pt-BR'); } if (decimalPart != null) { return `${integerDisplay},${decimalPart}`; } else { if (stringNumber.endsWith('.')) { return `${integerDisplay},`; } return integerDisplay; } }
                    updateDisplay() { this.displayElement.value = this.formatDisplay(this.currentOperand); if (this.operation != null) { this.historyElement.innerText = `${this.formatDisplay(this.previousOperand)} ${this.operation.replace('*','×').replace('/','÷')}`; } }
                }
                const calculator = new Calculator(displayElement, historyElement);
                calculatorButtonsContainer.addEventListener('click', (e) => { const button = e.target.closest('.calculator-btn'); if (!button) return; if (button.dataset.number !== undefined) { calculator.appendNumber(button.dataset.number); calculator.updateDisplay(); } if (button.dataset.operator !== undefined) { calculator.chooseOperation(button.dataset.operator); calculator.updateDisplay(); } if (button.dataset.action === 'equals') { calculator.compute(); calculator.updateDisplay(); } if (button.dataset.action === 'clear') { calculator.clear(); } if (button.dataset.action === 'special') { calculator.handleSpecial(button.dataset.value); } });
                document.addEventListener('keydown', (e) => { if (currentModuleId !== 'renda-pf-module' || container.querySelector('#calculadora-tab').classList.contains('hidden')) return; const key = e.key; if (key >= '0' && key <= '9') { e.preventDefault(); calculator.appendNumber(key); calculator.updateDisplay(); } else if (key === ',' || key === '.') { e.preventDefault(); calculator.appendNumber('.'); calculator.updateDisplay(); } else if (key === '+' || key === '-' || key === '*' || key === '/') { e.preventDefault(); calculator.chooseOperation(key); calculator.updateDisplay(); } else if (key === 'Enter' || key === '=') { e.preventDefault(); calculator.compute(); calculator.updateDisplay(); } else if (key === 'Backspace') { e.preventDefault(); calculator.delete(); calculator.updateDisplay(); } else if (key === 'Escape' || key === 'Delete') { e.preventDefault(); calculator.clear(); } });
                document.addEventListener('paste', (e) => { if (currentModuleId !== 'renda-pf-module' || container.querySelector('#calculadora-tab').classList.contains('hidden')) return; e.preventDefault(); const pasteData = (e.clipboardData || window.clipboardData).getData('text'); let sanitizedData = pasteData.replace(/[^0-9,.]/g, ''); const lastComma = sanitizedData.lastIndexOf(','); const lastDot = sanitizedData.lastIndexOf('.'); if (lastComma > lastDot) { sanitizedData = sanitizedData.replace(/\./g, '').replace(',', '.'); } else if (lastDot > lastComma) { sanitizedData = sanitizedData.replace(/,/g, ''); } if (!isNaN(parseFloat(sanitizedData)) && isFinite(sanitizedData)) { if (calculator.historyElement.innerText.includes('=')) { calculator.clear(); } calculator.currentOperand = sanitizedData; calculator.updateDisplay(); } });

                // Lógica da Média de Holerites
                const mediaInputs = container.querySelectorAll('.media-holerite-input');
                const limparMediaBtn = container.querySelector('#limpar_media');
                function calcularMedia() { let total = 0; let count = 0; mediaInputs.forEach(inp => { const val = parseLocalFloat(inp.value); if (!isNaN(val) && val > 0) { total += val; count++; } }); const media = count > 0 ? total / count : 0; container.querySelector('#media_resultado').textContent = formatCurrency(media); }
                mediaInputs.forEach(input => input.addEventListener('input', calcularMedia));
                limparMediaBtn.addEventListener('click', () => { mediaInputs.forEach(input => input.value = ''); calcularMedia(); });

                // Lógica da Soma de Valores
                const somaValoresContainer = container.querySelector('#soma-valores-container');
                const limparSomaBtn = container.querySelector('#limpar_soma');
                const NUM_SOMA_INPUTS = 12;
                function calcularSomaTotal() { let totalSoma = 0; const items = container.querySelectorAll('#soma-valores-container .soma-valor-item'); items.forEach(item => { const checkbox = item.querySelector('.soma-valor-checkbox'); const input = item.querySelector('.soma-valor-input'); if (checkbox && input && checkbox.checked) { totalSoma += parseLocalFloat(input.value); } }); container.querySelector('#soma_total_resultado').textContent = formatCurrency(totalSoma); container.querySelector('#soma_div12_resultado').textContent = formatCurrency(totalSoma / 12); }
                if (somaValoresContainer) { 
                    somaValoresContainer.innerHTML = ''; 
                    for (let i = 0; i < NUM_SOMA_INPUTS; i++) { 
                        const itemDiv = document.createElement('div'); 
                        itemDiv.className = 'soma-valor-item'; 
                        itemDiv.innerHTML = `
                            <label class="flex items-center gap-3 cursor-pointer p-1 rounded-lg"> 
                                <input type="checkbox" id="soma-check-${i}" class="soma-valor-checkbox hidden"> 
                                <span class="custom-checkbox content-card p-1 flex items-center justify-center w-6 h-6 rounded-md">
                                    <i data-lucide="check" class="check-icon w-4 h-4 opacity-0 transition-opacity"></i>
                                </span> 
                                <input type="text" inputmode="decimal" placeholder="R$ 0,00" class="soma-valor-input w-full p-2 form-input">
                            </label>`; 
                        somaValoresContainer.appendChild(itemDiv); 
                    } 
                    safeCreateIcons(); 
                    somaValoresContainer.addEventListener('input', (e) => { if (e.target.classList.contains('soma-valor-input')) { calcularSomaTotal(); } }); 
                    somaValoresContainer.addEventListener('change', (e) => { if (e.target.classList.contains('soma-valor-checkbox')) { 
                        const label = e.target.closest('label');
                        const checkIcon = label.querySelector('.check-icon');
                        checkIcon.style.opacity = e.target.checked ? '1' : '0';
                        calcularSomaTotal(); 
                    } }); 
                }
                if (limparSomaBtn) { 
                    limparSomaBtn.addEventListener('click', () => { 
                        container.querySelectorAll('#soma-valores-container .soma-valor-input').forEach(input => input.value = ''); 
                        container.querySelectorAll('#soma-valores-container .soma-valor-checkbox').forEach(checkbox => {
                            checkbox.checked = false;
                            const icon = checkbox.closest('label').querySelector('.check-icon');
                            if(icon) icon.style.opacity = '0';
                        }); 
                        calcularSomaTotal(); 
                    }); 
                }
            }
            
            function initRendaAgroModule(container) {
                container.innerHTML = `
                    <div class="flex mb-6 border-b border-[var(--border-color)] flex-shrink-0 overflow-x-auto">
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap active" data-tab="semoventes">Semoventes</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="mov_economica">Mov. Econômica</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="nfs">NF's</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="produtor">Produtor</button>
                        <button class="tab-button py-3 px-4 font-semibold whitespace-nowrap" data-tab="fcpr">FCPR</button>
                    </div>
                    <div>
                        <div id="semoventes-tab" class="renda-agro-tab-content"></div>
                        <div id="mov_economica-tab" class="renda-agro-tab-content hidden"></div>
                        <div id="nfs-tab" class="renda-agro-tab-content hidden"></div>
                        <div id="produtor-tab" class="renda-agro-tab-content hidden"></div>
                        <div id="fcpr-tab" class="renda-agro-tab-content hidden"></div>
                    </div>`;

                const tabButtons = container.querySelectorAll('.tab-button');
                const tabContents = container.querySelectorAll('.renda-agro-tab-content');

                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        const targetTabId = `${button.dataset.tab}-tab`;
                        tabContents.forEach(content => {
                            content.classList.toggle('hidden', content.id !== targetTabId);
                        });
                        safeCreateIcons();
                    });
                });
                
                // --- INICIALIZAÇÃO DOS CONTEÚDOS DAS ABAS ---
                
                // Aba Semoventes
                const semoventesTab = container.querySelector('#semoventes-tab');
                semoventesTab.innerHTML = `
                    <div class="flex flex-col gap-8">
                        <div>
                            <div class="max-w-md mx-auto space-y-4 p-4 content-card">
                                <h3 class="text-xl font-semibold text-center">Cálculo IRPF (Receita Bruta)</h3>
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="flex flex-col gap-2">
                                        <label for="irpf-receita-bruta" class="text-sm font-medium text-[var(--text-secondary)]">Receita Bruta - Brasil</label>
                                        <input type="text" inputmode="decimal" id="irpf-receita-bruta" placeholder="R$ 0,00" class="w-full p-3 form-input">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label for="irpf-vendas" class="text-sm font-medium text-[var(--text-secondary)]">Vendas (Qtd)</label>
                                        <input type="number" id="irpf-vendas" placeholder="0" class="w-full p-3 form-input">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label for="irpf-estoque-final" class="text-sm font-medium text-[var(--text-secondary)]">Estoque Final (Qtd)</label>
                                        <input type="number" id="irpf-estoque-final" placeholder="0" class="w-full p-3 form-input">
                                    </div>
                                    <div class="flex flex-col gap-2">
                                        <label class="text-sm font-medium text-[var(--text-secondary)]">Valor Apurado (Estoque)</label>
                                        <div class="w-full p-3 result-display h-full flex items-center justify-center">
                                            <p id="irpf-resultado-valor" class="text-xl font-bold value">R$ 0,00</p>
                                        </div>
                                    </div>
                                </div>
                                <button id="irpf-limpar" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                </button>
                            </div>
                        </div>
                        <hr class="border-[var(--border-color)] my-4">
                        <div>
                            <h3 class="text-xl font-semibold mb-6 text-center">Cálculo de Rebanho (Valor Unitário)</h3>
                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div class="lg:col-span-2 overflow-x-auto content-card p-2">
                                    <table class="w-full text-sm">
                                        <thead class="border-b-2 border-[var(--border-color)]">
                                            <tr>
                                                <th class="p-2 text-left">Descrição</th>
                                                <th class="p-2 text-left">Qtd</th>
                                                <th class="p-2 text-left">Valor Unitário</th>
                                                <th class="p-2 text-left">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody id="semoventes-tbody"></tbody>
                                    </table>
                                </div>
                                <div class="flex flex-col gap-4">
                                    <div class="p-4 content-card space-y-4">
                                        <div class="flex flex-col gap-2 text-center">
                                            <label class="text-sm font-medium text-[var(--text-secondary)]">Quantidade Total</label>
                                            <p id="semoventes-qtd-total" class="text-2xl font-bold value">0</p>
                                        </div>
                                        <div class="flex flex-col gap-2">
                                            <label for="semoventes-propriedade" class="text-sm font-medium text-[var(--text-secondary)]">Propriedade (%)</label>
                                            <input type="text" inputmode="decimal" id="semoventes-propriedade" value="100" class="w-full p-3 form-input text-center">
                                        </div>
                                        <div class="flex flex-col gap-2 text-center">
                                            <label class="text-sm font-medium text-[var(--text-secondary)]">Renda Anual</label>
                                             <p id="semoventes-renda-anual" class="text-2xl font-bold value">R$ 0,00</p>
                                        </div>
                                        <div class="flex flex-col gap-2 text-center">
                                            <label class="text-sm font-medium text-[var(--text-secondary)]">Renda Mensal</label>
                                            <p id="semoventes-renda-mensal" class="text-2xl font-bold value">R$ 0,00</p>
                                        </div>
                                    </div>
                                    <button id="semoventes-limpar" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar Rebanho
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;

                const semoventesTbody = semoventesTab.querySelector('#semoventes-tbody');
                const semoventesData = [ 'Matrizes (+ 36 meses)', 'Touros', 'Bois (+ 36 meses)', 'Novilhas (25 a 36 meses)', 'Novilhos (25 a 36 meses)', 'Novilhas (13 a 24 meses)', 'Novilhos (13 a 24 meses)', 'Bezerras/terneiras até 12 meses', 'Bezerros/terneiros até 12 meses' ];
                semoventesTbody.innerHTML = semoventesData.map((desc, index) => `
                    <tr class="border-b border-[var(--border-color)] last:border-b-0">
                        <td class="p-2">${desc}</td>
                        <td class="p-2"><input type="number" id="semovente-qtd-${index}" class="semovente-input w-20 p-2 form-input" placeholder="0"></td>
                        <td class="p-2"><input type="text" inputmode="decimal" id="semovente-valor-${index}" class="semovente-input w-32 p-2 form-input" placeholder="R$ 0,00"></td>
                        <td class="p-2 font-semibold" id="semovente-total-${index}">R$ 0,00</td>
                    </tr>`).join('');
                
                const calcularSemoventes = () => {
                    let grandTotalAnual = 0, grandTotalQtd = 0;
                    semoventesData.forEach((_, index) => {
                        const qtd = parseInt(semoventesTab.querySelector(`#semovente-qtd-${index}`).value) || 0;
                        const valor = parseLocalFloat(semoventesTab.querySelector(`#semovente-valor-${index}`).value);
                        const total = qtd * valor;
                        semoventesTab.querySelector(`#semovente-total-${index}`).textContent = formatCurrency(total);
                        grandTotalAnual += total;
                        grandTotalQtd += qtd;
                    });
                    const propriedade = parseLocalFloat(semoventesTab.querySelector('#semoventes-propriedade').value) / 100;
                    const totalComPropriedade = grandTotalAnual * (propriedade > 0 ? propriedade : 1);
                    semoventesTab.querySelector('#semoventes-qtd-total').textContent = grandTotalQtd;
                    semoventesTab.querySelector('#semoventes-renda-anual').textContent = formatCurrency(totalComPropriedade);
                    semoventesTab.querySelector('#semoventes-renda-mensal').textContent = formatCurrency(totalComPropriedade / 12);
                };
                
                const calcularIrpfSemoventes = () => {
                    const receitaBruta = parseLocalFloat(semoventesTab.querySelector('#irpf-receita-bruta').value);
                    const vendas = parseInt(semoventesTab.querySelector('#irpf-vendas').value) || 0;
                    const estoqueFinal = parseInt(semoventesTab.querySelector('#irpf-estoque-final').value) || 0;
                    const resultado = vendas > 0 ? (receitaBruta / vendas) * estoqueFinal : 0;
                    semoventesTab.querySelector('#irpf-resultado-valor').textContent = formatCurrency(resultado);
                };

                semoventesTab.addEventListener('input', (e) => {
                    if (e.target.classList.contains('semovente-input') || e.target.id === 'semoventes-propriedade') {
                        calcularSemoventes();
                    } else {
                        calcularIrpfSemoventes();
                    }
                });
                
                semoventesTab.querySelector('#semoventes-limpar').addEventListener('click', () => {
                    semoventesTab.querySelectorAll('.semovente-input').forEach(input => input.value = '');
                    semoventesTab.querySelector('#semoventes-propriedade').value = '100';
                    calcularSemoventes();
                });

                semoventesTab.querySelector('#irpf-limpar').addEventListener('click', () => {
                    semoventesTab.querySelector('#irpf-receita-bruta').value = '';
                    semoventesTab.querySelector('#irpf-vendas').value = '';
                    semoventesTab.querySelector('#irpf-estoque-final').value = '';
                    calcularIrpfSemoventes();
                });

                // --- Aba Mov. Econômica ---
                const movEconomicaTab = container.querySelector('#mov_economica-tab');
                movEconomicaTab.innerHTML = `
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 overflow-x-auto content-card p-2">
                            <table class="w-full text-sm">
                                <thead class="border-b-2 border-[var(--border-color)]">
                                    <tr>
                                        <th class="p-2 text-left">Produtos</th>
                                        <th class="p-2 text-left">Quant CB/KG</th>
                                        <th class="p-2 text-left">Valor no doc. CONAB</th>
                                        <th class="p-2 text-left">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody id="mov-economica-tbody">
                                    ${Array.from({ length: 10 }, (_, i) => `
                                        <tr class="border-b border-[var(--border-color)] last:border-b-0">
                                            <td class="p-2">Produto ${i+1}</td>
                                            <td class="p-2"><input type="number" id="mov-cb-${i}" class="mov-input w-24 p-2 form-input" placeholder="0"></td>
                                            <td class="p-2"><input type="text" inputmode="decimal" id="mov-valor-${i}" class="mov-input w-32 p-2 form-input" placeholder="0,00"></td>
                                            <td class="p-2 font-semibold" id="mov-total-${i}">R$ 0,00</td>
                                        </tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="content-card p-4 space-y-4 text-center">
                                <h3 class="text-lg font-semibold">Total</h3>
                                <p id="mov-total-geral" class="text-2xl font-bold value">R$ 0,00</p>
                            </div>
                            <button id="mov-limpar" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                            </button>
                        </div>
                    </div>`;
                    const calcularMovEconomica = () => {
                        let totalGeral = 0;
                        for (let i = 0; i < 10; i++) {
                            const cb = parseInt(movEconomicaTab.querySelector(`#mov-cb-${i}`).value) || 0;
                            const valor = parseLocalFloat(movEconomicaTab.querySelector(`#mov-valor-${i}`).value);
                            const total = cb * valor;
                            movEconomicaTab.querySelector(`#mov-total-${i}`).textContent = formatCurrency(total);
                            totalGeral += total;
                        }
                        movEconomicaTab.querySelector('#mov-total-geral').textContent = formatCurrency(totalGeral);
                    };

                    movEconomicaTab.addEventListener('input', (e) => {
                        if (e.target.classList.contains('mov-input')) {
                            calcularMovEconomica();
                        }
                    });
                    movEconomicaTab.querySelector('#mov-limpar').addEventListener('click', () => {
                        movEconomicaTab.querySelectorAll('.mov-input').forEach(input => input.value = '');
                        calcularMovEconomica();
                    });

                // --- Aba NFs ---
                const nfsTab = container.querySelector('#nfs-tab');
                nfsTab.innerHTML = `
                     <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 content-card p-4">
                            <h3 class="text-lg font-semibold mb-4">Notas Fiscais</h3>
                            <div id="nfs-grid" class="grid grid-flow-col grid-rows-10 gap-x-8 gap-y-2 overflow-x-auto custom-scrollbar pb-2"></div>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="content-card p-4 space-y-4">
                                <h3 class="text-lg font-semibold text-center">Cálculo</h3>
                                <div class="flex flex-col gap-2">
                                    <label for="nfs-propriedade" class="text-sm font-medium text-[var(--text-secondary)]">Propriedade (%)</label>
                                    <input type="text" inputmode="decimal" id="nfs-propriedade" value="100" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2 text-center">
                                    <label class="text-sm font-medium text-[var(--text-secondary)]">Renda Anual</label>
                                    <p id="nfs-renda-anual" class="text-2xl font-bold value">R$ 0,00</p>
                                </div>
                                <div class="flex flex-col gap-2 text-center">
                                    <label class="text-sm font-medium text-[var(--text-secondary)]">Renda Mensal</label>
                                    <p id="nfs-renda-mensal" class="text-2xl font-bold value">R$ 0,00</p>
                                </div>
                            </div>
                            <button id="nfs-limpar" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                            </button>
                        </div>
                    </div>`;

                const nfsGrid = nfsTab.querySelector('#nfs-grid');
                nfsGrid.innerHTML = Array.from({ length: 50 }, (_, i) => `
                    <div class="flex items-center gap-2">
                        <label for="nf-${i+1}" class="text-sm font-medium w-12">${i+1}</label>
                        <input type="text" inputmode="decimal" id="nf-${i+1}" class="nf-input w-full p-2 form-input" placeholder="0,00">
                    </div>`).join('');

                const calcularNFs = () => {
                    let total = 0;
                    nfsTab.querySelectorAll('.nf-input').forEach(input => total += parseLocalFloat(input.value));
                    const propriedade = parseLocalFloat(nfsTab.querySelector('#nfs-propriedade').value) / 100;
                    const rendaAnual = total * (propriedade > 0 ? propriedade : 1);
                    nfsTab.querySelector('#nfs-renda-anual').textContent = formatCurrency(rendaAnual);
                    nfsTab.querySelector('#nfs-renda-mensal').textContent = formatCurrency(rendaAnual / 12);
                };
                nfsTab.addEventListener('input', calcularNFs);
                nfsTab.querySelector('#nfs-limpar').addEventListener('click', () => {
                    nfsTab.querySelectorAll('.nf-input').forEach(input => input.value = '');
                    nfsTab.querySelector('#nfs-propriedade').value = '100';
                    calcularNFs();
                });

                // --- Aba Produtor ---
                const produtorTab = container.querySelector('#produtor-tab');
                produtorTab.innerHTML = `
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                            <div class="space-y-4 p-4 content-card">
                                <h3 class="text-xl font-bold text-center mb-4">Rendas</h3>
                                <div class="flex flex-col gap-2">
                                    <label for="produtor-renda-agro" class="text-sm font-medium text-[var(--text-secondary)]">Renda Agro</label>
                                    <input type="text" inputmode="decimal" id="produtor-renda-agro" placeholder="R$ 0,00" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label for="produtor-renda-nao-agro" class="text-sm font-medium text-[var(--text-secondary)]">Renda Não Agro</label>
                                    <input type="text" inputmode="decimal" id="produtor-renda-nao-agro" placeholder="R$ 0,00" class="w-full p-3 form-input">
                                </div>
                                 <button id="produtor-limpar-btn" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2 mt-4">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                                </button>
                            </div>
                            <div class="p-4 content-card text-center flex flex-col">
                                <h3 class="text-xl font-bold mb-4 flex-shrink-0">Resultados</h3>
                                <div class="p-3 result-display h-full flex-grow flex flex-col justify-around">
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-secondary)]">Renda Total</label>
                                        <p id="produtor-renda-total" class="text-2xl font-bold value">R$ 0,00</p>
                                    </div>
                                    <hr class="border-[var(--border-color)] my-2">
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-secondary)]">Porcentagens (Agro / Não Agro)</label>
                                        <p id="produtor-porcentagens" class="text-xl font-bold value">0,00% / 0,00%</p>
                                     </div>
                                     <hr class="border-[var(--border-color)] my-2">
                                    <div>
                                        <label class="text-sm font-medium text-[var(--text-secondary)]">Classificação do Produtor</label>
                                        <p id="produtor-classificacao" class="text-xl font-bold value">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;

                const calcularProdutor = () => {
                    const rendaAgro = parseLocalFloat(produtorTab.querySelector('#produtor-renda-agro').value);
                    const rendaNaoAgro = parseLocalFloat(produtorTab.querySelector('#produtor-renda-nao-agro').value);
                    const total = rendaAgro + rendaNaoAgro;
                    const percAgro = total > 0 ? (rendaAgro / total) * 100 : 0;
                    const percNaoAgro = total > 0 ? (rendaNaoAgro / total) * 100 : 0;
                    let classificacao = '-';
                    if (total > 0) {
                        if (percNaoAgro > 20) { classificacao = 'Grande Produtor'; }
                        else if (rendaAgro <= 500000) { classificacao = 'Pequeno Produtor'; }
                        else if (rendaAgro <= 3500000) { classificacao = 'Médio Produtor'; }
                        else { classificacao = 'Grande Produtor'; }
                    }
                    produtorTab.querySelector('#produtor-renda-total').textContent = formatCurrency(total);
                    produtorTab.querySelector('#produtor-porcentagens').textContent = `${percAgro.toFixed(2).replace('.', ',')}% / ${percNaoAgro.toFixed(2).replace('.', ',')}%`;
                    produtorTab.querySelector('#produtor-classificacao').textContent = classificacao;
                };
                produtorTab.addEventListener('input', calcularProdutor);
                produtorTab.querySelector('#produtor-limpar-btn').addEventListener('click', () => {
                    produtorTab.querySelector('#produtor-renda-agro').value = '';
                    produtorTab.querySelector('#produtor-renda-nao-agro').value = '';
                    calcularProdutor();
                });


                 // --- Aba FCPR ---
                const fcprTab = container.querySelector('#fcpr-tab');
                fcprTab.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div class="flex flex-col gap-2 content-card p-4">
                            <h3 class="text-lg font-semibold mb-2">Renda Agrícola & Agropecuária</h3>
                            <div id="fcpr-inputs" class="space-y-2"></div>
                        </div>
                        <div class="flex flex-col gap-4">
                            <div class="content-card p-4 space-y-4">
                                <h3 class="text-lg font-semibold text-center">Configurações</h3>
                                <div class="flex flex-col gap-2">
                                    <label for="fcpr-percentual" class="text-sm font-medium text-[var(--text-secondary)]">Percentual (%)</label>
                                    <input type="text" inputmode="decimal" id="fcpr-percentual" value="100" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2">
                                    <label for="fcpr-meses" class="text-sm font-medium text-[var(--text-secondary)]">Meses</label>
                                    <input type="number" id="fcpr-meses" value="12" class="w-full p-3 form-input">
                                </div>
                                <div class="flex flex-col gap-2 text-center">
                                    <label class="text-sm font-medium text-[var(--text-secondary)]">Renda Anual</label>
                                    <p id="fcpr-renda-anual" class="text-2xl font-bold value">R$ 0,00</p>
                                </div>
                                <div class="flex flex-col gap-2 text-center">
                                    <label class="text-sm font-medium text-[var(--text-secondary)]">Renda Mensal</label>
                                    <p id="fcpr-renda-mensal" class="text-2xl font-bold value">R$ 0,00</p>
                                </div>
                            </div>
                            <button id="fcpr-limpar" type="button" class="w-full p-3 secondary-btn flex items-center justify-center gap-2">
                                <i data-lucide="trash-2" class="w-5 h-5"></i> Limpar
                            </button>
                        </div>
                   </div>`;

                const fcprInputsContainer = fcprTab.querySelector('#fcpr-inputs');
                fcprInputsContainer.innerHTML = Array.from({ length: 10 }, (_, i) => `
                    <div class="flex items-center gap-2">
                        <label for="fcpr-renda-${i+1}" class="w-24 text-sm font-medium">Renda ${i+1}</label>
                        <input type="text" inputmode="decimal" id="fcpr-renda-${i+1}" placeholder="R$ 0,00" class="fcpr-input w-full p-2 form-input">
                    </div>`).join('');
                
                const calcularFCPR = () => {
                    let totalRendas = 0;
                    fcprTab.querySelectorAll('.fcpr-input').forEach(input => totalRendas += parseLocalFloat(input.value));
                    const percentual = parseLocalFloat(fcprTab.querySelector('#fcpr-percentual').value) / 100;
                    const meses = parseInt(fcprTab.querySelector('#fcpr-meses').value) || 12;
                    const rendaAnual = totalRendas * (percentual > 0 ? percentual : 1);
                    fcprTab.querySelector('#fcpr-renda-anual').textContent = formatCurrency(rendaAnual);
                    fcprTab.querySelector('#fcpr-renda-mensal').textContent = formatCurrency(meses > 0 ? rendaAnual / meses : 0);
                };
                fcprTab.addEventListener('input', calcularFCPR);
                fcprTab.querySelector('#fcpr-limpar').addEventListener('click', () => {
                    fcprTab.querySelectorAll('.fcpr-input').forEach(input => input.value = '');
                    fcprTab.querySelector('#fcpr-percentual').value = '100';
                    fcprTab.querySelector('#fcpr-meses').value = '12';
                    calcularFCPR();
                });
            }

            function initRegrasModule(container) {
               container.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <div class="relative flex-grow">
                             <input type="text" id="regras-search-input" placeholder="Pesquisar por item, ref ou tipo..." class="w-full p-3 pr-10 form-input">
                             <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--text-secondary)]"></i>
                        </div>
                    </div>
                    <div class="overflow-auto custom-scrollbar border border-[var(--border-color)] rounded-lg">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-[var(--bg-color)] sticky top-0">
                                <tr class="border-b border-[var(--border-color)]">
                                    <th class="p-3 font-semibold">Item</th>
                                    <th class="p-3 font-semibold">Referência</th>
                                    <th class="p-3 font-semibold">Tipo de Renda Aceito</th>
                                </tr>
                            </thead>
                            <tbody id="regras-irpf-tbody"></tbody>
                        </table>
                    </div>`;

                const tbody = container.querySelector('#regras-irpf-tbody');
                const searchInput = container.querySelector('#regras-search-input');
                
                const renderTable = (filter = '') => {
                    if(typeof regrasData === 'undefined' || !tbody) return;
                    
                    tbody.innerHTML = '';
                    const lowerCaseFilter = removeAccents(filter.toLowerCase());

                    const filteredData = regrasData.filter(regra => {
                        return removeAccents(regra.item.toLowerCase()).includes(lowerCaseFilter) ||
                               removeAccents(regra.ref.toLowerCase()).includes(lowerCaseFilter) ||
                               regra.type.some(t => removeAccents(t.toLowerCase()).includes(lowerCaseFilter));
                    });
                    
                    if (filteredData.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-[var(--text-secondary)]">Nenhum resultado encontrado.</td></tr>`;
                        return;
                    }

                    filteredData.forEach(regra => {
                        const row = document.createElement('tr');
                        row.className = 'border-b border-[var(--border-color)] last:border-b-0';
                        row.innerHTML = `
                            <td class="p-3 font-semibold">${regra.item}</td>
                            <td class="p-3">${regra.ref}</td>
                            <td class="p-3">${regra.type.join(', ')}</td>
                        `;
                        tbody.appendChild(row);
                    });
                };
                
                searchInput.addEventListener('input', () => renderTable(searchInput.value));
                renderTable(); // Render inicial
            }
            
            function initCnpjModule(container) {
                container.innerHTML = `
                    <div class="flex flex-col sm:flex-row gap-4">
                        <input type="text" id="cnpj-input" placeholder="00.000.000/0000-00" class="flex-grow p-3 form-input">
                        <button id="consultar-cnpj" class="p-3 primary-btn flex items-center justify-center gap-2"><i data-lucide="search" class="w-5 h-5"></i> Consultar</button>
                        <button id="limpar-cnpj" class="p-3 secondary-btn flex items-center justify-center gap-2"><i data-lucide="x" class="w-5 h-5"></i> Limpar</button>
                    </div>
                    <div id="cnpj-results-container" class="mt-6"></div>`;

                const cnpjInput = container.querySelector('#cnpj-input');
                const consultarBtn = container.querySelector('#consultar-cnpj');
                const limparBtn = container.querySelector('#limpar-cnpj');
                const resultsContainer = container.querySelector('#cnpj-results-container');
                
                cnpjInput.addEventListener('input', (e) => {
                    let value = e.target.value.replace(/\D/g, '');
                    value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                    value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                    value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                    value = value.replace(/(\d{4})(\d)/, '$1-$2');
                    e.target.value = value.slice(0, 18);
                });

                limparBtn.addEventListener('click', () => {
                    cnpjInput.value = '';
                    resultsContainer.innerHTML = '';
                });

                consultarBtn.addEventListener('click', async () => {
                    const cnpj = cnpjInput.value.replace(/\D/g, '');
                    if (cnpj.length !== 14) {
                        resultsContainer.innerHTML = `<div class="p-4 content-card text-center text-red-500">Por favor, insira um CNPJ válido com 14 dígitos.</div>`;
                        return;
                    }

                    consultarBtn.disabled = true;
                    consultarBtn.innerHTML = `
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Consultando...
                    `;

                    try {
                        const response = await fetch(`https://brasilapi.com.br/api/cnpj/v1/${cnpj}`);
                        if (response.status === 404) {
                           throw new Error("CNPJ não encontrado na base de dados.");
                        }
                        if (!response.ok) {
                            throw new Error(`Erro na API: ${response.statusText}`);
                        }
                        const data = await response.json();
                        displayCnpjResults(data, resultsContainer);
                    } catch (error) {
                        resultsContainer.innerHTML = `<div class="p-4 content-card text-center text-red-500"><strong>Falha na consulta:</strong> ${error.message}</div>`;
                    } finally {
                        consultarBtn.disabled = false;
                        consultarBtn.innerHTML = `<i data-lucide="search" class="w-5 h-5"></i> Consultar`;
                        safeCreateIcons();
                    }
                });
            }

            function displayCnpjResults(data, container) {
                const isSimples = data.opcao_pelo_simples ? 'Sim' : 'Não';
                const isSimei = data.opcao_pelo_mei ? 'Sim' : 'Não';
                const porteEmpresa = data.porte || 'Não informado';
                const dataAbertura = data.data_inicio_atividade;
                const nomeEmpresa = data.razao_social || 'Não informado';

                let conteudoHistorico = '';
                let avisoExclusao = '';

                if (data.opcao_pelo_simples !== null && data.data_opcao_pelo_simples) {
                    if (data.opcao_pelo_simples) {
                        conteudoHistorico = `<p class="text-sm">Optante desde: <strong class="text-green-600 dark:text-green-500">${formatDate(data.data_opcao_pelo_simples)}</strong></p>`;
                    } else {
                        if (data.data_exclusao_do_simples) {
                            conteudoHistorico = `<p class="text-sm">Esteve no Simples de <strong class="text-[var(--text-secondary)]">${formatDate(data.data_opcao_pelo_simples)}</strong> até <strong class="text-red-600 dark:text-red-500">${formatDate(data.data_exclusao_do_simples)}</strong>.</p>`;
                            const anoExclusao = new Date(data.data_exclusao_do_simples).getFullYear();
                            if (anoExclusao === 2024 || anoExclusao === 2025) {
                                avisoExclusao = `
                                    <div class="mt-3 p-3 border-l-4 border-yellow-500 bg-yellow-100 dark:bg-yellow-900/20 text-yellow-800 dark:text-yellow-300 rounded-r-lg">
                                        <h4 class="font-bold">Atenção!</h4>
                                        <p class="text-sm">A empresa foi desenquadrada em ${anoExclusao}. A análise de faturamento deve considerar o regime correspondente (Lucro Presumido/Real) a partir desta data.</p>
                                    </div>
                                `;
                            }
                        } else {
                           conteudoHistorico = `<p class="text-sm">A empresa não é optante, mas não há data de exclusão registrada.</p>`;
                        }
                    }
                } else {
                     conteudoHistorico = `<p class="text-sm text-[var(--text-secondary)]">Não há informações sobre o histórico do Simples Nacional para esta empresa.</p>`;
                }
                
                const historicoSimplesHtml = `
                    <div class="p-4 content-card">
                        <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide mb-2">Histórico do Simples Nacional</p>
                        ${conteudoHistorico}
                        ${avisoExclusao}
                    </div>
                `;

                let sociosHtml = '<p class="text-[var(--text-secondary)]">Nenhum sócio encontrado.</p>';
                if (data.qsa && data.qsa.length > 0) {
                    sociosHtml = `<ul class="list-disc list-inside space-y-1">${data.qsa.map(socio => `<li>${socio.nome_socio} <span class="text-[var(--text-secondary)]">(${socio.qualificacao_socio})</span></li>`).join('')}</ul>`;
                }

                const rawJsonHtml = `
                    <details class="mt-4">
                        <summary class="cursor-pointer font-semibold text-sm text-[var(--text-secondary)]">Ver resposta JSON completa</summary>
                        <pre class="mt-2 p-4 content-card text-xs overflow-auto custom-scrollbar"><code>${JSON.stringify(data, null, 2)}</code></pre>
                    </details>
                `;

                container.innerHTML = `
                    <div class="space-y-4 animate-fade-in">
                        <div class="p-4 content-card">
                            <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Razão Social</p>
                            <p class="text-lg font-bold text-[var(--accent-color)] mt-1">${nomeEmpresa}</p>
                        </div>
                        <div class="p-4 content-card">
                            <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Nome Fantasia</p>
                            <p class="font-semibold mt-1">${data.nome_fantasia || 'Não informado'}</p>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 content-card">
                                <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Data de Abertura</p>
                                <p class="font-semibold mt-1">${formatDate(dataAbertura)}</p>
                            </div>
                            <div class="p-4 content-card">
                                <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Situação Cadastral</p>
                                <p class="font-bold text-lg ${data.descricao_situacao_cadastral === 'ATIVA' ? 'text-green-500' : 'text-red-500'} mt-1">${data.descricao_situacao_cadastral || 'Não informado'}</p>
                            </div>
                        </div>
                         <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 content-card">
                                <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Porte da Empresa</p>
                                <p class="font-semibold mt-1">${porteEmpresa}</p>
                            </div>
                             <div class="p-4 content-card">
                                <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Capital Social</p>
                                <p class="font-semibold mt-1">${formatCurrency(data.capital_social)}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="p-4 content-card">
                                <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">CNAE Fiscal</p>
                                <p class="font-semibold mt-1">${data.cnae_fiscal}</p>
                            </div>
                            <div class="p-4 content-card">
                                <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Código Natureza Jurídica</p>
                                <p class="font-semibold mt-1">${String(data.codigo_natureza_juridica).slice(0, 3)}-${String(data.codigo_natureza_juridica).slice(3)}</p>
                            </div>
                        </div>
                        <div class="p-4 content-card">
                            <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Atividade Principal (CNAE)</p>
                            <p class="font-semibold mt-1">${data.cnae_fiscal_descricao || 'Não informado'}</p>
                        </div>
                         <div class="p-4 content-card">
                            <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Endereço</p>
                            <p class="font-semibold mt-1">${data.logradouro || ''}, ${data.numero || ''} - ${data.bairro || ''}, ${data.municipio || ''} - ${data.uf || ''}, CEP: ${data.cep || ''}</p>
                        </div>
                        <div class="p-4 content-card">
                            <p class="text-sm text-[var(--text-secondary)] uppercase tracking-wide mb-2">Quadro de Sócios e Administradores (QSA)</p>
                            <div class="font-semibold">${sociosHtml}</div>
                        </div>
                        ${rawJsonHtml}
                    </div>
                `;
                safeCreateIcons();
            }

            function initParecerModule(container) {
                container.innerHTML = `
                    <div class="flex flex-col sm:flex-row items-center mb-6 gap-4 flex-shrink-0">
                        <div class="relative flex-grow w-full">
                            <input type="text" id="parecer-search-input" placeholder="Pesquisar pareceres por tipo ou descrição..." class="w-full p-3 pr-12 form-input">
                            <i data-lucide="search" class="absolute right-4 top-1/2 -translate-y-1/2 w-5 h-5 text-[var(--text-secondary)]"></i>
                        </div>
                        <div class="w-full sm:w-auto">
                            <select id="parecer-category-filter" class="w-full p-3 form-input"></select>
                        </div>
                    </div>
                    <div id="pareceres-container" class="space-y-4 overflow-auto custom-scrollbar flex-grow" style="height: calc(60vh - 120px);"></div>
                `;

                const searchInput = container.querySelector('#parecer-search-input');
                const categoryFilter = container.querySelector('#parecer-category-filter');
                const resultsContainer = container.querySelector('#pareceres-container');

                function populateParecerFilter() {
                    if (typeof pareceresDataCorrigido === 'undefined') return;
                    categoryFilter.innerHTML = '<option value="all">Todas as Categorias</option>';
                    for (const mainCategory in pareceresDataCorrigido) {
                        categoryFilter.innerHTML += `<option value="${mainCategory}">${mainCategory}</option>`;
                    }
                }

                function renderPareceres(data) {
                    resultsContainer.innerHTML = '';
                    let contentRendered = false;

                    for (const mainCategory in data) {
                        const subCategories = data[mainCategory];
                        let mainCategoryHtml = `<h3 class="text-xl font-bold mb-4 border-b-2 border-[var(--border-color)] pb-2">${mainCategory}</h3>`;
                        let contentHtml = '<div class="space-y-4">';
                        let hasSubResults = false;

                        function createParecerHTML(key, value) {
                            hasSubResults = true;
                            contentRendered = true;
                            const fullParecerText = `${key}: ${value}`;
                            return `
                                <div class="p-4 content-card flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                                    <div class="flex-1 min-w-0">
                                        <h5 class="font-semibold mb-1">${key}</h5>
                                        <p class="text-sm whitespace-normal break-words text-[var(--text-secondary)]">${value}</p>
                                    </div>
                                    <div class="flex-shrink-0 flex items-center self-start sm:self-center">
                                        <button class="copy-parecer-btn p-2 secondary-btn text-sm font-bold flex items-center gap-2" data-text-to-copy="${encodeURIComponent(fullParecerText)}">
                                            <i data-lucide="copy" class="w-4 h-4"></i> Copiar
                                        </button>
                                    </div>
                                </div>`;
                        }

                        for (const subCategoryTitle in subCategories) {
                            const items = subCategories[subCategoryTitle];
                            if (typeof items === 'object' && items !== null) {
                                let subCategoryContent = '';
                                for (const key in items) {
                                    subCategoryContent += createParecerHTML(key, items[key]);
                                }
                                if(subCategoryContent) {
                                    contentHtml += `<h4 class="text-lg font-semibold mb-3 mt-4">${subCategoryTitle}</h4>` + subCategoryContent;
                                }
                            } else {
                                contentHtml += createParecerHTML(subCategoryTitle, items);
                            }
                        }
                        contentHtml += '</div>';
                        if (hasSubResults) {
                            resultsContainer.innerHTML += mainCategoryHtml + contentHtml;
                        }
                    }

                    if (!contentRendered) {
                        resultsContainer.innerHTML = `<div class="text-center text-lg py-8 text-[var(--text-secondary)]">Nenhum parecer encontrado.</div>`;
                    }
                    resultsContainer.querySelectorAll('.copy-parecer-btn').forEach(button => {
                        button.addEventListener('click', (e) => {
                            const text = decodeURIComponent(e.currentTarget.dataset.textToCopy);
                            copyText(text, e.currentTarget);
                        });
                    });
                    safeCreateIcons();
                }
                
                function filterPareceres() {
                    if(typeof pareceresDataCorrigido === 'undefined') {
                         resultsContainer.innerHTML = `<div class="text-center text-lg py-8 text-[var(--text-secondary)]">Dados de pareceres não carregados.</div>`;
                         return;
                    };
                    
                    const searchTerm = removeAccents(searchInput.value.toLowerCase());
                    const selectedCategory = categoryFilter.value;
                    
                    const sourceData = selectedCategory === 'all' ? pareceresDataCorrigido : { [selectedCategory]: pareceresDataCorrigido[selectedCategory] };

                    const filteredData = {};
                    for (const mainCategory in sourceData) {
                        const subCategories = sourceData[mainCategory];
                        const filteredSubCategories = {};
                        let hasMatch = false;
                        for (const subCategoryTitle in subCategories) {
                            const items = subCategories[subCategoryTitle];
                            if (typeof items === 'object' && items !== null) {
                                const filteredItems = {};
                                for(const key in items) {
                                    const normalizedKey = removeAccents(key.toLowerCase());
                                    const normalizedValue = removeAccents(String(items[key]).toLowerCase());
                                    if (normalizedKey.includes(searchTerm) || normalizedValue.includes(searchTerm)) {
                                        filteredItems[key] = items[key];
                                        hasMatch = true;
                                    }
                                }
                                if(Object.keys(filteredItems).length > 0) {
                                    filteredSubCategories[subCategoryTitle] = filteredItems;
                                }
                            } else {
                                const normalizedSubCategoryTitle = removeAccents(subCategoryTitle.toLowerCase());
                                const normalizedItems = removeAccents(String(items).toLowerCase());
                                if (normalizedSubCategoryTitle.includes(searchTerm) || normalizedItems.includes(searchTerm)) {
                                    filteredSubCategories[subCategoryTitle] = items;
                                    hasMatch = true;
                                }
                            }
                        }
                        if (hasMatch) {
                            filteredData[mainCategory] = filteredSubCategories;
                        }
                    }
                    renderPareceres(filteredData);
                }

                searchInput.addEventListener('input', filterPareceres);
                categoryFilter.addEventListener('change', filterPareceres);
                
                populateParecerFilter();
                filterPareceres();
            }
            
            function initContadorModule(container) {
                // Destrói instâncias de gráficos anteriores para evitar erros de renderização
                if (counterChart) {
                    counterChart.destroy();
                    counterChart = null;
                }
                if (historyChart) {
                    historyChart.destroy();
                    historyChart = null;
                }

                 container.innerHTML = `
                    <div class="flex mb-4 border-b border-[var(--border-color)] flex-shrink-0">
                        <button class="tab-button py-2 px-4 font-semibold active" data-tab="contador-main">Contador</button>
                        <button class="tab-button py-2 px-4 font-semibold" data-tab="contador-history">Histórico</button>
                    </div>
                    <div id="contador-main-tab" class="contador-tab-content flex flex-col gap-8 h-full">
                        <div class="grid md:grid-cols-2 gap-8">
                            <div id="counters-grid" class="grid grid-cols-1 sm:grid-cols-2 grid-rows-2 gap-4 min-h-[320px]"></div>
                            <div class="flex flex-col gap-4 p-4 md:p-6 content-card h-full justify-center">
                                 <h3 class="text-sm text-[var(--text-secondary)] uppercase tracking-wide">Configurações</h3>
                                 <div class="flex items-center justify-between">
                                     <label for="timer-toggle" class="font-medium text-sm">Modo Timer (Valor em minutos)</label>
                                     <div class="toggle-switch">
                                         <input type="checkbox" id="timer-toggle" class="toggle-checkbox"/>
                                         <label for="timer-toggle" class="toggle-label"></label>
                                     </div>
                                 </div>
                                 <div class="flex flex-col gap-2">
                                     <label for="increment-by-input" class="text-sm font-medium">Incrementar por</label>
                                     <input type="number" id="increment-by-input" value="1" class="w-full bg-transparent p-3 form-input">
                                 </div>
                                 <div class="flex flex-col gap-2">
                                     <label for="counter-start-input" class="text-sm font-medium">Valor Inicial</label>
                                     <input type="number" id="counter-start-input" value="0" class="w-full bg-transparent p-3 form-input">
                                 </div>
                                  <div class="grid grid-cols-2 gap-4 mt-2">
                                     <button id="add-counter-btn" class="w-full p-3 secondary-btn text-xs flex items-center justify-center gap-2">
                                         <i data-lucide="plus-circle" class="w-4 h-4"></i> Adicionar
                                     </button>
                                      <button id="finalizar-dia-btn" class="w-full p-3 secondary-btn text-xs flex items-center justify-center gap-2">
                                         <i data-lucide="check-circle" class="w-4 h-4"></i> Finalizar Dia
                                     </button>
                                  </div>
                                  <button id="contador-reset" class="col-span-2 w-full p-3 secondary-btn text-xs flex items-center justify-center gap-2 text-red-500">
                                     <i data-lucide="trash-2" class="w-4 h-4"></i> Resetar Tudo
                                 </button>
                            </div>
                        </div>
                        <div class="p-4 content-card flex-1 flex flex-col min-h-[200px]">
                            <h3 class="text-sm text-[var(--text-secondary)] uppercase tracking-wide mb-4 flex-shrink-0">Atividade por Hora (Hoje)</h3>
                            <div class="relative flex-grow">
                                <canvas id="counter-chart"></canvas>
                            </div>
                        </div>
                         <div id="finalizar-dia-feedback" class="text-center p-4 content-card font-semibold hidden animate-fade-in"></div>
                    </div>
                    <div id="contador-history-tab" class="contador-tab-content hidden h-full">
                        <div class="flex flex-col h-full gap-4">
                            <div class="flex items-center justify-center gap-2 flex-wrap">
                                <button class="history-filter-btn p-2 px-4 rounded-xl secondary-btn text-sm font-semibold" data-period="week">Última Semana</button>
                                <button class="history-filter-btn p-2 px-4 rounded-xl secondary-btn text-sm font-semibold" data-period="month">Últimos 12 Meses</button>
                                <button class="history-filter-btn p-2 px-4 rounded-xl secondary-btn text-sm font-semibold" data-period="year">Últimos 10 Anos</button>
                            </div>
                            <div class="p-4 content-card flex-1 flex flex-col min-h-[300px]">
                                <h3 id="history-chart-title" class="text-sm text-[var(--text-secondary)] uppercase tracking-wide mb-4 flex-shrink-0 text-center"></h3>
                                <div class="relative flex-grow">
                                    <canvas id="history-chart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                const countersGrid = container.querySelector('#counters-grid');
                const addCounterBtn = container.querySelector('#add-counter-btn');
                const incrementInput = container.querySelector('#increment-by-input');
                const startInput = container.querySelector('#counter-start-input');
                const timerToggle = container.querySelector('#timer-toggle');
                const resetAllBtn = container.querySelector('#contador-reset');
                const finalizarDiaBtn = container.querySelector('#finalizar-dia-btn');
                const finalizarDiaFeedback = container.querySelector('#finalizar-dia-feedback');
                const counterTemplate = document.getElementById('counter-template');
                const tabButtons = container.querySelectorAll('.tab-button');
                const tabContents = container.querySelectorAll('.contador-tab-content');
                const historyFilterButtons = container.querySelectorAll('.history-filter-btn');
                const historyChartTitle = container.querySelector('#history-chart-title');

                // --- Lógica das abas do contador ---
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        tabButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        const targetTabId = `${button.dataset.tab}-tab`;
                        tabContents.forEach(content => {
                            content.classList.toggle('hidden', content.id !== targetTabId);
                        });
                        if (targetTabId === 'contador-history-tab') {
                            setTimeout(() => {
                                const activeFilter = container.querySelector('.history-filter-btn.active') || container.querySelector('.history-filter-btn[data-period="week"]');
                                if (activeFilter) activeFilter.click();
                            }, 50);
                        }
                    });
                });

                historyFilterButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        historyFilterButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        renderHistoryChart(button.dataset.period);
                    });
                });

                function saveCountersState() {
                    const state = counters.map(c => c.getState());
                    localStorage.setItem(COUNTERS_STATE_KEY, JSON.stringify(state));
                }

                function loadCountersState() {
                    const savedState = JSON.parse(localStorage.getItem(COUNTERS_STATE_KEY) || 'null');
                    countersGrid.innerHTML = '';
                    counters.forEach(c => c.destroy());
                    counters = [];
                    if (savedState && savedState.length > 0) {
                        savedState.forEach(createCounterInstance);
                    } else {
                        createCounterInstance({ id: Date.now(), title: "Contador Principal", isTimer: false, isStarred: true, value: 0 });
                    }
                    updateCountersLayout();
                }

                function updateCountersLayout() {
                    const count = counters.length;
                    const cards = countersGrid.querySelectorAll('.counter-card');
                    cards.forEach(card => card.classList.remove('sm:col-span-2', 'sm:row-span-2'));
                    if (count === 1) cards[0].classList.add('sm:col-span-2', 'sm:row-span-2');
                    else if (count === 2) cards.forEach(card => card.classList.add('sm:row-span-2'));
                    else if (count === 3) cards[2].classList.add('sm:col-span-2');
                }

                function saveActivityToHistory(type, count) {
                    const history = JSON.parse(localStorage.getItem(INCREMENT_HISTORY_KEY) || '[]');
                    history.push({ timestamp: new Date().toISOString(), type, count });
                    localStorage.setItem(INCREMENT_HISTORY_KEY, JSON.stringify(history));
                }

                function updateCounterChart() {
                    const chartCanvas = container.querySelector('#counter-chart');
                    if (!chartCanvas) return;
                    const ctx = chartCanvas.getContext('2d');
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const activityHistory = JSON.parse(localStorage.getItem(INCREMENT_HISTORY_KEY) || '[]');
                    const todaysActivities = activityHistory.map(item => ({ ...item, timestamp: new Date(item.timestamp) })).filter(item => item.timestamp >= today);
                    
                    const fixedLabels = Array.from({ length: 14 }, (_, i) => `${(i + 6).toString().padStart(2, '0')}:00`);
                    let data = Array(fixedLabels.length).fill(0);

                    todaysActivities.forEach(activity => {
                        const index = activity.timestamp.getHours() - 6;
                        if (index >= 0 && index < data.length) {
                             if (activity.type === 'add') {
                                data[index] += activity.count;
                            } else if (activity.type === 'subtract') {
                                data[index] -= activity.count;
                            }
                        }
                    });

                    const isDarkMode = document.documentElement.classList.contains('dark');
                    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    const textColor = isDarkMode ? '#d1d9e6' : '#5a6474';
                    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
                    if (counterChart) {
                        counterChart.data.labels = fixedLabels;
                        counterChart.data.datasets[0].data = data;
                        counterChart.options.scales.x.ticks.color = textColor;
                        counterChart.options.scales.y.ticks.color = textColor;
                        counterChart.options.scales.x.grid.color = gridColor;
                        counterChart.options.scales.y.grid.color = gridColor;
                        counterChart.update();
                    } else {
                        counterChart = new Chart(ctx, {
                            type: 'bar',
                            data: { labels: fixedLabels, datasets: [{ label: 'Atividades', data, backgroundColor: accentColor, borderRadius: 5 }] },
                            options: {
                                responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } },
                                scales: {
                                    y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1, callback: v => (Number.isInteger(v) ? v : null) }, grid: { color: gridColor } },
                                    x: { ticks: { color: textColor }, grid: { display: false } }
                                }
                            }
                        });
                    }
                }

                function createCounterInstance(initialState) {
                    const counterElement = counterTemplate.content.cloneNode(true).firstElementChild;
                    const { id, title, isTimer, isStarred } = initialState;
                    counterElement.dataset.id = id;
                    const titleElement = counterElement.querySelector('.counter-title');
                    const display = counterElement.querySelector('.counter-display');
                    const plusBtn = counterElement.querySelector('.counter-plus');
                    const minusBtn = counterElement.querySelector('.counter-minus');
                    const removeBtn = counterElement.querySelector('.remove-counter-btn');
                    const starBtn = counterElement.querySelector('.star-btn');
                    const playPauseBtn = counterElement.querySelector('.timer-play-pause');
                    const resetBtn = counterElement.querySelector('.timer-reset');
                    const playPauseIcon = playPauseBtn.querySelector('i');
                    let instanceState = { ...initialState };
                    let intervalId = null;
                    const formatTime = s => `${Math.floor(s / 60).toString().padStart(2, '0')}:${(s % 60).toString().padStart(2, '0')}`;
                    const updateDisplay = () => { display.textContent = instanceState.isTimer ? formatTime(instanceState.value) : instanceState.value; if (instanceState.isTimer) playPauseIcon.dataset.lucide = instanceState.isRunning ? 'pause' : 'play'; safeCreateIcons(); };
                    const stopTimer = () => { clearInterval(intervalId); intervalId = null; instanceState.isRunning = false; updateDisplay(); saveCountersState(); };
                    const startTimer = () => { if (intervalId || !instanceState.isTimer) return; instanceState.isRunning = true; intervalId = setInterval(() => { if (instanceState.value > 0) { instanceState.value--; updateDisplay(); saveCountersState(); } else { stopTimer(); } }, 1000); updateDisplay(); saveCountersState(); };
                    const removeInstance = () => {
                        stopTimer();
                        counterElement.classList.add('animate-fade-out');
                        counterElement.addEventListener('animationend', () => {
                            counterElement.remove();
                            counters = counters.filter(c => c.getState().id !== id);
                            updateCountersLayout();
                            saveCountersState();
                        }, { once: true });
                    };
                    titleElement.textContent = title;
                    starBtn.classList.toggle('active', isStarred);
                    if (isTimer) {
                        [plusBtn, minusBtn].forEach(b => b.classList.add('hidden'));
                        [playPauseBtn, resetBtn].forEach(b => b.classList.remove('hidden'));
                        display.contentEditable = true;
                        playPauseBtn.addEventListener('click', () => instanceState.isRunning ? stopTimer() : startTimer());
                        resetBtn.addEventListener('click', () => { stopTimer(); instanceState.value = instanceState.initialValue; updateDisplay(); saveCountersState(); });
                        display.addEventListener('blur', () => { const parts = display.textContent.split(':'); let s=0; if(parts.length===2){s=(parseInt(parts[0],10)||0)*60+(parseInt(parts[1],10)||0)}else if(parts.length===1){s=(parseInt(parts[0],10)||0)*60} instanceState.value=s; instanceState.initialValue=s; stopTimer(); updateDisplay(); saveCountersState(); });
                        if (instanceState.isRunning) { instanceState.isRunning = false; startTimer(); }
                    } else {
                        plusBtn.addEventListener('click', () => { const c = parseInt(incrementInput.value) || 1; instanceState.value += c; updateDisplay(); if(instanceState.isStarred){ saveActivityToHistory('add', c); updateCounterChart(); } saveCountersState(); });
                        minusBtn.addEventListener('click', () => { const c = parseInt(incrementInput.value) || 1; const o=instanceState.value; const n=Math.max(0,o-c); const a=o-n; instanceState.value=n; updateDisplay(); if(instanceState.isStarred&&a>0){ saveActivityToHistory('subtract',a); updateCounterChart(); } saveCountersState(); });
                    }
                    starBtn.addEventListener('click', () => { instanceState.isStarred = !instanceState.isStarred; starBtn.classList.toggle('active', instanceState.isStarred); saveCountersState(); });
                    titleElement.addEventListener('blur', () => { instanceState.title = titleElement.textContent; saveCountersState(); });
                    removeBtn.addEventListener('click', removeInstance);
                    counters.push({ id, element: counterElement, destroy: stopTimer, getState: () => instanceState });
                    countersGrid.appendChild(counterElement);
                    updateDisplay();
                    counterElement.classList.add('animate-fade-in');
                }

                addCounterBtn.addEventListener('click', () => {
                    if (counters.length >= 4) return;
                    const isTimer = timerToggle.checked;
                    const initialValue = parseInt(startInput.value) || 0;
                    const newState = { id: Date.now(), title: `${isTimer ? 'Timer' : 'Contador'} ${counters.length + 1}`, isTimer, isStarred: false, isRunning: false, value: isTimer ? initialValue * 60 : initialValue, initialValue: isTimer ? initialValue * 60 : undefined };
                    createCounterInstance(newState);
                    updateCountersLayout();
                    saveCountersState();
                });

                finalizarDiaBtn.addEventListener('click', () => {
                    const totalDoDia = counters.filter(c=>c.getState().isStarred&&!c.getState().isTimer).reduce((s,c)=>s+c.getState().value,0);
                    if(totalDoDia<=0){finalizarDiaFeedback.textContent="Nenhuma contagem (com estrela) para salvar.";finalizarDiaFeedback.className="text-center p-4 content-card font-semibold animate-fade-in text-yellow-500";setTimeout(()=>finalizarDiaFeedback.classList.add('hidden'),3e3);return}
                    const history = JSON.parse(localStorage.getItem(DAILY_HISTORY_KEY) || '[]');
                    const today = new Date().toISOString().slice(0, 10);
                    const todayEntryIndex = history.findIndex(e => e.date === today);
                    if (todayEntryIndex > -1) history[todayEntryIndex].count += totalDoDia; else history.push({ date: today, count: totalDoDia });
                    localStorage.setItem(DAILY_HISTORY_KEY, JSON.stringify(history));
                    localStorage.removeItem(INCREMENT_HISTORY_KEY);
                    finalizarDiaFeedback.textContent=`Total de ${totalDoDia} salvo! Contadores resetados.`;
                    finalizarDiaFeedback.className="text-center p-4 content-card font-semibold animate-fade-in text-green-500";
                    setTimeout(()=>finalizarDiaFeedback.classList.add('hidden'),4e3);
                    loadCountersState();
                    updateCounterChart();
                });

                resetAllBtn.addEventListener('click', () => {
                    if (confirm("Resetar tudo? ISSO APAGARÁ TODOS OS CONTADORES E O HISTÓRICO PERMANENTEMENTE.")) {
                        countersGrid.innerHTML = ''; counters.forEach(c => c.destroy()); counters = [];
                        [DAILY_HISTORY_KEY, COUNTERS_STATE_KEY, INCREMENT_HISTORY_KEY].forEach(k => localStorage.removeItem(k));
                        if (counterChart) { counterChart.destroy(); counterChart = null; }
                        if (historyChart) { historyChart.destroy(); historyChart = null; }
                        loadCountersState();
                        updateCounterChart();
                    }
                });
                
                function getHistoryChartData(period) {
                    const history = JSON.parse(localStorage.getItem(DAILY_HISTORY_KEY) || '[]');
                    const now = new Date();
                    if (period === 'week') {
                        const labels = []; const data = Array(7).fill(0); const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
                        for (let i = 6; i >= 0; i--) { const d = new Date(); d.setDate(now.getDate() - i); labels.push(dayNames[d.getDay()]); const dateString = d.toISOString().slice(0, 10); const dayEntry = history.find(entry => entry.date === dateString); if (dayEntry) data[6 - i] = dayEntry.count; }
                        return { labels, data, title: 'Contagem Finalizada na Última Semana' };
                    }
                    if (period === 'month') {
                        const labels = []; const data = Array(12).fill(0); const monthNames = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
                        for (let i = 11; i >= 0; i--) { const d = new Date(now.getFullYear(), now.getMonth() - i, 1); labels.push(`${monthNames[d.getMonth()]}/${d.getFullYear().toString().slice(-2)}`); const monthEntries = history.filter(e => e.date.startsWith(`${d.getFullYear()}-${(d.getMonth()+1).toString().padStart(2,'0')}`)); data[11-i] = monthEntries.reduce((s,e)=>s+e.count,0); }
                        return { labels, data, title: 'Contagem Finalizada nos Últimos 12 Meses' };
                    }
                    if (period === 'year') {
                        const labels = []; const data = Array(10).fill(0); const currentYear = now.getFullYear();
                        for (let i = 9; i >= 0; i--) { const year = currentYear - i; labels.push(year.toString()); const yearEntries = history.filter(e => e.date.startsWith(year.toString())); data[9-i] = yearEntries.reduce((s,e)=>s+e.count,0); }
                        return { labels, data, title: 'Contagem Finalizada nos Últimos 10 Anos' };
                    }
                    return { labels: [], data: [], title: '' };
                }

                function renderHistoryChart(period) {
                    const chartCanvas = container.querySelector('#history-chart');
                    if (!chartCanvas) return;
                    const ctx = chartCanvas.getContext('2d');
                    const chartData = getHistoryChartData(period);
                    if (!chartData) return;
                    const { labels, data, title } = chartData;
                    historyChartTitle.textContent = title;
                    const isDarkMode = document.documentElement.classList.contains('dark');
                    const gridColor = isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
                    const textColor = isDarkMode ? '#d1d9e6' : '#5a6474';
                    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
                    if (historyChart) {
                        historyChart.data.labels = labels; historyChart.data.datasets[0].data = data;
                        Object.assign(historyChart.options.scales.x.ticks, { color: textColor });
                        Object.assign(historyChart.options.scales.y.ticks, { color: textColor });
                        Object.assign(historyChart.options.scales.x.grid, { color: gridColor });
                        Object.assign(historyChart.options.scales.y.grid, { color: gridColor });
                        historyChart.update();
                    } else {
                        historyChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Adições', data, backgroundColor: accentColor, borderRadius: 5 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { color: textColor, stepSize: 1, callback: v => (Number.isInteger(v) ? v : null) }, grid: { color: gridColor } }, x: { ticks: { color: textColor }, grid: { display: false } } } } });
                    }
                }

                loadCountersState();
                updateCounterChart();
            }
            
            function initChecklistModule(container) {
                container.innerHTML = `
                    <div id="checklist-flows-view"></div>
                    <div id="checklist-documents-view" class="hidden"></div>
                    <div id="checklist-items-view" class="hidden"></div>
                `;

                const flowsView = container.querySelector('#checklist-flows-view');

                function updateCheckboxVisual(checkbox) {
                    if (!checkbox) return;
                    const label = checkbox.closest('label');
                    if (!label) return;
                    const customCheckbox = label.querySelector('.custom-checkbox');
                    const icon = label.querySelector('.check-icon');

                    if (checkbox.checked) {
                        customCheckbox.classList.add('bg-sky-500', 'border-sky-500');
                        icon.style.opacity = '1';
                    } else {
                        customCheckbox.classList.remove('bg-sky-500', 'border-sky-500');
                        icon.style.opacity = '0';
                    }
                }
                
                function handleChecklistChange(e) {
                    const checkbox = e.target.closest('.checklist-item-checkbox');
                    if (checkbox) {
                        const { flow, doc, itemKey } = checkbox.dataset;
                        if (flow && doc && itemKey) {
                            checklistState[flow] = checklistState[flow] || {};
                            checklistState[flow][doc] = checklistState[flow][doc] || {};
                            checklistState[flow][doc][itemKey] = checkbox.checked;
                            localStorage.setItem('apoioBpoChecklistState', JSON.stringify(checklistState));
                        }
                    }
                }

                function handleChecklistNavigation(e) {
                    const target = e.target;
                    const flowBtn = target.closest('.checklist-flow-btn');
                    if (flowBtn) { showDocumentsView(flowBtn.dataset.flow); return; }

                    const docBtn = target.closest('.checklist-doc-btn');
                    if (docBtn) { showChecklistItemsView(docBtn.dataset.flow, docBtn.dataset.doc); return; }

                    const backBtn = target.closest('.checklist-back-btn');
                    if (backBtn) {
                        if (backBtn.dataset.target === 'flows') showFlowsView();
                        else if (backBtn.dataset.target === 'documents') showDocumentsView(backBtn.dataset.flow);
                        return;
                    }

                    const finishBtn = target.closest('.checklist-finish-btn');
                    if (finishBtn) {
                        const allChecklistItems = Object.entries(checklistData.flows[currentFlow].documents[currentDoc].checklist || {});
                        const devolucoes = [];

                        allChecklistItems.forEach(([itemKey, parecerKey]) => {
                            if (!checklistState[currentFlow]?.[currentDoc]?.[itemKey]) {
                                const parecerText = findParecerText(parecerKey);
                                devolucoes.push(`${parecerKey}: ${parecerText || 'Parecer não encontrado.'}`);
                            }
                        });

                        let parecerTextForCopy = devolucoes.length === 0 ? "APROVAR" : devolucoes.join(' ');
                        let resultHTML = `
                            <div class="flex flex-col h-full text-white">
                                <h4 class="text-lg font-semibold mb-4 text-slate-300">Resultado do Checklist</h4>
                                <div class="flex-grow p-4 bg-slate-900 rounded-lg overflow-y-auto custom-scrollbar">
                                    <p class="whitespace-pre-wrap break-words ${devolucoes.length === 0 ? 'text-green-400' : 'text-red-400'} font-medium">${parecerTextForCopy}</p>
                                </div>
                                <div class="mt-auto pt-6 flex flex-col gap-4">
                                    <button class="checklist-copy-result-btn w-full p-3 bg-sky-600 hover:bg-sky-500 rounded-lg flex items-center justify-center gap-2" data-text-to-copy="${encodeURIComponent(parecerTextForCopy)}">
                                        <i data-lucide="copy" class="w-5 h-5"></i> Copiar Parecer
                                    </button>
                                    <button class="checklist-back-to-items w-full p-3 bg-slate-700 hover:bg-slate-600 rounded-lg flex items-center justify-center gap-2" data-flow="${currentFlow}" data-doc="${currentDoc}">
                                        <i data-lucide="arrow-left-circle" class="w-5 h-5"></i> Voltar
                                    </button>
                                </div>
                            </div>`;
                        
                        container.querySelector('#checklist-items-container').innerHTML = resultHTML;
                        safeCreateIcons();
                        return;
                    }
                    
                    const copyResultBtn = target.closest('.checklist-copy-result-btn');
                    if(copyResultBtn) {
                         copyText(decodeURIComponent(copyResultBtn.dataset.textToCopy), copyResultBtn);
                         return;
                    }

                    const backToItemsBtn = target.closest('.checklist-back-to-items');
                    if (backToItemsBtn) {
                        showChecklistItemsView(backToItemsBtn.dataset.flow, backToItemsBtn.dataset.doc);
                        return;
                    }
                }
                
                let currentFlow, currentDoc;

                function showFlowsView() {
                    container.querySelector('#checklist-flows-view').classList.remove('hidden');
                    container.querySelector('#checklist-documents-view').classList.add('hidden');
                    container.querySelector('#checklist-items-view').classList.add('hidden');
                    moduleTitle.textContent = "Checklist";

                    let html = '<div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">';
                    for (const flowKey in checklistData.flows) {
                        const flow = checklistData.flows[flowKey];
                        html += `
                            <button class="checklist-flow-btn flex flex-col items-center justify-center text-center gap-2 p-3 secondary-btn aspect-square" data-flow="${flowKey}">
                                <span class="text-4xl">${flow.icon}</span>
                                <span class="font-semibold">${flow.name}</span>
                            </button>`;
                    }
                    html += '</div>';
                    flowsView.innerHTML = html;
                }

                function showDocumentsView(flowKey) {
                    currentFlow = flowKey;
                    container.querySelector('#checklist-flows-view').classList.add('hidden');
                    container.querySelector('#checklist-documents-view').classList.remove('hidden');
                    container.querySelector('#checklist-items-view').classList.add('hidden');
                    
                    const documentsView = container.querySelector('#checklist-documents-view');
                    const flow = checklistData.flows[flowKey];
                    moduleTitle.textContent = flow.name;
                    
                    documentsView.innerHTML = `
                        <div class="flex items-center justify-start gap-4 mb-4">
                            <button class="checklist-back-btn p-3 secondary-btn rounded-full" data-target="flows"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                        </div>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 overflow-y-auto custom-scrollbar" style="max-height: 60vh;">
                            ${Object.keys(flow.documents).map(docKey => {
                                const doc = flow.documents[docKey];
                                return `
                                    <button class="checklist-doc-btn flex flex-col items-center justify-center text-center gap-2 p-3 secondary-btn aspect-square" data-flow="${flowKey}" data-doc="${docKey}">
                                        <span class="text-3xl">${doc.icon}</span>
                                        <span class="text-xs font-medium">${doc.name}</span>
                                    </button>`;
                            }).join('')}
                        </div>`;
                    safeCreateIcons();
                }

                function showChecklistItemsView(flowKey, docKey) {
                    currentFlow = flowKey;
                    currentDoc = docKey;
                    container.querySelector('#checklist-flows-view').classList.add('hidden');
                    container.querySelector('#checklist-documents-view').classList.add('hidden');
                    const itemsView = container.querySelector('#checklist-items-view');
                    itemsView.classList.remove('hidden');

                    const doc = checklistData.flows[flowKey].documents[docKey];
                    const checklistItems = Object.entries(doc.checklist || {});
                    moduleTitle.textContent = doc.name;

                    let imageViewerHtml = '';

                    if (doc.imageUrls && Array.isArray(doc.imageUrls) && doc.imageUrls.length > 0) {
                        imageViewerHtml = `
                            <div id="image-carousel" class="relative w-full h-full overflow-hidden rounded-lg">
                                <div id="carousel-inner" class="flex transition-transform duration-300 ease-in-out h-full bg-white">
                                    ${doc.imageUrls.map(url => `
                                        <img src="${url}" alt="${doc.name}" class="w-full h-full object-contain flex-shrink-0 cursor-zoom-in">
                                    `).join('')}
                                </div>
                                ${doc.imageUrls.length > 1 ? `
                                <button id="prev-btn" class="absolute top-1/2 left-2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full hover:bg-black/50 transition-colors"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>
                                <button id="next-btn" class="absolute top-1/2 right-2 -translate-y-1/2 bg-black/30 text-white p-2 rounded-full hover:bg-black/50 transition-colors"><i data-lucide="chevron-right" class="w-6 h-6"></i></button>
                                <div id="carousel-dots" class="absolute bottom-4 left-1/2 -translate-x-1/2 flex space-x-2">
                                    ${doc.imageUrls.map((_, i) => `<div class="carousel-dot h-2 w-2 rounded-full bg-white/50 transition-colors" data-index="${i}"></div>`).join('')}
                                </div>
                                ` : ''}
                            </div>
                        `;
                    } else if (doc.imageUrl) {
                        imageViewerHtml = `
                            <div class="bg-white rounded-lg shadow-2xl w-full h-full p-2 overflow-y-auto custom-scrollbar">
                                <img src="${doc.imageUrl}" alt="${doc.name}" class="w-full h-auto rounded-md cursor-zoom-in">
                            </div>
                        `;
                    } else {
                        imageViewerHtml = `
                            <div class="flex items-center justify-center h-full text-center text-[var(--text-secondary)]">
                                <p>Nenhuma imagem de exemplo<br>disponível para este documento.</p>
                            </div>
                        `;
                    }


                    itemsView.innerHTML = `
                        <div class="animate-fade-in">
                            <div class="flex items-center flex-shrink-0 mb-6">
                                <button class="checklist-back-btn p-3 secondary-btn rounded-full" data-target="documents" data-flow="${flowKey}"><i data-lucide="arrow-left" class="w-5 h-5"></i></button>
                            </div>
                            
                            <div id="checklist-main-layout" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                <!-- Coluna Esquerda: Visualizador de Documento -->
                                <div class="bg-gray-200 dark:bg-gray-900/50 p-4 sm:p-6 rounded-2xl flex items-center justify-center aspect-[3/4] lg:aspect-auto">
                                    ${imageViewerHtml}
                                </div>

                                <!-- Coluna Direita: Painel do Checklist -->
                                <div id="checklist-items-container" class="bg-[#1e293b] dark:bg-[#1e293b] text-white rounded-2xl p-6 sm:p-8 flex flex-col min-h-[75vh]">
                                    <ul class="space-y-5 flex-grow overflow-y-auto custom-scrollbar pr-2">
                                    ${checklistItems.map(([itemKey, parecerKey]) => {
                                        const isChecked = checklistState[flowKey]?.[docKey]?.[itemKey] || false;
                                        const uniqueId = `check-${flowKey}-${docKey}-${itemKey.replace(/[^a-zA-Z0-9]/g, '-')}`;
                                        return `
                                            <li>
                                                <label for="${uniqueId}" class="flex items-center gap-4 cursor-pointer group">
                                                    <input type="checkbox" id="${uniqueId}" class="checklist-item-checkbox hidden" data-item-key="${itemKey}" data-flow="${flowKey}" data-doc="${docKey}" ${isChecked ? 'checked' : ''}>
                                                    <span class="custom-checkbox w-5 h-5 rounded border-2 border-slate-500 group-hover:border-slate-400 flex items-center justify-center flex-shrink-0 transition-colors">
                                                        <i data-lucide="check" class="check-icon w-3 h-3 text-white opacity-0 transition-opacity"></i>
                                                    </span>
                                                    <span class="font-medium text-slate-300 group-hover:text-white transition-colors">${itemKey}</span>
                                                </label>
                                            </li>`;
                                    }).join('')}
                                    </ul>
                                    <div class="mt-auto pt-6">
                                        <button class="checklist-finish-btn w-full p-4 bg-slate-700 hover:bg-slate-600 rounded-lg font-semibold tracking-wide transition-all active:scale-95">Finalizar</button>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                    
                    itemsView.querySelectorAll('.checklist-item-checkbox').forEach(checkbox => {
                        updateCheckboxVisual(checkbox);
                    });

                    // Lógica do Carrossel
                    const carouselInner = itemsView.querySelector('#carousel-inner');
                    if (carouselInner) {
                        const prevBtn = itemsView.querySelector('#prev-btn');
                        const nextBtn = itemsView.querySelector('#next-btn');
                        const dots = itemsView.querySelectorAll('.carousel-dot');
                        const totalSlides = doc.imageUrls.length;
                        let currentIndex = 0;

                        const showSlide = (index) => {
                            if (!carouselInner) return;
                            carouselInner.style.transform = `translateX(-${index * 100}%)`;
                            dots.forEach((dot, i) => {
                                dot.classList.toggle('bg-white', i === index);
                                dot.classList.toggle('bg-white/50', i !== index);
                            });
                            currentIndex = index;
                        };

                        if (prevBtn) {
                            prevBtn.addEventListener('click', () => {
                                const newIndex = (currentIndex - 1 + totalSlides) % totalSlides;
                                showSlide(newIndex);
                            });
                        }

                        if (nextBtn) {
                            nextBtn.addEventListener('click', () => {
                                const newIndex = (currentIndex + 1) % totalSlides;
                                showSlide(newIndex);
                            });
                        }
                        
                        dots.forEach(dot => {
                            dot.addEventListener('click', () => {
                                showSlide(parseInt(dot.dataset.index));
                            });
                        });

                        if (totalSlides > 0) {
                            showSlide(0);
                        }
                    }

                    safeCreateIcons();
                }
                
                if (typeof checklistData === 'undefined') {
                    flowsView.innerHTML = `<div class="text-center text-lg py-8 text-[var(--text-secondary)]">Dados de checklist não carregados.</div>`;
                    return;
                }
                
                container.addEventListener('click', handleChecklistNavigation);
                container.addEventListener('change', (e) => {
                    handleChecklistChange(e);
                    const checkbox = e.target.closest('.checklist-item-checkbox');
                    if(checkbox) {
                       updateCheckboxVisual(checkbox);
                    }
                });
                
                showFlowsView();
            }

            // --- GERENCIAMENTO DE MODAIS ---
            function setupModals() {
                const infoButton = document.getElementById('info-button');
                const infoModal = document.getElementById('info-modal');
                const infoModalOverlay = document.getElementById('info-modal-overlay');
                const infoModalClose = document.getElementById('info-modal-close');

                function openInfoModal() {
                    if (infoModal) {
                        infoModal.classList.remove('hidden');
                        mainContent.classList.add('blurred');
                        safeCreateIcons();
                    }
                }

                function closeInfoModal() {
                    if (infoModal) {
                        infoModal.classList.add('hidden');
                        mainContent.classList.remove('blurred');
                    }
                }

                if (infoButton && infoModal && infoModalOverlay && infoModalClose) {
                    infoButton.addEventListener('click', openInfoModal);
                    infoModalOverlay.addEventListener('click', closeInfoModal);
                    infoModalClose.addEventListener('click', closeInfoModal);
                }
            }

            // --- CONFIGURAÇÃO DE EVENT LISTENERS GERAIS ---
            function setupEventListeners() {
                document.getElementById('theme-toggle').addEventListener('click', () => updateTheme(!document.documentElement.classList.contains('dark')));
                dockButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        dockButtons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        switchModule(button.dataset.target, button.dataset.title);
                    });
                });
                setupModals();
            }

            // --- VERIFICAÇÃO INICIAL (MODAL DE TERMOS) ---
            const termsModal = document.getElementById('terms-modal');
            if (localStorage.getItem(TERMS_KEY) === 'true') {
                initializeApp();
                setupDockToggling();
            } else {
                const acceptTermsBtn = document.getElementById('accept-terms-btn');
                const termsCheckbox = document.getElementById('terms-checkbox');
                termsModal.classList.remove('hidden');
                mainContent.classList.add('blurred');
                safeCreateIcons();
                
                termsCheckbox.addEventListener('change', () => { acceptTermsBtn.disabled = !termsCheckbox.checked; });
                
                acceptTermsBtn.addEventListener('click', () => {
                    if (!termsCheckbox.checked) return;
                    localStorage.setItem(TERMS_KEY, 'true');
                    
                    termsModal.classList.add('animate-fade-out');
                    termsModal.addEventListener('animationend', () => {
                         termsModal.classList.add('hidden');
                         mainContent.classList.remove('blurred');
                    }, { once: true });

                    initializeApp();
                    setupDockToggling();
                }, { once: true });
            }
        };
    </script>
</body>
</html>